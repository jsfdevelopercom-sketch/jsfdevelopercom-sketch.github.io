<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>APACHE II Bedside Entry</title>

<!--
  PERFORMANCE NOTES (client-side):
  1) Preconnect to Apps Script origin to reduce DNS + TLS handshake time.
  2) Debounce compute/validation to avoid expensive work on every keystroke.
  3) Cache computed APACHE result for identical inputs.
  4) Keep payload-building ONLY for submit/preview (not for every input event).
  5) Use keepalive fetch so the POST isn‚Äôt canceled by a navigation/back gesture.

  SYNC HARDENING (backend compatibility):
  - For GET endpoints we send BOTH auth + authToken (covers script variants).
  - LIST endpoint supports action=list OR tag=LIST (we send both).
  - SUBMIT success accepts ok:true OR success:true.
  - LIST response accepts:
      { ok:true, patients:[{uhid,name}...] }
      { ok:true, patients:[[uhid,name]...] }
      { ok:true, rows:[[uhid,name]...] }
      { ok:true, data:{patients:[...] } }
  - CHECK response detects duplicates from multiple shapes.
-->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    color-scheme: light;
    --surface: rgba(255,255,255,0.9);
    --surface-strong: rgba(255,255,255,0.98);
    --outline: rgba(148,163,184,0.4);
    --muted:#475569; --text:#0f172a;
    --accent:#2563eb; --accent-dark:#1d4ed8;
    --bg-gradient:
      radial-gradient(circle at 5% 0%, rgba(59,130,246,.22), transparent 45%),
      radial-gradient(circle at 95% 0%, rgba(14,165,233,.18), transparent 40%),
      linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 55%,#f8fafc 100%);
    --shadow: 0 30px 60px -25px rgba(15,23,42,.35);
    --shadow-soft: 0 20px 50px -30px rgba(15,23,42,.35);
    --radius-lg: 26px; --radius-md:18px; --radius-sm:12px;
    --max-width:1260px;
    font-synthesis:none; text-rendering:optimizeLegibility;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--text);background:var(--bg-gradient);display:flex;flex-direction:column}
  a{color:inherit}

  .masthead{position:relative;padding:clamp(24px,5vw,42px) clamp(18px,7vw,64px) clamp(28px,6vw,52px);display:flex;flex-direction:column;gap:clamp(18px,4vw,36px);overflow:hidden}
  .masthead::before{content:"";position:absolute;inset:12% auto -20% 50%;width:clamp(240px,40vw,520px);height:clamp(240px,45vw,560px);background:radial-gradient(circle, rgba(37,99,235,.45), transparent 70%);transform:translateX(-50%) rotate(18deg);filter:blur(42px);opacity:.6}
  .masthead__inner{position:relative;z-index:1;max-width:var(--max-width);margin:0 auto;display:flex;flex-direction:column;gap:clamp(18px,4vw,36px)}
  .topline{display:flex;align-items:center;justify-content:space-between;gap:18px}
  .brand{display:flex;align-items:center;gap:16px}
  .brand__mark{width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.7));display:grid;place-items:center;color:#fff;font-family:"Plus Jakarta Sans","Inter",sans-serif;font-weight:700;font-size:20px;letter-spacing:.04em;box-shadow:var(--shadow-soft)}
  .brand__copy h1{margin:0;font-family:"Plus Jakarta Sans","Inter",sans-serif;font-size:clamp(30px,5vw,44px);font-weight:700;letter-spacing:-.02em}
  .brand__copy p{margin:6px 0 0;max-width:520px;color:var(--muted);font-size:clamp(15px,2.5vw,18px);line-height:1.6}
  .dev-bubble{width:42px;height:42px;border-radius:50%;border:1px solid rgba(255,255,255,.7);background:rgba(15,23,42,.75);color:#e2e8f0;display:grid;place-items:center;cursor:pointer;box-shadow:0 16px 40px -20px rgba(15,23,42,.65);backdrop-filter:blur(12px);transition:transform .2s ease}
  .dev-bubble:hover{transform:translateY(-2px)}

  .mode-switcher{display:grid;gap:10px;align-items:start}
  .mode-pills{display:grid;grid-template-columns:1fr;gap:12px}
  .mode{position:relative;border-radius:var(--radius-md);border:1px solid transparent;padding:14px 18px;background:rgba(255,255,255,.65);color:var(--muted);font-weight:600;text-align:left;cursor:default}
  .mode.active{background:linear-gradient(135deg,#2563eb,#14a3e9);color:#fff;box-shadow:0 18px 42px -18px rgba(37,99,235,.6)}
  .mode-hint{font-size:14px;color:var(--muted)}

  .patient-mini{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--muted)}
  .mini-field{display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:rgba(255,255,255,.75);box-shadow:0 12px 28px -22px rgba(15,23,42,.45)}
  .mini-field span{font-size:16px}
  .mini-field input{border:0;background:transparent;font-size:14px;outline:none;min-width:110px}

  .workspace-wrapper{flex:1;padding:0 clamp(18px,7vw,64px) clamp(180px,12vw,220px)}
  .workspace{position:relative;z-index:1;max-width:var(--max-width);margin:0 auto;display:grid;gap:clamp(20px,4vw,36px)}
  .cards-flow{display:grid;gap:clamp(18px,3vw,28px)}
  .panel{background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--outline);padding:clamp(18px,3vw,28px);box-shadow:var(--shadow-soft);backdrop-filter:blur(14px);display:grid;gap:clamp(16px,2.5vw,26px)}
  .panel header{display:grid;gap:6px}
  .panel h2{margin:0;font-size:clamp(18px,2.7vw,22px);font-weight:700;letter-spacing:-.01em}
  .panel .hint{margin:0;color:var(--muted);font-size:13px;line-height:1.5}

  label{font-weight:600;font-size:14px;color:#1e293b;display:block;margin-bottom:6px}
  .input,select,textarea{width:100%;padding:12px 14px;border-radius:var(--radius-sm);border:1px solid rgba(148,163,184,.5);background:rgba(248,250,252,.92);font-size:15px;transition:border .2s ease,box-shadow .2s ease,background .2s ease}
  .input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.15);background:#fff}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

  .grid-2,.grid-3{display:grid;gap:18px}
  .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .grid-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

  .chip-row{display:flex;flex-wrap:wrap;gap:12px}
  .chip{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--radius-md);background:rgba(148,163,184,.14);border:1px solid transparent;font-weight:600;cursor:pointer;color:var(--muted);transition:all .2s ease}
  .chip input[type=radio]{accent-color:var(--accent)}
  .chip:hover{background:rgba(37,99,235,.1)}

  .tab-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:4px}
  .tab{border:1px solid rgba(148,163,184,.4);background:rgba(255,255,255,.7);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
  .tab.active{background:linear-gradient(135deg,#2563eb,#14a3e9);color:#fff;border-color:transparent}
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .action-dock{
    position:static;
    padding:18px clamp(18px,7vw,64px) max(env(safe-area-inset-bottom,24px),28px);
    background:rgba(255,255,255,.96);
    border-top:1px solid rgba(148,163,184,.35);
    box-shadow:0 -18px 42px -24px rgba(15,23,42,.45);
    backdrop-filter:blur(16px);
    z-index:150
  }
  .action-dock__inner{max-width:var(--max-width);margin:0 auto;display:grid;gap:12px}
  .btn{border-radius:var(--radius-md);border:1px solid transparent;padding:16px;font-weight:600;font-size:16px;cursor:pointer;transition:transform .18s ease,box-shadow .18s ease,background .18s ease}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#1e40af);color:#fff;box-shadow:0 20px 40px -18px rgba(37,99,235,.55)}
  .btn.primary:hover:not([disabled]){transform:translateY(-1px)}
  .btn.secondary{background:rgba(37,99,235,.08);color:var(--accent-dark);border:1px solid rgba(37,99,235,.18)}
  .btn.ghost{background:transparent;border:1px solid rgba(148,163,184,.35);color:var(--muted)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .incomplete-note{display:none;font-size:12px;color:#dc2626;font-weight:700}
  .incomplete-note[data-visible="true"]{display:block}

  .toast{position:fixed;right:clamp(18px,5vw,64px);bottom:clamp(120px,12vw,180px);min-width:min(360px,calc(100vw - 48px));background:#fff;border-radius:var(--radius-md);border-left:4px solid #16a34a;padding:16px 20px;box-shadow:var(--shadow);font-weight:600;color:var(--text);display:none;z-index:220}
  .toast.err{border-left-color:#dc2626;color:#dc2626}
  .toast.warn{border-left-color:#f59e0b;color:#92400e}
  .toast.center{left:50%;top:50%;transform:translate(-50%,-50%);right:auto;bottom:auto;min-width:min(460px,calc(100vw - 48px));text-align:center}

  .admin-panel,.admin-backdrop{position:fixed;inset:0;z-index:235}
  .admin-backdrop{background:rgba(15,23,42,.5);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .25s ease}
  .admin-backdrop[data-visible="true"]{opacity:1;pointer-events:auto}
  .admin-panel{display:grid;place-items:center;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .25s ease,visibility .25s ease}
  .admin-panel[aria-hidden="false"]{opacity:1;visibility:visible;pointer-events:auto}

  .admin-sheet{
    width:min(720px,calc(100vw - 28px));
    background:#0f172a;color:#f8fafc;border-radius:var(--radius-lg);
    border:1px solid rgba(148,163,184,.35);box-shadow:0 30px 80px -30px rgba(15,23,42,.8);
    padding:18px;display:grid;gap:14px;pointer-events:auto;
    max-height:min(84vh, 760px);
    overflow:hidden;
  }
  .admin-top{
    display:flex;justify-content:space-between;align-items:center;gap:12px;
    padding:6px 6px 0 6px;
  }
  .admin-title-wrap{display:grid;gap:2px}
  .admin-title{margin:0;font-size:18px;font-weight:700}
  .admin-sub{margin:0;font-size:12px;color:rgba(226,232,240,.72);line-height:1.35}
  .admin-close{
    border:0;background:rgba(148,163,184,.15);color:#e2e8f0;border-radius:999px;
    padding:8px 14px;cursor:pointer;font-weight:700
  }
  .admin-body{
    display:grid;gap:12px;
    overflow:auto;
    padding:0 6px 6px 6px;
  }
  .admin-card{
    border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.35);
    border-radius:18px;
    padding:12px;
    display:grid;
    gap:10px;
  }
  .admin-card h4{margin:0;font-size:14px;font-weight:800}
  .admin-card .minihelp{margin:0;color:rgba(226,232,240,.70);font-size:12px;line-height:1.4}

  .table-wrap{
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background:rgba(2,6,23,.35);
    overflow:auto;
    max-height:320px;
  }
  table.admin-table{
    border-collapse:collapse;
    width:max(520px,100%);
    font-size:13px;
  }
  table.admin-table th, table.admin-table td{
    padding:10px 10px;
    border-bottom:1px solid rgba(148,163,184,.16);
    white-space:nowrap;
    text-align:left;
    vertical-align:top;
  }
  table.admin-table th{
    position:sticky;top:0;z-index:2;
    background:rgba(15,23,42,.92);
    color:#e2e8f0;
    font-weight:800;
  }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(148,163,184,.10);
    font-weight:700;
    color:#e2e8f0;
    font-size:12px;
  }
  .admin-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .admin-inputs{display:grid;grid-template-columns:1fr 120px auto;gap:10px;align-items:end}
  @media (max-width:520px){
    .admin-inputs{grid-template-columns:1fr;align-items:stretch}
  }

  .admin-sheet label{color:#cbd5f5}
  .admin-sheet .input{background:rgba(15,23,42,.75);color:#f8fafc;border:1px solid rgba(148,163,184,.4)}
  .admin-sheet select.input{appearance:none}
  .admin-sheet .btn{padding:12px 14px;font-size:14px}
  .admin-sheet .btn.primary{box-shadow:none}
  .admin-sheet .btn.ghost{color:#e2e8f0;border-color:rgba(148,163,184,.28)}
  .admin-sheet .btn.secondary{color:#e2e8f0;background:rgba(37,99,235,.16);border-color:rgba(37,99,235,.22)}

  .dev-entry{
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding-top:10px;
    border-top:1px solid rgba(148,163,184,.22);
  }
  .dev-entry .dev-cta{
    display:flex;align-items:center;gap:10px;
    padding:10px 14px;border-radius:14px;
    background:linear-gradient(135deg, rgba(37,99,235,.28), rgba(14,165,233,.18));
    border:1px solid rgba(148,163,184,.22);
    cursor:pointer;
    user-select:none;
    font-weight:800;
  }
  .dev-entry .dev-cta small{display:block;font-weight:700;color:rgba(226,232,240,.72)}
  .dev-entry .dev-ico{
    width:40px;height:40px;border-radius:14px;
    display:grid;place-items:center;
    background:rgba(15,23,42,.85);
    border:1px solid rgba(148,163,184,.22);
  }
  .danger-note{
    font-size:12px;color:rgba(248,250,252,.72);line-height:1.4
  }

  .dev-panel,.dev-backdrop{position:fixed;inset:0;z-index:230}
  .dev-backdrop{background:rgba(15,23,42,.5);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .25s ease}
  .dev-backdrop[data-visible="true"]{opacity:1;pointer-events:auto}
  .dev-panel{display:grid;place-items:center;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .25s ease,visibility .25s ease}
  .dev-panel[aria-hidden="false"]{opacity:1;visibility:visible;pointer-events:auto}
  .dev-sheet{
    width:min(560px,calc(100vw - 48px));
    background:#0f172a;color:#f8fafc;border-radius:var(--radius-lg);
    border:1px solid rgba(148,163,184,.35);box-shadow:0 30px 80px -30px rgba(15,23,42,.8);
    padding:26px;display:grid;gap:18px;pointer-events:auto;
    max-height:min(80vh, 720px);
    overflow-y:auto;
  }
  .dev-sheet h3{margin:0;font-size:20px;font-weight:600}
  .dev-sheet .close{justify-self:end;border:0;background:rgba(148,163,184,.15);color:#e2e8f0;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:600}
  .dev-sheet label{color:#cbd5f5}
  .dev-sheet .input{background:rgba(15,23,42,.75);color:#f8fafc;border:1px solid rgba(148,163,184,.4)}
  .dev-tip{font-size:13px;color:rgba(226,232,240,.7)}

  .results-card{
    display:none;
    background:var(--surface-strong);
    border:1px solid rgba(148,163,184,.35);
    border-radius:18px;
    box-shadow:var(--shadow);
    padding:16px 18px;
  }
  .results-card[data-visible="true"]{display:block}
  .results-title{margin:0 0 8px 0;font-weight:700}
  .results-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .metric{padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.12);font-weight:700}
  .metric small{display:block;font-weight:600;color:var(--muted)}

  .inline-wrap{display:flex;align-items:center;gap:8px}
  .dup-indicator{display:none;font-size:12px;color:#64748b;white-space:nowrap}
  .dup-indicator[data-state="checking"],
  .dup-indicator[data-state="none"],
  .dup-indicator[data-state="error"]{display:inline-flex;align-items:center;gap:6px}
  .spinner{width:14px;height:14px;border:2px solid rgba(37,99,235,.25);border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  body.desktop .workspace{grid-template-columns:1fr 360px;align-items:start}
  body.desktop .cards-flow{grid-template-columns:repeat(2,minmax(0,1fr))}
  body.desktop .action-dock__inner{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:899px){body.desktop .workspace{grid-template-columns:1fr}}
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
  }

  .tiny-footer{font-size:12px;color:#64748b;text-align:center;padding:8px 0 14px 0}
  .dev-credit{font-size:12px;color:#64748b;font-weight:600;margin-bottom:2px}
</style>
</head>

<body>
<noscript style="padding:12px 16px;background:#fee2e2;color:#7f1d1d;border-bottom:1px solid #fecaca;font-weight:700">
  JavaScript is required for APACHE II calculations and Google Sheets submission.
</noscript>

<header class="masthead" role="banner">
  <div class="masthead__inner">
    <div class="topline">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true">AI</div>
        <div class="brand__copy">
          <h1>APACHE II bedside console</h1>
          <p>Direct to Google Sheets. One shared sheet per month. All doctors, one source of truth.</p>
        </div>
      </div>
      <button id="devToggle" class="dev-bubble" aria-label="Settings" aria-haspopup="dialog" aria-expanded="false">‚öôÔ∏è</button>
    </div>

    <div class="mode-switcher" aria-label="Submission mode">
      <div class="dev-credit">@JSF Developer 2026</div>
      <div class="mode-pills" role="group">
        <button id="modeOnline" type="button" class="mode active" disabled>Online (Google Sheets)</button>
      </div>
      <div id="modeHint" class="mode-hint">
        Data go straight to the shared ICU Google Sheet (one tab per month). Download current month uses the Apps Script download endpoint.
      </div>
      <div class="patient-mini" aria-label="Quick patient entry">
        <div class="mini-field"><span>üë§</span><input id="patientNameMini" type="text" placeholder="Patient name" autocomplete="off"></div>
        <div class="mini-field"><span>üÜî</span><input id="uhidMini" type="text" placeholder="UHID" autocomplete="off"></div>
      </div>
    </div>
  </div>
</header>

<div class="workspace-wrapper">
  <main class="workspace" id="formContent">
    <div class="cards-flow">

      <section class="panel" data-span="full" aria-labelledby="patient-h">
        <header>
          <h2 id="patient-h">Patient</h2>
          <p class="hint">Enter the patient‚Äôs full name as per hospital record and their UHID.</p>
        </header>
        <div class="grid-2">
          <div>
            <label for="patientName">Patient Name*</label>
            <input id="patientName" class="input" type="text" required placeholder="e.g., Jane Doe" autocomplete="off">
          </div>
          <div>
            <label for="uhid">
              UHID*
              <span id="dupIndicator" class="dup-indicator">
                <span class="spinner" aria-hidden="true"></span><span>Looking for duplicates‚Ä¶</span>
              </span>
            </label>
            <div class="inline-wrap">
              <input id="uhid" class="input" type="text" required placeholder="Hospital unique ID" autocomplete="off" aria-describedby="dupIndicator">
            </div>
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="demo-h">
        <header>
          <h2 id="demo-h">Demographics & Admission</h2>
          <p class="hint">Age in years, sex, ICU admission date, diagnosis. GCS is required.</p>
        </header>
        <div class="grid-3">
          <div>
            <label for="age">Age (years)*</label>
            <input id="age" class="input" type="number" min="0" max="120" step="1" required placeholder="Years">
          </div>
          <div>
            <label for="sex">Sex*</label>
            <select id="sex" class="input" required>
              <option value="" selected disabled>Select</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="admitDate">Admission Date*</label>
            <input id="admitDate" class="input" type="date" required>
          </div>
        </div>
        <div>
          <label for="diagnosis">Diagnosis*</label>
          <input id="diagnosis" class="input" type="text" required placeholder="Primary diagnosis at ICU admission">
        </div>
        <div class="grid-2">
          <div>
            <label for="gcs">GCS (3‚Äì15)*</label>
            <input id="gcs" class="input" type="number" min="3" max="15" step="1" required placeholder="e.g., 12">
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="chronic-h">
        <header>
          <h2 id="chronic-h">Chronic health</h2>
          <p class="hint">Mark severe chronic organ failure/immunocompromise. If present, specify surgical context.</p>
        </header>
        <div class="chip-row" id="chronicGrp">
          <label class="chip"><input type="radio" name="chronic" value="No" checked> No</label>
          <label class="chip"><input type="radio" name="chronic" value="Yes"> Yes ‚Äì severe organ failure / immunocompromise</label>
        </div>
        <div id="surgTypeWrap" class="grid-2" style="display:none">
          <div>
            <label>Type of surgery (if chronic = Yes)</label>
            <div class="chip-row">
              <label class="chip"><input type="radio" name="surgtype" value="Emergency" checked> Emergency</label>
              <label class="chip"><input type="radio" name="surgtype" value="Elective"> Elective</label>
              <label class="chip"><input type="radio" name="surgtype" value="Nonoperative"> Non-operative</label>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" data-span="full" aria-labelledby="inputs-h">
        <header>
          <h2 id="inputs-h">Clinical inputs</h2>
          <p class="hint">Vitals, oxygenation branch (PaO‚ÇÇ vs A‚Äìa gradient based on FiO‚ÇÇ), labs.</p>
        </header>
        <div class="tab-bar" role="tablist">
          <button class="tab active" type="button" data-tab="vitals">Vitals</button>
          <button class="tab" type="button" data-tab="oxygen">Oxygenation</button>
          <button class="tab" type="button" data-tab="labs">Labs</button>
        </div>

        <div id="tab-vitals" class="tab-panel active" role="tabpanel">
          <div class="grid-3">
            <div>
              <label for="tempF">Temperature (¬∞F)*</label>
              <input id="tempF" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label for="map">Mean Arterial Pressure (mmHg)*</label>
              <input id="map" class="input" type="number" step="1" required>
            </div>
            <div>
              <label for="hr">Heart Rate (bpm)*</label>
              <input id="hr" class="input" type="number" step="1" required>
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="rr">Respiratory Rate (breaths/min)*</label>
              <input id="rr" class="input" type="number" step="1" required>
            </div>
          </div>
        </div>

        <div id="tab-oxygen" class="tab-panel" role="tabpanel">
          <div>
            <label>FiO‚ÇÇ category*</label>
            <div class="chip-row" id="fio2Grp">
              <label class="chip"><input type="radio" name="fio2" value="<50%" checked> &lt; 50% (or non-intubated)</label>
              <label class="chip"><input type="radio" name="fio2" value=">=50%"> ‚â• 50%</label>
            </div>
          </div>

          <div id="po2Wrap">
            <label for="pao2">PaO‚ÇÇ (mmHg)*</label>
            <input id="pao2" class="input" type="number" step="1" placeholder="e.g., 80" autocomplete="off" required>
            <p class="hint">If FiO‚ÇÇ &lt; 50% ‚Üí provide PaO‚ÇÇ.</p>
          </div>

          <div id="aagradWrap" style="display:none">
            <label for="aagrad">A‚Äìa gradient (mmHg)*</label>
            <input id="aagrad" class="input" type="number" step="1" placeholder="e.g., 220" autocomplete="off">
            <p class="hint">If FiO‚ÇÇ ‚â• 50% ‚Üí provide A‚Äìa gradient.</p>
          </div>
        </div>

        <div id="tab-labs" class="tab-panel" role="tabpanel">
          <div class="grid-3">
            <div>
              <label for="ph">pH (arterial)</label>
              <input id="ph" class="input" type="number" step="0.01" min="6.8" max="7.8">
            </div>
            <div>
              <label for="hco3">HCO‚ÇÉ‚Åª (mEq/L)</label>
              <input id="hco3" class="input" type="number" step="0.1">
            </div>
            <div>
              <label for="na">Na‚Å∫ (mEq/L)*</label>
              <input id="na" class="input" type="number" step="1" required>
            </div>
          </div>
          <div class="grid-3">
            <div>
              <label for="k">K‚Å∫ (mEq/L)*</label>
              <input id="k" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label for="cr">Creatinine (mg/dL)*</label>
              <input id="cr" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label for="wbc">WBC (√ó10¬≥/mm¬≥)*</label>
              <input id="wbc" class="input" type="number" step="0.1" required>
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="hct">Hematocrit (%)*</label>
              <input id="hct" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label>Acute Renal Failure</label>
              <div class="chip-row" id="arfGrp">
                <label class="chip"><input type="radio" name="arf" value="No" checked> No</label>
                <label class="chip"><input type="radio" name="arf" value="Yes"> Yes</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="outcome-h">
        <header><h2 id="outcome-h">Outcome</h2></header>
        <div>
          <label>Mortality (Y/N)*</label>
          <div class="chip-row" role="group" aria-label="Mortality yes/no" id="mortalityGrp">
            <label class="chip"><input type="radio" name="mortality" value="Y" required> Y</label>
            <label class="chip"><input type="radio" name="mortality" value="N" required> N</label>
          </div>
        </div>
      </section>

      <aside id="resultsCard" class="results-card" aria-live="polite" aria-atomic="true">
        <h4 class="results-title">Computed Result</h4>
        <div class="results-grid">
          <div class="metric"><small>APACHE II</small><span id="resApache">‚Äî</span></div>
          <div class="metric"><small>Mortality (Non-op)</small><span id="resMortNon">‚Äî</span></div>
          <div class="metric"><small>Mortality (Post-op)</small><span id="resMortPost">‚Äî</span></div>
        </div>
      </aside>

    </div>
  </main>
</div>

<div class="action-dock" role="contentinfo">
  <div class="action-dock__inner">
    <div id="incompleteNote" class="incomplete-note" aria-live="polite">Form incomplete: please fill all required items.</div>
    <button id="btnDownload" class="btn ghost" type="button">Download current month</button>
    <button id="btnSubmit" class="btn primary" type="button" disabled>Submit to Google Sheets</button>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="toastCenter" class="toast center warn" role="status" aria-live="assertive"></div>

<!-- ADMIN OVERLAY -->
<div id="adminBackdrop" class="admin-backdrop" aria-hidden="true"></div>
<div id="adminPanel" class="admin-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="admin-sheet">
    <div class="admin-top">
      <div class="admin-title-wrap">
        <h3 id="adminTitle" class="admin-title">Quick Admin Console</h3>
        <p class="admin-sub">Patient list (current month) + Update Mortality (KP). Fast, non-blocking.</p>
      </div>
      <button id="adminClose" class="admin-close" type="button">Close</button>
    </div>

    <div class="admin-body">
      <div class="admin-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="display:grid;gap:4px">
            <h4 style="margin:0">Current UHIDs &amp; Names</h4>
            <p class="minihelp">Pulled from MAIN sheet using LIST. Scroll both directions.</p>
          </div>
          <div class="admin-actions">
            <span id="adminMonthPill" class="pill">Month: ‚Äî</span>
            <button id="btnAdminRefresh" class="btn ghost" type="button" style="padding:10px 12px">Refresh</button>
          </div>
        </div>

        <div class="table-wrap" aria-label="Patient list table container">
          <table class="admin-table" aria-label="Patient list table">
            <thead>
              <tr>
                <th style="width:180px">UHID</th>
                <th style="min-width:320px">Patient Name</th>
              </tr>
            </thead>
            <tbody id="adminPatientsTbody">
              <tr><td colspan="2" style="color:rgba(226,232,240,.75);font-weight:700">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="danger-note" id="adminListNote">
          Tip: If Dev URL/Secret are wrong, LIST won‚Äôt load. Use ‚ÄúDev Settings‚Äù below.
        </div>
      </div>

      <div class="admin-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="display:grid;gap:4px">
            <h4 style="margin:0">Update Mortality</h4>
            <p class="minihelp">Queue UHID + Y/N. Update sends KP for all ‚ÄúY‚Äù. (Backend KP may only set Y.)</p>
          </div>
          <span class="pill" id="adminQueuePill">Queued: 0</span>
        </div>

        <div class="admin-inputs">
          <div>
            <label for="kpUhid">UHID</label>
            <input id="kpUhid" class="input" type="text" placeholder="Enter UHID" autocomplete="off">
          </div>
          <div>
            <label for="kpYN">Y/N</label>
            <select id="kpYN" class="input">
              <option value="Y" selected>Y</option>
              <option value="N">N</option>
            </select>
          </div>
          <div>
            <button id="btnKpAdd" class="btn secondary" type="button" style="padding:12px 14px">Add</button>
          </div>
        </div>

        <div class="table-wrap" aria-label="KP queue table container" style="max-height:240px">
          <table class="admin-table" aria-label="KP queue table">
            <thead>
              <tr>
                <th style="width:200px">UHID</th>
                <th style="width:90px">Y/N</th>
                <th style="min-width:220px">Action</th>
              </tr>
            </thead>
            <tbody id="kpQueueTbody">
              <tr><td colspan="3" style="color:rgba(226,232,240,.75);font-weight:700">No entries yet.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="admin-actions" style="justify-content:space-between">
          <button id="btnKpClear" class="btn ghost" type="button" style="padding:10px 12px">Clear</button>
          <button id="btnKpUpdate" class="btn primary" type="button" disabled style="padding:12px 14px">Update</button>
        </div>
      </div>

      <div class="dev-entry">
        <div class="danger-note">Developer controls (URL / Secret / ClientId). Use only if needed.</div>
        <div id="btnOpenDevFromAdmin" class="dev-cta" role="button" tabindex="0" aria-label="Open Dev Settings">
          <div class="dev-ico" aria-hidden="true">üß∞</div>
          <div>Dev Settings<small>Open connection panel</small></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- DEV MODAL -->
<div id="devBackdrop" class="dev-backdrop" aria-hidden="true"></div>
<div id="devPanel" class="dev-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="devTitle">
  <div class="dev-sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
      <h3 id="devTitle">Developer / Connection</h3>
      <button id="devClose" class="close" type="button">Close</button>
    </div>
    <p class="dev-tip">Values persist per device. Leave blank to fall back to defaults.</p>
    <div>
      <label for="onlineUrl">Online Webhook URL</label>
      <input id="onlineUrl" class="input" type="url" placeholder="https://script.google.com/.../exec">
    </div>
    <div>
      <label for="onlineSecret">Online Secret</label>
      <input id="onlineSecret" class="input" type="text" placeholder="Shared secret for Sheets webhook">
    </div>
    <div>
      <label for="clientId">Client ID</label>
      <input id="clientId" class="input" type="text" value="NURSING-STATION-01">
    </div>

    <div style="border-top:1px solid rgba(148,163,184,.35);padding-top:12px">
      <h3 style="margin:0 0 8px 0;font-size:16px">Debug &amp; Tools</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnBuildPreview" class="btn secondary" type="button">Build &amp; show payload</button>
        <button id="btnCopyPreview" class="btn ghost" type="button">Copy JSON</button>
        <button id="btnCopyExcelRow" class="btn ghost" type="button" disabled>Copy APACHE row (Excel)</button>
        <button id="btnDummyFill" class="btn secondary" type="button">Dummy fill</button>
      </div>
      <pre id="debugPreview" style="margin-top:10px;max-height:260px;overflow:auto;border-radius:8px;border:1px solid rgba(148,163,184,.35);padding:12px;background:#081225;color:#e2e8f0;font:13px ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">No payload yet</pre>

      <h3 style="margin:8px 0;font-size:16px">Last server response</h3>
      <pre id="lastResp" style="max-height:180px;overflow:auto;border-radius:8px;border:1px solid rgba(148,163,184,.35);padding:12px;background:#081225;color:#e2e8f0;font:13px ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">None</pre>
    </div>
    <div class="dev-tip">The app is locked to Online (Google Sheets) mode.</div>
  </div>
</div>

<div class="tiny-footer">¬© @ JSFDev</div>

<script>
/* ----------------------------- DOM helpers ------------------------------ */
const $ = (id) => document.getElementById(id);

function escapeHtml(s){
  return String(s ?? '').replace(/[<>&]/g, ch => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[ch]));
}

function valStr(id){
  const el=$(id);
  if(!el) return null;
  const v=(el.value||'').trim();
  return v===''?null:v;
}

function valNum(id){
  const el=$(id);
  if(!el) return null;
  const raw=(el.value||'').trim();
  if(raw==='') return null;
  const n = Number(raw);
  return Number.isFinite(n) ? n : null;
}

function radioVal(name){
  const el=document.querySelector('input[name="'+name+'"]:checked');
  return el?el.value:null;
}

function todayISO(){
  const d=new Date();
  const off=d.getTimezoneOffset();
  const k=new Date(d.getTime()-off*60000);
  return k.toISOString().slice(0,10);
}

function uuidv4(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,(c)=>{
    const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;
    const v=c==='x'?r:((r&0x3)|0x8);
    return v.toString(16);
  });
}

function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

/* ----------------------------- Toasts ---------------------------------- */
function toast(msg, ok=true, klass=''){
  const t=$('toast');
  t.textContent=msg;
  t.className='toast'+(ok?'':' err')+(klass?(' '+klass):'');
  t.style.display='block';
  clearTimeout(toast._timer);
  toast._timer=setTimeout(()=>{ t.style.display='none'; }, 5200);
}

function toastCenter(msg){
  const t=$('toastCenter');
  t.textContent=msg;
  t.style.display='block';
  clearTimeout(toastCenter._timer);
  toastCenter._timer=setTimeout(()=>{ t.style.display='none'; }, 5200);
}

/* ------------------------ Desktop detection ----------------------------- */
function detectDesktop(){
  const ua=navigator.userAgent||"";
  const looksDesktop=/(Macintosh|Windows|Linux)/i.test(ua)&&!/(Mobile|Tablet|Android)/i.test(ua);
  const pointerFine=matchMedia('(pointer: fine)').matches;
  const wideEnough=matchMedia('(min-width:1024px)').matches;
  return looksDesktop||(pointerFine&&wideEnough);
}
function applyDesktopClass(){ document.body.classList.toggle('desktop', detectDesktop()); }
applyDesktopClass();
addEventListener('resize', ()=>{ clearTimeout(applyDesktopClass._timer); applyDesktopClass._timer=setTimeout(applyDesktopClass,180); });

/* ---------------------- Mini <-> Main sync ------------------------------ */
['patientName','uhid'].forEach((id)=>{
  const main=$(id); if(!main) return;
  main.addEventListener('input',()=>{
    const mini=$(id+'Mini');
    if(mini && mini.value!==main.value) mini.value=main.value;
    scheduleCompute();
  });
});
['patientNameMini','uhidMini'].forEach((id)=>{
  const mini=$(id); if(!mini) return;
  mini.addEventListener('input',()=>{
    const main=$(id.replace('Mini',''));
    if(main && main.value!==mini.value) main.value=mini.value;
    scheduleCompute();
  });
});

/* =========================================================================
   DEV / CONNECTION: persist per device
   ========================================================================= */
function saveDevOverrides(){
  const overrides={
    onlineUrl:$('onlineUrl')?.value.trim()||'',
    onlineSecret:$('onlineSecret')?.value.trim()||'',
    clientId:$('clientId')?.value.trim()||'NURSING-STATION-01'
  };
  try{ localStorage.setItem('apacheMobileDev', JSON.stringify(overrides)); }catch(_){}
}

function loadDevOverrides(){
  try{
    const raw=localStorage.getItem('apacheMobileDev');
    if(!raw) return;
    const o=JSON.parse(raw);
    if($('onlineUrl')) $('onlineUrl').value=o.onlineUrl||'';
    if($('onlineSecret')) $('onlineSecret').value=o.onlineSecret||'';
    if($('clientId')) $('clientId').value=o.clientId||'NURSING-STATION-01';
  }catch(_){}
}

/* =========================================================================
   ONLINE DEFAULTS (fallback when no dev overrides)
   ========================================================================= */
let ONLINE_WEBHOOK_URL='https://script.google.com/macros/s/AKfycbywkECpffrqsV5wCfzTYQyX6oZT9iWRhkwlVZrTAHAwCOuGDFpE66AiedZHd77qu_88/exec';
let ONLINE_SECRET='F8p^7m2bUqW!c4Z9Lh3@r6N0';

function currentConn(){
  let url = ONLINE_WEBHOOK_URL;
  let secret = ONLINE_SECRET;
  let clientId = 'NURSING-STATION-01';
  try{
    const raw = localStorage.getItem('apacheMobileDev');
    if(raw){
      const o = JSON.parse(raw);
      if(o.clientId && o.clientId.trim()) clientId = o.clientId.trim();
      if(o.onlineUrl && o.onlineUrl.trim()) url = o.onlineUrl.trim();
      if(o.onlineSecret && o.onlineSecret.trim()) secret = o.onlineSecret.trim();
    }
  }catch(_){}
  return { url, secret, clientId };
}

/* Google Apps Script links sometimes come as /dev instead of /exec */
function sanitizeExecUrl(u){
  try{
    const x=new URL(u);
    x.pathname = x.pathname.replace(/\/dev(\/)?$/i,'/exec');
    // remove trailing slash after /exec to avoid double slashes in qs concat
    x.pathname = x.pathname.replace(/\/+$/,'');
    return x.toString();
  }catch(_){
    return u;
  }
}

/* Preconnect to the Apps Script ORIGIN (DNS + TLS warmup) */
function ensurePreconnectForUrl(u){
  try{
    const origin = new URL(sanitizeExecUrl(u)).origin;
    const ensure = (rel) => {
      if(document.querySelector('link[rel="'+rel+'"][href="'+origin+'"]')) return;
      const l=document.createElement('link');
      l.rel=rel; l.href=origin;
      document.head.appendChild(l);
    };
    ensure('dns-prefetch');
    ensure('preconnect');
  }catch(_){}
}

/* =========================================================================
   MODALS: DEV + ADMIN
   ========================================================================= */
const devPanel=$('devPanel'), devBackdrop=$('devBackdrop'), devClose=$('devClose');
devPanel.setAttribute('aria-hidden','true'); devBackdrop.setAttribute('data-visible','false');

function setDevPanel(open){
  const wasOpen=devPanel.getAttribute('aria-hidden')==='false';
  devPanel.setAttribute('aria-hidden', open?'false':'true');
  devBackdrop.setAttribute('data-visible', open?'true':'false');
  devBackdrop.setAttribute('aria-hidden', open?'false':'true');
  if(wasOpen&&!open){
    saveDevOverrides();
    const { url } = currentConn();
    ensurePreconnectForUrl(url);
  }
}
devClose.addEventListener('click',()=>setDevPanel(false));
devBackdrop.addEventListener('click',()=>setDevPanel(false));

const devToggle=$('devToggle');
const adminPanel=$('adminPanel'), adminBackdrop=$('adminBackdrop'), adminClose=$('adminClose');
const btnOpenDevFromAdmin=$('btnOpenDevFromAdmin');
const btnAdminRefresh=$('btnAdminRefresh');
const adminPatientsTbody=$('adminPatientsTbody');
const adminMonthPill=$('adminMonthPill');
const adminQueuePill=$('adminQueuePill');

adminPanel.setAttribute('aria-hidden','true'); adminBackdrop.setAttribute('data-visible','false');

let adminListAbort = null;
let kpAbort = null;

function cancelAdminListFetch(){
  if(adminListAbort){
    try{ adminListAbort.abort(); }catch(_){}
    adminListAbort=null;
  }
}
function cancelKpFetch(){
  if(kpAbort){
    try{ kpAbort.abort(); }catch(_){}
    kpAbort=null;
  }
}

function setAdminPanel(open){
  const wasOpen = adminPanel.getAttribute('aria-hidden')==='false';
  adminPanel.setAttribute('aria-hidden', open?'false':'true');
  adminBackdrop.setAttribute('data-visible', open?'true':'false');
  adminBackdrop.setAttribute('aria-hidden', open?'false':'true');
  devToggle.setAttribute('aria-expanded', open?'true':'false');
  if(wasOpen && !open){
    cancelAdminListFetch();
    cancelKpFetch();
  }
}
devToggle.addEventListener('click', ()=>{
  const isHidden = adminPanel.getAttribute('aria-hidden')!=='false';
  setAdminPanel(isHidden);
  if(isHidden) adminEnsureListLoaded(true, true);
});
adminClose.addEventListener('click', ()=>setAdminPanel(false));
adminBackdrop.addEventListener('click', ()=>setAdminPanel(false));

btnOpenDevFromAdmin.addEventListener('click', ()=>{
  setAdminPanel(false);
  setDevPanel(true);
});
btnOpenDevFromAdmin.addEventListener('keydown', (ev)=>{
  if(ev.key==='Enter' || ev.key===' '){
    ev.preventDefault();
    setAdminPanel(false);
    setDevPanel(true);
  }
});

btnAdminRefresh.addEventListener('click', ()=>adminEnsureListLoaded(false, true));

addEventListener('keydown',(ev)=>{
  if(ev.key!=='Escape') return;
  if(adminPanel.getAttribute('aria-hidden')==='false'){ setAdminPanel(false); return; }
  if(devPanel.getAttribute('aria-hidden')==='false'){ setDevPanel(false); return; }
});

/* Dev URL live warm-up */
$('onlineUrl')?.addEventListener('change', ()=>{
  try{
    const u = $('onlineUrl').value.trim();
    if(u) ensurePreconnectForUrl(u);
  }catch(_){}
});

/* =========================================================================
   Chronic toggle + Oxygen toggle + Tabs
   ========================================================================= */
$('chronicGrp').addEventListener('change',()=>{
  $('surgTypeWrap').style.display = (radioVal('chronic')==='Yes') ? 'grid' : 'none';
  scheduleCompute();
});

function updateOxygenUI(){
  const v = radioVal('fio2');
  const po2=$('po2Wrap'), aagrad=$('aagradWrap'), pao2El=$('pao2'), aagradEl=$('aagrad');
  if(v === '<50%'){
    po2.style.display='block'; aagrad.style.display='none';
    if(aagradEl){ aagradEl.value=''; aagradEl.removeAttribute('required'); }
    if(pao2El){ pao2El.setAttribute('required','required'); }
  } else {
    po2.style.display='none'; aagrad.style.display='block';
    if(pao2El){ pao2El.value=''; pao2El.removeAttribute('required'); }
    if(aagradEl){ aagradEl.setAttribute('required','required'); }
  }
}
document.querySelectorAll('input[name="fio2"]').forEach(r=>r.addEventListener('change',()=>{ updateOxygenUI(); scheduleCompute(); }));

document.querySelectorAll('.tab').forEach((btn)=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach((b)=>b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach((p)=>p.classList.remove('active'));
    btn.classList.add('active');
    const target=$('tab-'+btn.dataset.tab);
    if(target) target.classList.add('active');
  });
});

/* =========================================================================
   APACHE II scoring ‚Äî binning (unchanged)
   ========================================================================= */
function fToC(f){ return (f-32)*(5/9); }
function ptsTempC(c){
  if(c==null) return 0;
  if(c>=41) return 4;
  if(c>=39 && c<41) return 3;
  if(c>=38.5 && c<39) return 1;
  if(c>=36 && c<38.5) return 0;
  if(c>=34 && c<36) return 1;
  if(c>=32 && c<34) return 2;
  if(c>=30 && c<32) return 3;
  return 4;
}
function ptsMAP(v){
  if(v==null) return 0;
  if(v>=160) return 4;
  if(v>=130) return 3;
  if(v>=110) return 2;
  if(v>=70)  return 0;
  if(v>=50)  return 2;
  return 4;
}
function ptsHR(v){
  if(v==null) return 0;
  if(v>=180) return 4;
  if(v>=140) return 3;
  if(v>=110) return 2;
  if(v>=70)  return 0;
  if(v>=55)  return 2;
  if(v>=40)  return 3;
  return 4;
}
function ptsRR(v){
  if(v==null) return 0;
  if(v>=50) return 4;
  if(v>=35) return 3;
  if(v>=25) return 1;
  if(v>=12) return 0;
  if(v>=10) return 1;
  if(v>=6)  return 2;
  return 4;
}
function ptsOxygen(fio2Cat,pao2,aagrad){
  if(fio2Cat==='>=50%'){
    if(aagrad==null) return 0;
    if(aagrad>=500) return 4;
    if(aagrad>=350) return 3;
    if(aagrad>=200) return 2;
    return 0;
  } else {
    if(pao2==null) return 0;
    if(pao2>70)    return 0;
    if(pao2>=61)   return 1;
    if(pao2>=55)   return 3;
    return 4;
  }
}
function ptsPH(ph){
  if(ph==null) return 0;
  if(ph>=7.70) return 4;
  if(ph>=7.60) return 3;
  if(ph>=7.50) return 1;
  if(ph>=7.33) return 0;
  if(ph>=7.25) return 2;
  if(ph>=7.15) return 3;
  return 4;
}
function ptsHCO3(h){
  if(h==null) return 0;
  if(h>=52) return 4;
  if(h>=41) return 3;
  if(h>=32) return 1;
  if(h>=22) return 0;
  if(h>=18) return 2;
  if(h>=15) return 3;
  return 4;
}
function acidBasePoints(ph, hco3){
  if(ph!=null) return ptsPH(ph);
  if(hco3!=null) return ptsHCO3(hco3);
  return 0;
}
function ptsNa(v){
  if(v==null) return 0;
  if(v>=180) return 4;
  if(v>=160) return 3;
  if(v>=155) return 2;
  if(v>=150) return 1;
  if(v>=130) return 0;
  if(v>=120) return 2;
  if(v>=111) return 3;
  return 4;
}
function ptsK(v){
  if(v==null) return 0;
  if(v>=7.0) return 4;
  if(v>=6.0) return 3;
  if(v>=5.5) return 1;
  if(v>=3.5) return 0;
  if(v>=3.0) return 1;
  if(v>=2.5) return 2;
  return 4;
}
function ptsCreatinine(v,arf){
  if(v==null) return 0;
  let pts=0;
  if(v>=3.5) pts=4;
  else if(v>=2.0) pts=3;
  else if(v>=1.5) pts=2;
  else if(v<0.6) pts=2;
  else pts=0;
  if(arf) pts*=2;
  return pts;
}
function ptsHct(v){
  if(v==null) return 0;
  if(v>=60) return 4;
  if(v>=50) return 2;
  if(v>=46) return 1;
  if(v>=30) return 0;
  if(v>=20) return 2;
  return 4;
}
function ptsWBC(v){
  if(v==null) return 0;
  if(v>=40) return 4;
  if(v>=20) return 2;
  if(v>=15) return 1;
  if(v>=3)  return 0;
  if(v>=1)  return 2;
  return 4;
}
function ptsGCS(g){ if(g==null) return 0; const diff=15-g; return diff<0?0:diff; }
function agePoints(age){
  if(age==null) return 0;
  if(age<=44) return 0;
  if(age<=54) return 2;
  if(age<=64) return 3;
  if(age<=74) return 5;
  return 6;
}
function chronicPoints(chronic,surgtype){
  if(chronic!=='Yes') return 0;
  if(surgtype==='Elective') return 2;
  return 5;
}
function mortalityBands(score){
  const s = Number(score||0);
  if(s<=4)  return { nonop:4,  postop:1 };
  if(s<=9)  return { nonop:8,  postop:3 };
  if(s<=14) return { nonop:15, postop:7 };
  if(s<=19) return { nonop:25, postop:12 };
  if(s<=24) return { nonop:40, postop:30 };
  if(s<=29) return { nonop:55, postop:35 };
  if(s<=34) return { nonop:73, postop:73 };
  return { nonop:85, postop:88 };
}

/* =========================================================================
   FAST COMPUTE PIPELINE (debounce + cache)
   ========================================================================= */
function istMonthYYYYMM(){
  try{
    return new Date().toLocaleString('en-CA', { timeZone: 'Asia/Kolkata', year: 'numeric', month: '2-digit' });
  }catch(_){
    return (new Date().toISOString()).slice(0,7);
  }
}
function monthKeyFromISO(iso){ return (iso||new Date().toISOString()).slice(0,7); }

/* Lightweight completeness check (FAST). */
function validateLight(){
  const patientName = valStr('patientName');
  const uhid = valStr('uhid');
  const diagnosis = valStr('diagnosis');
  const admitDate = valStr('admitDate');

  const sex = $('sex')?.value || '';

  const age = valNum('age');
  const gcs = valNum('gcs');
  const tempF = valNum('tempF');
  const map = valNum('map');
  const hr = valNum('hr');
  const rr = valNum('rr');
  const na = valNum('na');
  const k = valNum('k');
  const cr = valNum('cr');
  const wbc = valNum('wbc');
  const hct = valNum('hct');

  const fio2 = radioVal('fio2');
  const mortYN = radioVal('mortality');

  if(!patientName || !uhid || !diagnosis || !admitDate) return { ok:false, why:'Missing required identity/admission fields' };
  if(!sex) return { ok:false, why:'Sex required' };
  if(age==null || gcs==null) return { ok:false, why:'Age/GCS required' };
  if(tempF==null || map==null || hr==null || rr==null) return { ok:false, why:'Vitals incomplete' };
  if(na==null || k==null || cr==null || wbc==null || hct==null) return { ok:false, why:'Labs incomplete' };
  if(!fio2) return { ok:false, why:'FiO2 required' };
  if(!mortYN) return { ok:false, why:'Mortality Y/N required' };

  if(fio2 === '<50%'){
    const pao2 = valNum('pao2');
    if(pao2==null) return { ok:false, why:'PaO2 required for FiO2 <50%' };
  }else{
    const aagrad = valNum('aagrad');
    if(aagrad==null) return { ok:false, why:'A-a gradient required for FiO2 >=50%' };
  }

  const phVal = valNum('ph');
  const hco3Val = valNum('hco3');
  if(phVal==null && hco3Val==null) return { ok:false, why:'pH or HCO3 required' };

  return { ok:true };
}

function snapshotInputsForCompute(){
  const age = valNum('age');
  const fio2 = radioVal('fio2');
  const tempF = valNum('tempF');
  const map = valNum('map');
  const hr = valNum('hr');
  const rr = valNum('rr');
  const pao2 = fio2 === '<50%' ? valNum('pao2') : null;
  const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;

  const phVal = valNum('ph');
  const hco3Val = valNum('hco3');

  const na = valNum('na');
  const k = valNum('k');
  const cr = valNum('cr');
  const wbc = valNum('wbc');
  const hct = valNum('hct');

  const gcs = valNum('gcs');
  const arf = (radioVal('arf')==='Yes');
  const chronic = radioVal('chronic')==='Yes' ? 'Yes' : 'No';
  const surgtype = chronic==='Yes' ? radioVal('surgtype') : null;

  return { age, fio2, tempF, map, hr, rr, pao2, aagrad, phVal, hco3Val, na, k, cr, wbc, hct, gcs, arf, chronic, surgtype };
}

function signatureKey(s){
  return [
    s.age, s.fio2, s.tempF, s.map, s.hr, s.rr, s.pao2, s.aagrad,
    s.phVal, s.hco3Val, s.na, s.k, s.cr, s.wbc, s.hct, s.gcs,
    s.arf?1:0, s.chronic, s.surgtype||''
  ].join('|');
}

let COMPUTE_CACHE = { key:null, value:null };

function computeApacheFast(snap){
  const tempC = snap.tempF!=null ? fToC(snap.tempF) : null;

  const aps = ptsTempC(tempC)+
              ptsMAP(snap.map)+
              ptsHR(snap.hr)+
              ptsRR(snap.rr)+
              ptsOxygen(snap.fio2, snap.pao2, snap.aagrad)+
              acidBasePoints(snap.phVal, snap.hco3Val)+
              ptsNa(snap.na)+
              ptsK(snap.k)+
              ptsCreatinine(snap.cr, snap.arf)+
              ptsHct(snap.hct)+
              ptsWBC(snap.wbc)+
              ptsGCS(snap.gcs);

  const agePts = agePoints(snap.age);
  const chronicPts = chronicPoints(snap.chronic, snap.surgtype);
  const apacheII = aps + agePts + chronicPts;

  const mort = mortalityBands(apacheII);
  return { apacheII, mortNon: mort.nonop, mortPost: mort.postop };
}

function computeCached(){
  const snap = snapshotInputsForCompute();
  const key = signatureKey(snap);
  if(COMPUTE_CACHE.key === key && COMPUTE_CACHE.value) return COMPUTE_CACHE.value;
  const out = computeApacheFast(snap);
  COMPUTE_CACHE = { key, value: out };
  return out;
}

let computeTimer = null;
function scheduleCompute(){
  clearTimeout(computeTimer);
  computeTimer = setTimeout(runComputeAndUI, 120);
}

function runComputeAndUI(){
  const v = validateLight();

  const submit = $('btnSubmit');
  const note = $('incompleteNote');
  const card = $('resultsCard');

  if(!v.ok){
    if(submit) submit.disabled = true;
    if(note) note.setAttribute('data-visible','true');
    if(card) card.setAttribute('data-visible','false');
    if($('btnCopyExcelRow')) $('btnCopyExcelRow').disabled = true;
    return;
  }

  if(submit) submit.disabled = false;
  if(note) note.setAttribute('data-visible','false');

  const res = computeCached();
  $('resApache').textContent = String(res.apacheII) + ' pts';
  $('resMortNon').textContent = String(res.mortNon) + '%';
  $('resMortPost').textContent = String(res.mortPost) + '%';
  if(card) card.setAttribute('data-visible','true');
  if($('btnCopyExcelRow')) $('btnCopyExcelRow').disabled = false;
}

function attachFastListeners(){
  const ids = [
    'patientName','uhid','age','sex','admitDate','diagnosis','gcs',
    'tempF','map','hr','rr','pao2','aagrad','ph','hco3','na','k','cr','wbc','hct'
  ];
  ids.forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener('input', scheduleCompute, { passive:true });
    el.addEventListener('change', scheduleCompute, { passive:true });
  });

  const radioNames = ['fio2','arf','chronic','surgtype','mortality'];
  radioNames.forEach(n=>{
    document.querySelectorAll('input[name="'+n+'"]').forEach(r=>{
      r.addEventListener('change', scheduleCompute, { passive:true });
    });
  });
}

/* =========================================================================
   Strict payload builder (ONLY used for submit & preview)
   ========================================================================= */
function buildPayloadStrict(){
  const patientName=valStr('patientName');
  const uhid=valStr('uhid');
  const age=valNum('age');
  const sexSel=$('sex'); const sex=sexSel?sexSel.value:'';
  const diagnosis=valStr('diagnosis');
  const admitDate=valStr('admitDate');
  const fio2=radioVal('fio2');
  const mortYN=radioVal('mortality');

  if(!patientName) throw new Error('Patient Name is required');
  if(!uhid) throw new Error('UHID is required');
  if(age===null) throw new Error('Age is required');
  if(!sex) throw new Error('Sex is required');
  if(!diagnosis) throw new Error('Diagnosis is required');
  if(!admitDate) throw new Error('Admission Date is required');
  if(!fio2) throw new Error('FiO‚ÇÇ category is required');
  if(!mortYN) throw new Error('Mortality (Y/N) is required');

  const chronic=radioVal('chronic');
  const surgtype=chronic==='Yes' ? radioVal('surgtype') : null;

  const tempF = valNum('tempF'); if(tempF===null) throw new Error('Temperature is required');
  const map   = valNum('map');   if(map===null)   throw new Error('MAP is required');
  const hr    = valNum('hr');    if(hr===null)    throw new Error('Heart Rate is required');
  const rr    = valNum('rr');    if(rr===null)    throw new Error('Respiratory Rate is required');

  const pao2 = fio2 === '<50%' ? valNum('pao2') : null;
  const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;
  if(fio2 === '<50%' && pao2===null) throw new Error('PaO‚ÇÇ is required when FiO‚ÇÇ < 50%');
  if(fio2 !== '<50%' && aagrad===null) throw new Error('A‚Äìa gradient is required when FiO‚ÇÇ ‚â• 50%');

  const phVal = valNum('ph');
  const hco3Val = valNum('hco3');
  if(phVal===null && hco3Val===null) throw new Error('Provide arterial pH or HCO‚ÇÉ‚Åª');

  const na = valNum('na'); if(na===null) throw new Error('Sodium is required');
  const k  = valNum('k');  if(k===null)  throw new Error('Potassium is required');
  const cr = valNum('cr'); if(cr===null) throw new Error('Creatinine is required');
  const wbc= valNum('wbc');if(wbc===null)throw new Error('WBC is required');
  const hct= valNum('hct');if(hct===null)throw new Error('Hematocrit is required');

  const gcs = valNum('gcs'); if(gcs===null) throw new Error('GCS is required');

  const inputs={
    Age_years: age,
    GCS: gcs,
    Temperature_F: tempF,
    MAP_mmHg: map,
    HeartRate_bpm: hr,
    RespRate_bpm: rr,
    FiO2_Category: fio2,
    PaO2_mmHg: pao2,
    AaGradient_mmHg: aagrad,
    pH: phVal,
    HCO3_mEqL: hco3Val,
    Na_mEqL: na,
    K_mEqL: k,
    Creatinine_mgdl: cr,
    AcuteRenalFailure: radioVal('arf')==='Yes',
    Hematocrit_pct: hct,
    WBC_10e3uL: wbc,
    ChronicHealth: chronic==='Yes' ? 'Yes' : 'No',
    SurgeryType: surgtype
  };

  const nowIso=new Date().toISOString();
  const { clientId } = currentConn();

  const { apacheII, mortNon, mortPost } = computeApacheFast({
    age, fio2, tempF, map, hr, rr, pao2, aagrad, phVal, hco3Val, na, k, cr, wbc, hct, gcs,
    arf: inputs.AcuteRenalFailure,
    chronic: inputs.ChronicHealth,
    surgtype
  });

  const selectedMortality = (surgtype==='Emergency' || surgtype==='Elective') ? mortPost : mortNon;

  const row=[ uhid, patientName, age, sex, diagnosis, admitDate, apacheII, selectedMortality, mortYN ];

  return {
    clientId,
    authToken: '',
    patientName, uhid, age, sex, diagnosis, admitDate,
    timestamp: nowIso,
    month: monthKeyFromISO(nowIso),
    submissionId: uuidv4(),
    apacheInputs: inputs,
    apacheScore: apacheII,
    predictedMortalityNonOpPct: mortNon,
    predictedMortalityPostOpPct: mortPost,
    predictedMortalityPct: selectedMortality,
    mortalityYN: mortYN,
    sheetRow: row
  };
}

/* =========================================================================
   NETWORK HELPERS
   ========================================================================= */
function withTimeout(ms){
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), ms);
  return { ctrl, cancel: ()=>clearTimeout(timer) };
}

function isOkish(data){
  if(!data) return false;
  if(data.ok === true) return true;
  if(data.success === true) return true;
  if(String(data.status||'').toLowerCase() === 'ok') return true;
  return false;
}

async function sendJson(url, payload, label, timeoutMs=12000){
  let res, text;
  const { ctrl, cancel } = withTimeout(timeoutMs);

  try{
    res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-store',
      keepalive: true,
      signal: ctrl.signal
    });
  }catch(netErr){
    cancel();
    if(netErr && netErr.name === 'AbortError'){
      throw new Error(label+' timed out (>'+timeoutMs+'ms). Check network/server load.');
    }
    throw new Error(label+' network error: '+(netErr && netErr.message ? netErr.message : String(netErr)));
  }

  cancel();
  try{ text = await res.text(); }catch(_){ text=''; }

  let data=null;
  try{ data = text ? JSON.parse(text) : null; }catch(_){
    throw new Error(label+' returned non-JSON: '+(text ? text.slice(0,220) : 'empty body'));
  }

  if(!res.ok){
    const msg=(data && (data.error||data.message)) || ('HTTP '+res.status);
    throw new Error(label+' HTTP error: '+msg);
  }
  return data;
}

/* =========================================================================
   Submit (FAST UX)
   ========================================================================= */
async function postOnline(strictPayload){
  const { url, secret, clientId } = currentConn();
  if(!url) throw new Error('Online Webhook URL not configured.');

  const execUrl = sanitizeExecUrl(url);

  const sendPayload = {
    ...strictPayload,
    clientId,
    authToken: secret || ''
  };

  const data = await sendJson(execUrl, sendPayload, 'Google Sheets webhook', 12000);

  if(!isOkish(data)){
    const detail = data && (data.error || data.message || JSON.stringify(data).slice(0,200));
    throw new Error('Sheets webhook did not confirm success' + (detail?': '+detail:''));
  }
  return data;
}

$('btnSubmit').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const button=$('btnSubmit');
  button.disabled=true;

  const slowTimer = setTimeout(()=>toastCenter('Still sending‚Ä¶ network may be slow.'), 1600);

  try{
    saveDevOverrides();
    const payload = buildPayloadStrict();

    toast('Sending to Google Sheets‚Ä¶');
    const resp = await postOnline(payload);

    clearTimeout(slowTimer);
    if($('lastResp')) $('lastResp').textContent = JSON.stringify(resp, null, 2);

    toast('Saved to Google Sheets ‚úÖ');
    scheduleCompute();
  }catch(e){
    clearTimeout(slowTimer);
    if($('lastResp')) $('lastResp').textContent = (e && e.message) ? e.message : String(e);
    toast('Submit failed: '+(e && e.message ? e.message : String(e)), false);
  }finally{
    scheduleCompute();
  }
});

/* =========================================================================
   Download current month (supports JSON dataUri OR direct file)
   ========================================================================= */
async function downloadCurrentMonth(){
  const { url, secret } = currentConn();
  if(!url) throw new Error('Online URL missing.');
  if(!secret) throw new Error('Online Secret missing (required for download).');

  const ym = istMonthYYYYMM();
  const execUrl = sanitizeExecUrl(url);

  const qs = new URLSearchParams({
    action:'download',
    month: ym,
    auth: secret,
    authToken: secret
  }).toString();

  const full = execUrl + (execUrl.includes('?')?'&':'?') + qs;

  const { ctrl, cancel } = withTimeout(15000);
  try{
    const res = await fetch(full, {
      method:'GET',
      mode:'cors',
      credentials:'omit',
      cache:'no-store',
      signal: ctrl.signal
    });

    const ct = (res.headers.get('content-type')||'').toLowerCase();

    if(ct.includes('application/json') || ct.includes('text/json') || ct.includes('application/javascript')){
      const text = await res.text();
      let data={};
      try{ data = text ? JSON.parse(text) : {}; }catch(_){ data = {}; }

      if(!res.ok || !isOkish(data)){
        const msg = (data && (data.error||data.message)) || ('HTTP '+res.status);
        throw new Error('Download failed: '+msg);
      }

      const dataUri = data.dataUri || data.dataURL || data.uri || '';
      const href = data.downloadUrl || data.url || dataUri;
      if(!href) throw new Error('Download response missing dataUri/url.');

      const a = document.createElement('a');
      a.href = href;
      a.download = data.filename || ('APACHE-'+ym+'.xlsx');
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>a.remove(), 400);

      toast('Download started ‚úÖ');
      return;
    }

    if(!res.ok){
      throw new Error('Download HTTP '+res.status);
    }

    const blob = await res.blob();
    const a = document.createElement('a');
    const obj = URL.createObjectURL(blob);
    a.href = obj;
    a.download = 'APACHE-'+ym+(ct.includes('csv')?'.csv':'.xlsx');
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(obj); a.remove(); }, 1400);

    toast('Download started ‚úÖ');
  }catch(e){
    if(e && e.name === 'AbortError') toast('Download timed out.', false);
    else toast('Download failed: '+(e && e.message ? e.message : String(e)), false);

    try{ window.open(full, '_blank', 'noopener'); }catch(_){}
  }finally{
    cancel();
  }
}
$('btnDownload').addEventListener('click', ()=>downloadCurrentMonth());

/* =========================================================================
   Dev tools (preview/copy/dummy)
   ========================================================================= */
$('btnBuildPreview').addEventListener('click', ()=>{
  try{
    const payload=buildPayloadStrict();
    $('debugPreview').textContent = JSON.stringify(payload, null, 2);
    toast('Payload built');
  }catch(e){
    $('debugPreview').textContent = 'Error: '+e.message;
    toast(e.message, false);
  }
});

$('btnCopyPreview').addEventListener('click', ()=>{
  try{ navigator.clipboard.writeText($('debugPreview').textContent||''); toast('Copied JSON'); }
  catch(_){ toast('Copy failed', false); }
});

$('btnCopyExcelRow').addEventListener('click', ()=>{
  try{
    const p = buildPayloadStrict();
    navigator.clipboard.writeText(p.sheetRow.join('\t'));
    toast('Row copied (tab-separated). Paste into Excel/Sheets.');
  }catch(e){
    toast('Copy failed: '+(e && e.message ? e.message : String(e)), false);
  }
});

function dummyFill(){
  const age = randInt(45,70);
  $('patientName').value = 'Jane Doe';
  $('patientNameMini').value = 'Jane Doe';
  $('uhid').value = '2010' + String(randInt(1000,9999));
  $('uhidMini').value = $('uhid').value;

  $('age').value = String(age);
  $('sex').value = 'Female';
  $('admitDate').value = todayISO();
  $('diagnosis').value = 'CKD on HTN; Community-acquired pneumonia; on oxygen';

  $('tempF').value = '99.1';
  $('map').value = '78';
  $('hr').value = '96';
  $('rr').value = '22';
  $('gcs').value = '14';

  document.querySelector('input[name="fio2"][value="<50%"]').checked = true;
  updateOxygenUI();
  $('pao2').value = '72';
  $('aagrad').value = '';

  $('ph').value = '7.36';
  $('hco3').value = '22';
  $('na').value = '138';
  $('k').value = '4.8';
  $('cr').value = '2.6';
  $('wbc').value = '13.2';
  $('hct').value = '33';

  document.querySelector('input[name="arf"][value="Yes"]').checked = true;

  document.querySelector('input[name="chronic"][value="Yes"]').checked = true;
  $('surgTypeWrap').style.display = 'grid';
  document.querySelector('input[name="surgtype"][value="Nonoperative"]').checked = true;

  document.querySelector('input[name="mortality"][value="N"]').checked = true;

  toast('Dummy data filled');
  scheduleCompute();
}
$('btnDummyFill').addEventListener('click', ()=>{ try{ dummyFill(); }catch(e){ toast('Dummy fill failed: '+e.message, false); } });

/* =========================================================================
   Duplicate-check (GET, blur-triggered, cancelable)
   ========================================================================= */
let dupAbort = null;
const dupEl = $('dupIndicator');

function setDupStatus(state, text){
  if(!dupEl) return;
  dupEl.dataset.state = state || '';
  if(state === 'checking'){
    dupEl.innerHTML = '<span class="spinner" aria-hidden="true"></span><span>'+(text||'Looking for duplicates‚Ä¶')+'</span>';
    dupEl.style.display = 'inline-flex';
  }else if(state === 'none'){
    dupEl.innerHTML = '<span>‚úì</span><span>'+(text||'No duplicates')+'</span>';
    dupEl.style.display = 'inline-flex';
    setTimeout(()=>{ dupEl.style.display='none'; }, 1600);
  }else if(state === 'error'){
    dupEl.innerHTML = '<span>!</span><span>'+(text||'Check failed')+'</span>';
    dupEl.style.display = 'inline-flex';
    setTimeout(()=>{ dupEl.style.display='none'; }, 2000);
  }else{
    dupEl.style.display='none';
  }
}

function cancelDupRequest(){
  if(dupAbort){ try{ dupAbort.abort(); }catch(_){ } dupAbort=null; }
}

function bothFilled(){
  const name = valStr('patientName');
  const uhid = valStr('uhid');
  return !!(name && uhid);
}

function looksDuplicate(data){
  if(!data) return false;
  if(data.tag === 'duplicate_entry') return true;
  if(data.duplicate === true) return true;
  if(data.isDuplicate === true) return true;
  if((data.matches|0) > 0) return true;
  if(Array.isArray(data.matches) && data.matches.length>0) return true;
  if(Array.isArray(data.duplicates) && data.duplicates.length>0) return true;
  return false;
}

async function checkDuplicateNow(reason){
  const name = valStr('patientName');
  const uhid = valStr('uhid');
  if(!name || !uhid) return;

  const { url, secret } = currentConn();
  if(!url) return;

  cancelDupRequest();
  dupAbort = new AbortController();
  setDupStatus('checking', 'Looking for duplicates‚Ä¶');

  const execUrl = sanitizeExecUrl(url);
  const ym = istMonthYYYYMM();

  const qs = new URLSearchParams({
    action:'check',
    uhid: String(uhid).trim(),
    name: String(name).trim(),
    month: ym,
    auth: secret || '',
    authToken: secret || ''
  }).toString();

  const full = execUrl + (execUrl.includes('?')?'&':'?') + qs;

  try{
    const res = await fetch(full, {
      method:'GET',
      mode:'cors',
      credentials:'omit',
      cache:'no-store',
      signal: dupAbort.signal
    });

    const text = await res.text();
    let data = {};
    try{ data = text ? JSON.parse(text) : {}; }catch(_){ data={}; }

    if(!res.ok){
      setDupStatus('error','Check failed');
      return;
    }

    if(looksDuplicate(data)){
      setDupStatus('', '');
      toastCenter('Possible duplicate entry found!');
    }else{
      setDupStatus('none','No duplicates');
    }

    if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);
  }catch(e){
    if(e && e.name==='AbortError') return;
    setDupStatus('error','Check failed');
  }
}

function onBlurTrigger(ev){
  if(bothFilled()) checkDuplicateNow('blur from '+ev.target.id);
}
function onFocusCancel(){
  cancelDupRequest();
  setDupStatus('', '');
}
['patientName','uhid','patientNameMini','uhidMini'].forEach(id=>{
  const el=$(id);
  if(!el) return;
  el.addEventListener('focus', onFocusCancel, true);
  el.addEventListener('blur', onBlurTrigger, true);
});

/* =========================================================================
   ADMIN: LIST patients ‚Äî cached + abortable + response-normalization
   ========================================================================= */
const ADMIN_LIST_CACHE = new Map();
const ADMIN_LIST_TTL_MS = 30_000;

function normalizePatientsFromListResponse(data){
  // Accept multiple shapes.
  const root = data?.data ?? data ?? {};
  let patients = root.patients ?? root.rows ?? root.list ?? [];
  if(!Array.isArray(patients)) patients = [];

  const out = [];
  for(const item of patients){
    if(Array.isArray(item)){
      out.push({ uhid: item[0], name: item[1] });
    }else if(item && typeof item === 'object'){
      out.push({
        uhid: item.uhid ?? item.UHID ?? item.id ?? item[0],
        name: item.name ?? item.patientName ?? item.PatientName ?? item[1]
      });
    }
  }
  // filter empties
  return out.filter(x => String(x.uhid ?? '').trim() || String(x.name ?? '').trim());
}

function renderPatientsTable(patients){
  if(!adminPatientsTbody) return;
  if(!patients || patients.length===0){
    adminPatientsTbody.innerHTML = '<tr><td colspan="2" style="color:rgba(226,232,240,.75);font-weight:700">No entries found for this month.</td></tr>';
    return;
  }
  let html = '';
  for(let i=0;i<patients.length;i++){
    const u = escapeHtml(patients[i].uhid||'');
    const n = escapeHtml(patients[i].name||'');
    html += '<tr><td style="font-weight:800;color:#e2e8f0">'+u+'</td><td style="color:rgba(226,232,240,.92)">'+n+'</td></tr>';
  }
  adminPatientsTbody.innerHTML = html;
}

async function fetchPatientsList(month, force=false){
  const key = String(month||'').trim();
  if(!key) throw new Error('Month missing');

  const cached = ADMIN_LIST_CACHE.get(key);
  if(!force && cached && (Date.now()-cached.ts) < ADMIN_LIST_TTL_MS){
    return cached.patients;
  }

  const { url, secret } = currentConn();
  if(!url) throw new Error('Online URL missing');
  if(!secret) throw new Error('Online Secret missing (required for LIST/KP)');

  cancelAdminListFetch();
  adminListAbort = new AbortController();

  const execUrl = sanitizeExecUrl(url);

  // COMPAT: send BOTH action=list and tag=LIST (script variants)
  const qs = new URLSearchParams({
    action: 'list',
    tag: 'LIST',
    month: key,
    limit: '5000',
    offset: '0',
    auth: secret,
    authToken: secret
  }).toString();

  const full = execUrl + (execUrl.includes('?')?'&':'?') + qs;

  adminPatientsTbody.innerHTML = '<tr><td colspan="2" style="color:rgba(226,232,240,.75);font-weight:700">Loading‚Ä¶</td></tr>';

  const { ctrl, cancel } = withTimeout(9000);

  // Combine abort signals (timeout OR manual)
  const master = new AbortController();
  const abort = () => { try{ master.abort(); }catch(_){} };
  adminListAbort.signal.addEventListener('abort', abort, { once:true });
  ctrl.signal.addEventListener('abort', abort, { once:true });

  try{
    const res = await fetch(full, {
      method:'GET',
      mode:'cors',
      credentials:'omit',
      cache:'no-store',
      signal: master.signal
    });

    const text = await res.text();
    let data = {};
    try{ data = text ? JSON.parse(text) : {}; }catch(_){ data = {}; }

    if(!res.ok){
      const msg = (data && (data.error||data.message)) || ('HTTP '+res.status);
      throw new Error('LIST failed: '+msg);
    }
    if(!isOkish(data)){
      throw new Error('LIST did not confirm ok');
    }

    const patients = normalizePatientsFromListResponse(data);
    ADMIN_LIST_CACHE.set(key, { ts: Date.now(), patients });

    if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);
    return patients;
  }finally{
    cancel();
  }
}

async function adminEnsureListLoaded(opening=false, force=false){
  try{
    const month = istMonthYYYYMM();
    if(adminMonthPill) adminMonthPill.textContent = 'Month: '+month;
    if(adminPanel.getAttribute('aria-hidden')!=='false') return;

    const patients = await fetchPatientsList(month, force);
    renderPatientsTable(patients);
    if(!opening) toast('List updated ‚úÖ');
  }catch(e){
    renderPatientsTable([]);
    toast('List failed: '+(e && e.message ? e.message : String(e)), false);
  }
}

/* =========================================================================
   ADMIN: KP queue + Update
   ========================================================================= */
const kpUhid=$('kpUhid'), kpYN=$('kpYN'), btnKpAdd=$('btnKpAdd'), btnKpUpdate=$('btnKpUpdate'), btnKpClear=$('btnKpClear');
const kpQueueTbody=$('kpQueueTbody');

let KP_QUEUE = [];
function normalizeUhid(u){ return String(u||'').trim(); }

function kpQueueSet(next){
  KP_QUEUE = Array.isArray(next) ? next : [];
  renderKpQueue();
}
function renderKpQueue(){
  const n = KP_QUEUE.length;
  if(adminQueuePill) adminQueuePill.textContent = 'Queued: '+n;
  if(btnKpUpdate) btnKpUpdate.disabled = (n===0);

  if(!kpQueueTbody) return;
  if(n===0){
    kpQueueTbody.innerHTML = '<tr><td colspan="3" style="color:rgba(226,232,240,.75);font-weight:700">No entries yet.</td></tr>';
    return;
  }

  let html = '';
  for(let i=0;i<n;i++){
    const item = KP_QUEUE[i];
    const u = escapeHtml(item.uhid||'');
    const yn = escapeHtml(item.yn||'Y');
    html += '<tr>' +
      '<td style="font-weight:800;color:#e2e8f0">'+u+'</td>' +
      '<td style="font-weight:900">'+yn+'</td>' +
      '<td><button class="btn ghost" type="button" data-kp-remove="'+i+'" style="padding:8px 10px">Remove</button></td>' +
    '</tr>';
  }
  kpQueueTbody.innerHTML = html;
}
kpQueueTbody.addEventListener('click', (ev)=>{
  const t = ev.target;
  if(!t) return;
  const idx = t.getAttribute && t.getAttribute('data-kp-remove');
  if(idx==null) return;
  const i = Number(idx);
  if(Number.isFinite(i)){
    const next = KP_QUEUE.slice();
    next.splice(i, 1);
    kpQueueSet(next);
  }
});
btnKpAdd.addEventListener('click', ()=>{
  const u = normalizeUhid(kpUhid.value);
  const yn = String(kpYN.value||'Y').trim().toUpperCase()==='N' ? 'N' : 'Y';
  if(!u){ toast('Enter UHID', false); return; }

  const next = KP_QUEUE.filter(x => String(x.uhid) !== u);
  next.push({ uhid:u, yn });
  kpQueueSet(next);

  kpUhid.value = '';
  kpUhid.focus();
  toast('Added to queue');
});
btnKpClear.addEventListener('click', ()=>{
  kpQueueSet([]);
  toast('Queue cleared');
});

async function postKP(uhids){
  const { url, secret } = currentConn();
  if(!url) throw new Error('Online URL missing');
  if(!secret) throw new Error('Online Secret missing (required for KP)');

  const execUrl = sanitizeExecUrl(url);
  const payload = {
    tag: 'KP',
    month: istMonthYYYYMM(),
    uhids: uhids,
    authToken: secret
  };
  return await sendJson(execUrl, payload, 'KP', 12000);
}

btnKpUpdate.addEventListener('click', async ()=>{
  if(KP_QUEUE.length===0) return;

  const yList = KP_QUEUE.filter(x => x.yn==='Y').map(x => x.uhid);
  const nList = KP_QUEUE.filter(x => x.yn==='N').map(x => x.uhid);

  if(nList.length>0) toast('Note: Backend KP may set Y only. N entries will be skipped.', true, 'warn');
  if(yList.length===0){ toast('Nothing to update (only N entries).', false); return; }

  cancelKpFetch();
  kpAbort = new AbortController();

  toast('Updating mortality (KP)‚Ä¶');

  try{
    const resp = await postKP(yList);
    if($('lastResp')) $('lastResp').textContent = JSON.stringify(resp, null, 2);

    if(!isOkish(resp)){
      const detail = resp && (resp.error || resp.message || JSON.stringify(resp).slice(0,200));
      throw new Error('KP did not confirm ok' + (detail?': '+detail:''));
    }

    const remain = KP_QUEUE.filter(x => x.yn==='N');
    kpQueueSet(remain);

    toast('Mortality updated for '+yList.length+' UHID(s) ‚úÖ');
    adminEnsureListLoaded(false, true);
  }catch(e){
    toast('KP failed: '+(e && e.message ? e.message : String(e)), false);
  }finally{
    kpAbort = null;
  }
});

/* =========================================================================
   INIT
   ========================================================================= */
document.addEventListener('DOMContentLoaded', ()=>{
  loadDevOverrides();

  const { url } = currentConn();
  ensurePreconnectForUrl(url);

  updateOxygenUI();
  attachFastListeners();

  if(adminMonthPill) adminMonthPill.textContent = 'Month: '+istMonthYYYYMM();
  kpQueueSet([]);

  scheduleCompute();
  setDupStatus('', '');
});
</script>
</body>
</html>
