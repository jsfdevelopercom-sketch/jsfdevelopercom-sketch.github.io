<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>APACHE II Bedside Entry</title>

<!--
===============================================================================
‚úÖ COMPLETE HTML (FULL FILE, NOT PATCHES)
===============================================================================

WHAT CHANGED (per your instructions)
1) ‚úÖ MAIN WEBSITE HAS 3 TOP-LEVEL TABS:
   - Form (default selected on load)
   - Controls (full-page ‚ÄúQuick Admin Console‚Äù)
   - Help (elaborate instructions + scoring table + contact developer)

2) ‚úÖ SETTINGS ICON MOVED:
   - Removed from Form (header)
   - Appears near top of Controls page (Sheet Controls)
   - Clicking it opens the SAME Dev/Connection floating panel as before (unchanged).

3) ‚úÖ SUBMIT UX REDUCED:
   - On submit click: show ONLY "Sent to Server ..."
   - Then WAIT for server response
   - On success: show success message
   - On error: show error message
   - No other intermediate toasts / ‚Äúsending‚Ä¶ still processing‚Ä¶‚Äù etc.

4) ‚úÖ CONTROLS PAGE TABLE:
   - Month selector + Refresh button above the table
   - Forced vertical + horizontal scrollbars
   - Shows COMPLETE entries (UHID, name, age, sex, date, scores, mortality, etc.)
   - Removes the prior little ‚ÄúTip‚Äù block.

5) ‚úÖ CONTROLS PAGE CACHING:
   - First visit loads table (unless cache already exists for that month)
   - Stores the loaded entries locally (localStorage; iOS/Android compatible; no permissions)
   - Switching away and back does NOT reload from server
   - Refresh button forces reload + updates cache
   - Month selector uses cache if available, else loads from server
   - While reloading: shows a small waiting spinner next to table header (like before)

6) ‚úÖ SCRIPT COMPATIBILITY:
   - Kept bridge transport (no CORS)
   - LIST is requested with tag=LIST (GET first, then POST fallback)
   - KP update remains tag=KP (POST)
   - Contact Developer uses tag=CONTACT (script will be updated later)
     -> This will not break anything else; it‚Äôs isolated to Help.

DEBUGGING NOTE
- I intentionally expanded multi-line comments in the JS so future debugging is easier.
- I avoided touching your already-working compute/scoring logic and bridge core,
  except where required for the new tabs + reduced submit alerts.

===============================================================================
-->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    color-scheme: light;
    --surface: rgba(255,255,255,0.9);
    --surface-strong: rgba(255,255,255,0.98);
    --outline: rgba(148,163,184,0.4);
    --muted:#475569; --text:#0f172a;
    --accent:#2563eb; --accent-dark:#1d4ed8;
    --bg-gradient:
      radial-gradient(circle at 5% 0%, rgba(59,130,246,.22), transparent 45%),
      radial-gradient(circle at 95% 0%, rgba(14,165,233,.18), transparent 40%),
      linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 55%,#f8fafc 100%);
    --shadow: 0 30px 60px -25px rgba(15,23,42,.35);
    --shadow-soft: 0 20px 50px -30px rgba(15,23,42,.35);
    --radius-lg: 26px; --radius-md:18px; --radius-sm:12px;
    --max-width:1260px;
    font-synthesis:none; text-rendering:optimizeLegibility;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--text);background:var(--bg-gradient);display:flex;flex-direction:column}
  a{color:inherit}

  .masthead{position:relative;padding:clamp(24px,5vw,42px) clamp(18px,7vw,64px) clamp(18px,4vw,28px);display:flex;flex-direction:column;gap:clamp(14px,3vw,22px);overflow:hidden}
  .masthead::before{content:"";position:absolute;inset:12% auto -20% 50%;width:clamp(240px,40vw,520px);height:clamp(240px,45vw,560px);background:radial-gradient(circle, rgba(37,99,235,.45), transparent 70%);transform:translateX(-50%) rotate(18deg);filter:blur(42px);opacity:.6}
  .masthead__inner{position:relative;z-index:1;max-width:var(--max-width);margin:0 auto;display:flex;flex-direction:column;gap:clamp(14px,3vw,18px)}
  .topline{display:flex;align-items:center;justify-content:space-between;gap:18px}
  .brand{display:flex;align-items:center;gap:16px}
  .brand__mark{width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.7));display:grid;place-items:center;color:#fff;font-family:"Plus Jakarta Sans","Inter",sans-serif;font-weight:700;font-size:20px;letter-spacing:.04em;box-shadow:var(--shadow-soft)}
  .brand__copy h1{margin:0;font-family:"Plus Jakarta Sans","Inter",sans-serif;font-size:clamp(30px,5vw,44px);font-weight:700;letter-spacing:-.02em}
  .brand__copy p{margin:6px 0 0;max-width:520px;color:var(--muted);font-size:clamp(15px,2.5vw,18px);line-height:1.6}

  /* ---------- TOP-LEVEL NAV TABS (Form / Controls / Help) ---------- */
  .main-tabs{
    display:flex;gap:10px;flex-wrap:wrap;
    padding:10px 0 0 0;
  }
  .main-tab{
    border:1px solid rgba(148,163,184,.4);
    background:rgba(255,255,255,.75);
    padding:10px 14px;border-radius:12px;
    font-weight:800;cursor:pointer;
    transition:transform .15s ease, background .15s ease;
    user-select:none;
  }
  .main-tab:hover{transform:translateY(-1px)}
  .main-tab.active{
    background:linear-gradient(135deg,#2563eb,#14a3e9);
    color:#fff;border-color:transparent;
    box-shadow:0 16px 36px -22px rgba(37,99,235,.65);
  }

  .mode-switcher{display:grid;gap:10px;align-items:start}
  .mode-pills{display:grid;grid-template-columns:1fr;gap:12px}
  .mode{position:relative;border-radius:var(--radius-md);border:1px solid transparent;padding:14px 18px;background:rgba(255,255,255,.65);color:var(--muted);font-weight:600;text-align:left;cursor:default}
  .mode.active{background:linear-gradient(135deg,#2563eb,#14a3e9);color:#fff;box-shadow:0 18px 42px -18px rgba(37,99,235,.6)}
  .mode-hint{font-size:14px;color:var(--muted)}

  .patient-mini{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--muted)}
  .mini-field{display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:rgba(255,255,255,.75);box-shadow:0 12px 28px -22px rgba(15,23,42,.45)}
  .mini-field span{font-size:16px}
  .mini-field input{border:0;background:transparent;font-size:14px;outline:none;min-width:110px}

  .workspace-wrapper{flex:1;padding:0 clamp(18px,7vw,64px) clamp(180px,12vw,220px)}
  .workspace{position:relative;z-index:1;max-width:var(--max-width);margin:0 auto;display:grid;gap:clamp(20px,4vw,36px)}
  .cards-flow{display:grid;gap:clamp(18px,3vw,28px)}
  .panel{background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--outline);padding:clamp(18px,3vw,28px);box-shadow:var(--shadow-soft);backdrop-filter:blur(14px);display:grid;gap:clamp(16px,2.5vw,26px)}
  .panel header{display:grid;gap:6px}
  .panel h2{margin:0;font-size:clamp(18px,2.7vw,22px);font-weight:800;letter-spacing:-.01em}
  .panel .hint{margin:0;color:var(--muted);font-size:13px;line-height:1.5}

  label{font-weight:700;font-size:14px;color:#1e293b;display:block;margin-bottom:6px}
  .input,select,textarea{width:100%;padding:12px 14px;border-radius:var(--radius-sm);border:1px solid rgba(148,163,184,.5);background:rgba(248,250,252,.92);font-size:15px;transition:border .2s ease,box-shadow .2s ease,background .2s ease}
  .input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.15);background:#fff}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

  .grid-2,.grid-3{display:grid;gap:18px}
  .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .grid-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

  .chip-row{display:flex;flex-wrap:wrap;gap:12px}
  .chip{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--radius-md);background:rgba(148,163,184,.14);border:1px solid transparent;font-weight:700;cursor:pointer;color:var(--muted);transition:all .2s ease}
  .chip input[type=radio]{accent-color:var(--accent)}
  .chip:hover{background:rgba(37,99,235,.1)}

  /* NOTE: These ".tab" styles are for the INTERNAL Clinical Inputs tabs (Vitals/Oxygen/Labs) */
  .tab-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:4px}
  .tab{border:1px solid rgba(148,163,184,.4);background:rgba(255,255,255,.7);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .tab.active{background:linear-gradient(135deg,#2563eb,#14a3e9);color:#fff;border-color:transparent}
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .action-dock{
    position:static;
    padding:18px clamp(18px,7vw,64px) max(env(safe-area-inset-bottom,24px),28px);
    background:rgba(255,255,255,.96);
    border-top:1px solid rgba(148,163,184,.35);
    box-shadow:0 -18px 42px -24px rgba(15,23,42,.45);
    backdrop-filter:blur(16px);
    z-index:150
  }
  .action-dock__inner{max-width:var(--max-width);margin:0 auto;display:grid;gap:12px}
  .btn{border-radius:var(--radius-md);border:1px solid transparent;padding:16px;font-weight:800;font-size:16px;cursor:pointer;transition:transform .18s ease,box-shadow .18s ease,background .18s ease}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#1e40af);color:#fff;box-shadow:0 20px 40px -18px rgba(37,99,235,.55)}
  .btn.primary:hover:not([disabled]){transform:translateY(-1px)}
  .btn.secondary{background:rgba(37,99,235,.08);color:var(--accent-dark);border:1px solid rgba(37,99,235,.18)}
  .btn.ghost{background:transparent;border:1px solid rgba(148,163,184,.35);color:var(--muted)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .incomplete-note{display:none;font-size:12px;color:#dc2626;font-weight:900}
  .incomplete-note[data-visible="true"]{display:block}

  .toast{position:fixed;right:clamp(18px,5vw,64px);bottom:clamp(120px,12vw,180px);min-width:min(360px,calc(100vw - 48px));background:#fff;border-radius:var(--radius-md);border-left:4px solid #16a34a;padding:16px 20px;box-shadow:var(--shadow);font-weight:800;color:var(--text);display:none;z-index:220}
  .toast.err{border-left-color:#dc2626;color:#dc2626}
  .toast.warn{border-left-color:#f59e0b;color:#92400e}
  .toast.center{left:50%;top:50%;transform:translate(-50%,-50%);right:auto;bottom:auto;min-width:min(460px,calc(100vw - 48px));text-align:center}

  /* ---------- DEV SETTINGS (unchanged floating modal) ---------- */
  .dev-panel,.dev-backdrop{position:fixed;inset:0;z-index:230}
  .dev-backdrop{background:rgba(15,23,42,.5);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .25s ease}
  .dev-backdrop[data-visible="true"]{opacity:1;pointer-events:auto}
  .dev-panel{display:grid;place-items:center;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .25s ease,visibility .25s ease}
  .dev-panel[aria-hidden="false"]{opacity:1;visibility:visible;pointer-events:auto}
  .dev-sheet{
    width:min(560px,calc(100vw - 48px));
    background:#0f172a;color:#f8fafc;border-radius:var(--radius-lg);
    border:1px solid rgba(148,163,184,.35);box-shadow:0 30px 80px -30px rgba(15,23,42,.8);
    padding:26px;display:grid;gap:18px;pointer-events:auto;
    max-height:min(80vh, 720px);
    overflow-y:auto;
  }
  .dev-sheet h3{margin:0;font-size:20px;font-weight:700}
  .dev-sheet .close{justify-self:end;border:0;background:rgba(148,163,184,.15);color:#e2e8f0;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:800}
  .dev-sheet label{color:#cbd5f5}
  .dev-sheet .input{background:rgba(15,23,42,.75);color:#f8fafc;border:1px solid rgba(148,163,184,.4)}
  .dev-tip{font-size:13px;color:rgba(226,232,240,.7)}

  /* ---------- RESULTS CARD ---------- */
  .results-card{
    display:none;
    background:var(--surface-strong);
    border:1px solid rgba(148,163,184,.35);
    border-radius:18px;
    box-shadow:var(--shadow);
    padding:16px 18px;
  }
  .results-card[data-visible="true"]{display:block}
  .results-title{margin:0 0 8px 0;font-weight:900}
  .results-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .metric{padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.12);font-weight:900}
  .metric small{display:block;font-weight:700;color:var(--muted)}

  /* ---------- DUP INDICATOR ---------- */
  .inline-wrap{display:flex;align-items:center;gap:8px}
  .dup-indicator{display:none;font-size:12px;color:#64748b;white-space:nowrap}
  .dup-indicator[data-state="checking"],
  .dup-indicator[data-state="none"],
  .dup-indicator[data-state="error"]{display:inline-flex;align-items:center;gap:6px}
  .spinner{width:14px;height:14px;border:2px solid rgba(37,99,235,.25);border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  body.desktop .workspace{grid-template-columns:1fr 360px;align-items:start}
  body.desktop .cards-flow{grid-template-columns:repeat(2,minmax(0,1fr))}
  body.desktop .action-dock__inner{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:899px){body.desktop .workspace{grid-template-columns:1fr}}
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
  }

  /* ---------- CONTROLS PAGE (dark themed section using prior admin styles, but embedded) ---------- */
  .controls-shell{
    background:#0f172a;color:#f8fafc;border-radius:var(--radius-lg);
    border:1px solid rgba(148,163,184,.35);box-shadow:0 30px 80px -40px rgba(15,23,42,.6);
    padding:18px;display:grid;gap:14px;
  }
  .controls-topbar{
    display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
    padding:4px 6px 0 6px;
  }
  .controls-titlewrap{display:grid;gap:2px}
  .controls-title{margin:0;font-size:20px;font-weight:900}
  .controls-sub{margin:0;font-size:12px;color:rgba(226,232,240,.72);line-height:1.35}

  .controls-gear{
    width:42px;height:42px;border-radius:50%;
    border:1px solid rgba(255,255,255,.7);
    background:rgba(15,23,42,.75);color:#e2e8f0;
    display:grid;place-items:center;cursor:pointer;
    box-shadow:0 16px 40px -20px rgba(15,23,42,.65);
    backdrop-filter:blur(12px);
    transition:transform .2s ease;
  }
  .controls-gear:hover{transform:translateY(-2px)}

  .admin-card{
    border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.35);
    border-radius:18px;
    padding:12px;
    display:grid;
    gap:10px;
  }
  .admin-card h4{margin:0;font-size:14px;font-weight:900}
  .admin-card .minihelp{margin:0;color:rgba(226,232,240,.70);font-size:12px;line-height:1.4}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(148,163,184,.10);
    font-weight:900;color:#e2e8f0;font-size:12px;
  }

  .admin-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* ‚úÖ COMPULSORY SCROLLBARS for Controls table */
  .table-wrap{
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background:rgba(2,6,23,.35);
    overflow-x: scroll;
    overflow-y: scroll;
    scrollbar-gutter: stable both-edges;
    max-height:380px;
  }
  table.admin-table{border-collapse:collapse;width:max(1400px,100%);font-size:13px}
  table.admin-table th, table.admin-table td{
    padding:10px 10px;
    border-bottom:1px solid rgba(148,163,184,.16);
    white-space:nowrap;
    text-align:left;
    vertical-align:top;
  }
  table.admin-table th{
    position:sticky;top:0;z-index:2;
    background:rgba(15,23,42,.92);
    color:#e2e8f0;
    font-weight:900;
  }

  .admin-inputs{display:grid;grid-template-columns:1fr 120px auto;gap:10px;align-items:end}
  @media (max-width:520px){ .admin-inputs{grid-template-columns:1fr;align-items:stretch} }

  .controls-shell label{color:#cbd5f5}
  .controls-shell .input{background:rgba(15,23,42,.75);color:#f8fafc;border:1px solid rgba(148,163,184,.4)}
  .controls-shell select.input{appearance:none}
  .controls-shell .btn{padding:12px 14px;font-size:14px}
  .controls-shell .btn.primary{box-shadow:none}
  .controls-shell .btn.ghost{color:#e2e8f0;border-color:rgba(148,163,184,.28)}
  .controls-shell .btn.secondary{color:#e2e8f0;background:rgba(37,99,235,.16);border-color:rgba(37,99,235,.22)}

  /* ---------- HELP PAGE FORMATTING ---------- */
  .help-section{
    border:1px solid rgba(148,163,184,.35);
    background:rgba(255,255,255,.72);
    border-radius:18px;
    padding:16px 18px;
    display:grid;gap:10px;
  }
  .help-section h3{margin:0;font-size:18px;font-weight:900}
  .help-bullets{
    margin:0;padding-left:18px;
    color:#0f172a;
    line-height:1.6;
  }
  .help-note{
    padding:12px 14px;border-radius:14px;
    background:rgba(37,99,235,.08);
    border:1px solid rgba(37,99,235,.18);
    font-weight:800;
  }
  .help-note strong{font-weight:900}
  .help-tablewrap{
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.35);
    background:rgba(255,255,255,.85);
  }
  table.help-table{border-collapse:collapse;min-width:860px;width:100%;font-size:13px}
  table.help-table th, table.help-table td{
    padding:10px 10px;border-bottom:1px solid rgba(148,163,184,.25);
    text-align:left;vertical-align:top;white-space:nowrap;
  }
  table.help-table th{position:sticky;top:0;background:#fff;font-weight:900}

  .tiny-footer{font-size:12px;color:#64748b;text-align:center;padding:8px 0 14px 0}
  .dev-credit{font-size:12px;color:#64748b;font-weight:700;margin-bottom:2px}
</style>
</head>

<body>
<noscript style="padding:12px 16px;background:#fee2e2;color:#7f1d1d;border-bottom:1px solid #fecaca;font-weight:900">
  JavaScript is required for APACHE II calculations and Google Sheets submission.
</noscript>

<header class="masthead" role="banner">
  <div class="masthead__inner">
    <div class="topline">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true">AI</div>
        <div class="brand__copy">
          <h1>APACHE II bedside console</h1>
          <p>Direct to Google Sheets. One shared sheet per month. All doctors, one source of truth.</p>
        </div>
      </div>

      <!--
        NOTE:
        - Settings icon REMOVED from header per requirement.
        - Settings gear will appear inside Controls tab page.
      -->
    </div>

    <!-- TOP-LEVEL TABS -->
    <nav class="main-tabs" aria-label="Main navigation tabs">
      <button id="mainTabForm" class="main-tab active" type="button" data-maintab="form">Form</button>
      <button id="mainTabControls" class="main-tab" type="button" data-maintab="controls">Controls</button>
      <button id="mainTabHelp" class="main-tab" type="button" data-maintab="help">Help</button>
    </nav>

    <!-- FORM-ONLY HEAD STRIP (keep your existing mode + mini patient fields) -->
    <div id="formHeaderStrip" class="mode-switcher" aria-label="Submission mode">
      <div class="dev-credit">@JSF Developer 2026</div>
      <div class="mode-pills" role="group">
        <button id="modeOnline" type="button" class="mode active" disabled>Online (Google Sheets)</button>
      </div>
      <div id="modeHint" class="mode-hint">
        Data go straight to the shared ICU Google Sheet (one tab per month). Download uses the Apps Script download endpoint.
      </div>
      <div class="patient-mini" aria-label="Quick patient entry">
        <div class="mini-field"><span>üë§</span><input id="patientNameMini" type="text" placeholder="Patient name" autocomplete="off"></div>
        <div class="mini-field"><span>üÜî</span><input id="uhidMini" type="text" placeholder="UHID" autocomplete="off"></div>
      </div>
    </div>

  </div>
</header>

<div class="workspace-wrapper">
  <main class="workspace" id="mainWorkspace">

    <!-- ==========================================================
         MAIN PANEL: FORM TAB
         ========================================================== -->
    <section id="panelForm" class="cards-flow" aria-label="Form tab content">

      <section class="panel" data-span="full" aria-labelledby="patient-h">
        <header>
          <h2 id="patient-h">Patient</h2>
          <p class="hint">Enter the patient‚Äôs full name as per hospital record and their UHID.</p>
        </header>
        <div class="grid-2">
          <div>
            <label for="patientName">Patient Name*</label>
            <input id="patientName" class="input" type="text" required placeholder="e.g., Jane Doe" autocomplete="off">
          </div>
          <div>
            <label for="uhid">
              UHID*
              <span id="dupIndicator" class="dup-indicator">
                <span class="spinner" aria-hidden="true"></span><span>Looking for duplicates‚Ä¶</span>
              </span>
            </label>
            <div class="inline-wrap">
              <input id="uhid" class="input" type="text" required placeholder="Hospital unique ID" autocomplete="off" aria-describedby="dupIndicator">
            </div>
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="demo-h">
        <header>
          <h2 id="demo-h">Demographics & Admission</h2>
          <p class="hint">Age in years, sex, ICU admission date, diagnosis. GCS is required.</p>
        </header>
        <div class="grid-3">
          <div>
            <label for="age">Age (years)*</label>
            <input id="age" class="input" type="number" min="0" max="120" step="1" required placeholder="Years">
          </div>
          <div>
            <label for="sex">Sex*</label>
            <select id="sex" class="input" required>
              <option value="" selected disabled>Select</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="admitDate">Admission Date*</label>
            <input id="admitDate" class="input" type="date" required>
          </div>
        </div>
        <div>
          <label for="diagnosis">Diagnosis*</label>
          <input id="diagnosis" class="input" type="text" required placeholder="Primary diagnosis at ICU admission">
        </div>
        <div class="grid-2">
          <div>
            <label for="gcs">GCS (3‚Äì15)*</label>
            <input id="gcs" class="input" type="number" min="3" max="15" step="1" required placeholder="e.g., 12">
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="chronic-h">
        <header>
          <h2 id="chronic-h">Chronic health</h2>
          <p class="hint">Mark severe chronic organ failure/immunocompromise. If present, specify surgical context.</p>
        </header>
        <div class="chip-row" id="chronicGrp">
          <label class="chip"><input type="radio" name="chronic" value="No" checked> No</label>
          <label class="chip"><input type="radio" name="chronic" value="Yes"> Yes ‚Äì severe organ failure / immunocompromise</label>
        </div>
        <div id="surgTypeWrap" class="grid-2" style="display:none">
          <div>
            <label>Type of surgery (if chronic = Yes)</label>
            <div class="chip-row">
              <label class="chip"><input type="radio" name="surgtype" value="Emergency" checked> Emergency</label>
              <label class="chip"><input type="radio" name="surgtype" value="Elective"> Elective</label>
              <label class="chip"><input type="radio" name="surgtype" value="Nonoperative"> Non-operative</label>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" data-span="full" aria-labelledby="inputs-h">
        <header>
          <h2 id="inputs-h">Clinical inputs</h2>
          <p class="hint">Vitals, oxygenation branch (PaO‚ÇÇ vs A‚Äìa gradient based on FiO‚ÇÇ), labs.</p>
        </header>
        <div class="tab-bar" role="tablist">
          <button class="tab active" type="button" data-tab="vitals">Vitals</button>
          <button class="tab" type="button" data-tab="oxygen">Oxygenation</button>
          <button class="tab" type="button" data-tab="labs">Labs</button>
        </div>

        <div id="tab-vitals" class="tab-panel active" role="tabpanel">
          <div class="grid-3">
            <div>
              <label for="tempF">Temperature (¬∞F)*</label>
              <input id="tempF" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label for="map">Mean Arterial Pressure (mmHg)*</label>
              <input id="map" class="input" type="number" step="1" required>
            </div>
            <div>
              <label for="hr">Heart Rate (bpm)*</label>
              <input id="hr" class="input" type="number" step="1" required>
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="rr">Respiratory Rate (breaths/min)*</label>
              <input id="rr" class="input" type="number" step="1" required>
            </div>
          </div>
        </div>

        <div id="tab-oxygen" class="tab-panel" role="tabpanel">
          <div>
            <label>FiO‚ÇÇ category*</label>
            <div class="chip-row" id="fio2Grp">
              <label class="chip"><input type="radio" name="fio2" value="<50%" checked> &lt; 50% (or non-intubated)</label>
              <label class="chip"><input type="radio" name="fio2" value=">=50%"> ‚â• 50%</label>
            </div>
          </div>

          <div id="po2Wrap">
            <label for="pao2">PaO‚ÇÇ (mmHg)*</label>
            <input id="pao2" class="input" type="number" step="1" placeholder="e.g., 80" autocomplete="off" required>
            <p class="hint">If FiO‚ÇÇ &lt; 50% ‚Üí provide PaO‚ÇÇ.</p>
          </div>

          <div id="aagradWrap" style="display:none">
            <label for="aagrad">A‚Äìa gradient (mmHg)*</label>
            <input id="aagrad" class="input" type="number" step="1" placeholder="e.g., 220" autocomplete="off">
            <p class="hint">If FiO‚ÇÇ ‚â• 50% ‚Üí provide A‚Äìa gradient.</p>
          </div>
        </div>

        <div id="tab-labs" class="tab-panel" role="tabpanel">
          <div class="grid-3">
            <div>
              <label for="ph">pH (arterial)</label>
              <input id="ph" class="input" type="number" step="0.01" min="6.8" max="7.8">
            </div>
            <div>
              <label for="hco3">HCO‚ÇÉ‚Åª (mEq/L)</label>
              <input id="hco3" class="input" type="number" step="0.1">
            </div>
            <div>
              <label for="na">Na‚Å∫ (mEq/L)*</label>
              <input id="na" class="input" type="number" step="1" required>
            </div>
          </div>
          <div class="grid-3">
            <div>
              <label for="k">K‚Å∫ (mEq/L)*</label>
              <input id="k" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label for="cr">Creatinine (mg/dL)*</label>
              <input id="cr" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label for="wbc">WBC (√ó10¬≥/mm¬≥)*</label>
              <input id="wbc" class="input" type="number" step="0.1" required>
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="hct">Hematocrit (%)*</label>
              <input id="hct" class="input" type="number" step="0.1" required>
            </div>
            <div>
              <label>Acute Renal Failure</label>
              <div class="chip-row" id="arfGrp">
                <label class="chip"><input type="radio" name="arf" value="No" checked> No</label>
                <label class="chip"><input type="radio" name="arf" value="Yes"> Yes</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" aria-labelledby="outcome-h">
        <header><h2 id="outcome-h">Outcome</h2></header>
        <div>
          <label>Mortality (Y/N)*</label>
          <div class="chip-row" role="group" aria-label="Mortality yes/no" id="mortalityGrp">
            <label class="chip"><input type="radio" name="mortality" value="Y" required> Y</label>
            <label class="chip"><input type="radio" name="mortality" value="N" required> N</label>
          </div>
        </div>
      </section>

      <aside id="resultsCard" class="results-card" aria-live="polite" aria-atomic="true">
        <h4 class="results-title">Computed Result</h4>
        <div class="results-grid">
          <div class="metric"><small>APACHE II</small><span id="resApache">‚Äî</span></div>
          <div class="metric"><small>Mortality (Non-op)</small><span id="resMortNon">‚Äî</span></div>
          <div class="metric"><small>Mortality (Post-op)</small><span id="resMortPost">‚Äî</span></div>
        </div>
      </aside>

    </section>

    <!-- ==========================================================
         MAIN PANEL: CONTROLS TAB
         ========================================================== -->
    <section id="panelControls" class="cards-flow" aria-label="Controls tab content" style="display:none">

      <section class="panel" aria-labelledby="controls-h">
        <header style="display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap">
          <div style="display:grid;gap:6px">
            <h2 id="controls-h">Sheet Controls</h2>
            <p class="hint">
              View entries for a month, refresh manually, and update mortality (KP).
              Uses local cache to avoid reloading when you switch tabs.
            </p>
          </div>

          <!-- SETTINGS ICON (moved here) -->
          <button id="devToggleControls" class="controls-gear" aria-label="Developer / Connection settings" aria-haspopup="dialog" aria-expanded="false">‚öôÔ∏è</button>
        </header>

        <div class="controls-shell" aria-label="Controls shell">

          <!-- FULL PAGE ‚ÄúQuick Admin Console‚Äù -->
          <div class="controls-topbar">
            <div class="controls-titlewrap">
              <h3 class="controls-title">Quick Admin Console</h3>
              <p class="controls-sub">Patient entries table + Update Mortality (KP). Forced scrollbars. Manual refresh.</p>
            </div>
          </div>

          <!-- ENTRIES TABLE -->
          <div class="admin-card" aria-label="Entries list block">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <div style="display:grid;gap:4px">
                <h4 style="margin:0">Entries</h4>
                <p class="minihelp">
                  Select month ‚Üí table shows stored cache if available.
                  Refresh fetches from server and overwrites cache.
                </p>
              </div>

              <div class="admin-actions">
                <label for="controlsMonth" style="margin:0;color:rgba(226,232,240,.85);font-weight:900;font-size:12px">Month</label>
                <input id="controlsMonth" class="input" type="month" style="max-width:170px;padding:10px 12px">

                <span id="controlsMonthPill" class="pill">Month: ‚Äî</span>

                <span id="controlsLoadSpinner" class="pill" style="display:none">
                  <span class="spinner" aria-hidden="true"></span> Loading‚Ä¶
                </span>

                <button id="btnControlsRefresh" class="btn ghost" type="button" style="padding:10px 12px">Refresh</button>
              </div>
            </div>

            <div class="table-wrap" aria-label="Entries table container">
              <table class="admin-table" aria-label="Entries table">
              <thead>
  <tr>
    <th style="width:180px">UHID</th>
    <th style="min-width:260px">Patient Name</th>
    <th style="width:80px">Age</th>
    <th style="width:90px">Sex</th>
    <th style="width:140px">Admission</th>
    <th style="min-width:320px">Diagnosis</th>
    <th style="width:120px">APACHE II</th>
    <th style="width:160px">Pred Mortality</th>
    <th style="width:110px">Mortality Y/N</th>
  </tr>
</thead>

                <tbody id="controlsEntriesTbody">
                  <tr><td colspan="9" style="color:rgba(226,232,240,.75);font-weight:900">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <span id="controlsCountPill" class="pill">Rows: ‚Äî</span>
              <span class="pill" id="controlsCachePill">Cache: ‚Äî</span>
            </div>
          </div>

          <!-- UPDATE MORTALITY (KP) -->
          <div class="admin-card" aria-label="Update mortality block">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <div style="display:grid;gap:4px">
                <h4 style="margin:0">Update Mortality</h4>
                <p class="minihelp">Queue UHID + Y/N. Update sends KP in two batches (Y then N) if mixed.</p>
              </div>
              <span class="pill" id="adminQueuePill">Queued: 0</span>
            </div>

            <div class="admin-inputs">
              <div>
                <label for="kpUhid">UHID</label>
                <input id="kpUhid" class="input" type="text" placeholder="Enter UHID" autocomplete="off">
              </div>
              <div>
                <label for="kpYN">Y/N</label>
                <select id="kpYN" class="input">
                  <option value="Y" selected>Y</option>
                  <option value="N">N</option>
                </select>
              </div>
              <div>
                <button id="btnKpAdd" class="btn secondary" type="button" style="padding:12px 14px">Add</button>
              </div>
            </div>

            <div class="table-wrap" aria-label="KP queue table container" style="max-height:240px">
              <table class="admin-table" aria-label="KP queue table">
                <thead>
                  <tr>
                    <th style="width:200px">UHID</th>
                    <th style="width:90px">Y/N</th>
                    <th style="min-width:220px">Action</th>
                  </tr>
                </thead>
                <tbody id="kpQueueTbody">
                  <tr><td colspan="3" style="color:rgba(226,232,240,.75);font-weight:900">No entries yet.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="admin-actions" style="justify-content:space-between">
              <button id="btnKpClear" class="btn ghost" type="button" style="padding:10px 12px">Clear</button>
              <button id="btnKpUpdate" class="btn primary" type="button" disabled style="padding:12px 14px">Update</button>
            </div>
          </div>

        </div>
      </section>
    </section>

    <!-- ==========================================================
         MAIN PANEL: HELP TAB
         ========================================================== -->
    <section id="panelHelp" class="cards-flow" aria-label="Help tab content" style="display:none">

      <section class="panel" aria-labelledby="help-h">
        <header>
          <h2 id="help-h">Help</h2>
          <p class="hint">Method, instructions, and contact developer.</p>
        </header>

        <!-- SECTION 1: METHOD -->
        <div class="help-section">
          <h3>Method of Apache Calculation</h3>
          <div class="help-note">
            This app uses a standard APACHE II point binning approach.
            Oxygenation uses <strong>PaO‚ÇÇ when FiO‚ÇÇ &lt; 50%</strong> and <strong>A‚Äìa gradient when FiO‚ÇÇ ‚â• 50%</strong>.
            For acid‚Äìbase: <strong>pH is preferred if present</strong>, else HCO‚ÇÉ‚Åª is used.
          </div>

          <div class="help-tablewrap" aria-label="APACHE scoring table container">
            <table class="help-table" aria-label="APACHE scoring table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Ranges ‚Üí Points</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Temperature (¬∞C)</td><td>
                  ‚â•41 ‚Üí 4 ‚Ä¢ 39‚Äì40.9 ‚Üí 3 ‚Ä¢ 38.5‚Äì38.9 ‚Üí 1 ‚Ä¢ 36‚Äì38.4 ‚Üí 0 ‚Ä¢ 34‚Äì35.9 ‚Üí 1 ‚Ä¢ 32‚Äì33.9 ‚Üí 2 ‚Ä¢ 30‚Äì31.9 ‚Üí 3 ‚Ä¢ &lt;30 ‚Üí 4
                </td></tr>
                <tr><td>MAP (mmHg)</td><td>
                  ‚â•160 ‚Üí 4 ‚Ä¢ 130‚Äì159 ‚Üí 3 ‚Ä¢ 110‚Äì129 ‚Üí 2 ‚Ä¢ 70‚Äì109 ‚Üí 0 ‚Ä¢ 50‚Äì69 ‚Üí 2 ‚Ä¢ &lt;50 ‚Üí 4
                </td></tr>
                <tr><td>Heart Rate (bpm)</td><td>
                  ‚â•180 ‚Üí 4 ‚Ä¢ 140‚Äì179 ‚Üí 3 ‚Ä¢ 110‚Äì139 ‚Üí 2 ‚Ä¢ 70‚Äì109 ‚Üí 0 ‚Ä¢ 55‚Äì69 ‚Üí 2 ‚Ä¢ 40‚Äì54 ‚Üí 3 ‚Ä¢ &lt;40 ‚Üí 4
                </td></tr>
                <tr><td>Respiratory Rate (/min)</td><td>
                  ‚â•50 ‚Üí 4 ‚Ä¢ 35‚Äì49 ‚Üí 3 ‚Ä¢ 25‚Äì34 ‚Üí 1 ‚Ä¢ 12‚Äì24 ‚Üí 0 ‚Ä¢ 10‚Äì11 ‚Üí 1 ‚Ä¢ 6‚Äì9 ‚Üí 2 ‚Ä¢ &lt;6 ‚Üí 4
                </td></tr>
                <tr><td>Oxygenation</td><td>
                  If FiO‚ÇÇ ‚â• 50%: A‚Äìa ‚â•500 ‚Üí 4 ‚Ä¢ 350‚Äì499 ‚Üí 3 ‚Ä¢ 200‚Äì349 ‚Üí 2 ‚Ä¢ &lt;200 ‚Üí 0<br>
                  If FiO‚ÇÇ &lt; 50%: PaO‚ÇÇ &gt;70 ‚Üí 0 ‚Ä¢ 61‚Äì70 ‚Üí 1 ‚Ä¢ 55‚Äì60 ‚Üí 3 ‚Ä¢ &lt;55 ‚Üí 4
                </td></tr>
                <tr><td>pH</td><td>
                  ‚â•7.70 ‚Üí 4 ‚Ä¢ 7.60‚Äì7.69 ‚Üí 3 ‚Ä¢ 7.50‚Äì7.59 ‚Üí 1 ‚Ä¢ 7.33‚Äì7.49 ‚Üí 0 ‚Ä¢ 7.25‚Äì7.32 ‚Üí 2 ‚Ä¢ 7.15‚Äì7.24 ‚Üí 3 ‚Ä¢ &lt;7.15 ‚Üí 4
                </td></tr>
                <tr><td>HCO‚ÇÉ‚Åª (mEq/L) (used only if pH missing)</td><td>
                  ‚â•52 ‚Üí 4 ‚Ä¢ 41‚Äì51.9 ‚Üí 3 ‚Ä¢ 32‚Äì40.9 ‚Üí 1 ‚Ä¢ 22‚Äì31.9 ‚Üí 0 ‚Ä¢ 18‚Äì21.9 ‚Üí 2 ‚Ä¢ 15‚Äì17.9 ‚Üí 3 ‚Ä¢ &lt;15 ‚Üí 4
                </td></tr>
                <tr><td>Na‚Å∫ (mEq/L)</td><td>
                  ‚â•180 ‚Üí 4 ‚Ä¢ 160‚Äì179 ‚Üí 3 ‚Ä¢ 155‚Äì159 ‚Üí 2 ‚Ä¢ 150‚Äì154 ‚Üí 1 ‚Ä¢ 130‚Äì149 ‚Üí 0 ‚Ä¢ 120‚Äì129 ‚Üí 2 ‚Ä¢ 111‚Äì119 ‚Üí 3 ‚Ä¢ &lt;111 ‚Üí 4
                </td></tr>
                <tr><td>K‚Å∫ (mEq/L)</td><td>
                  ‚â•7.0 ‚Üí 4 ‚Ä¢ 6.0‚Äì6.9 ‚Üí 3 ‚Ä¢ 5.5‚Äì5.9 ‚Üí 1 ‚Ä¢ 3.5‚Äì5.4 ‚Üí 0 ‚Ä¢ 3.0‚Äì3.4 ‚Üí 1 ‚Ä¢ 2.5‚Äì2.9 ‚Üí 2 ‚Ä¢ &lt;2.5 ‚Üí 4
                </td></tr>
                <tr><td>Creatinine (mg/dL)</td><td>
                  ‚â•3.5 ‚Üí 4 ‚Ä¢ 2.0‚Äì3.4 ‚Üí 3 ‚Ä¢ 1.5‚Äì1.9 ‚Üí 2 ‚Ä¢ 0.6‚Äì1.4 ‚Üí 0 ‚Ä¢ &lt;0.6 ‚Üí 2<br>
                  Acute renal failure = Yes ‚Üí points are doubled
                </td></tr>
                <tr><td>Hematocrit (%)</td><td>
                  ‚â•60 ‚Üí 4 ‚Ä¢ 50‚Äì59.9 ‚Üí 2 ‚Ä¢ 46‚Äì49.9 ‚Üí 1 ‚Ä¢ 30‚Äì45.9 ‚Üí 0 ‚Ä¢ 20‚Äì29.9 ‚Üí 2 ‚Ä¢ &lt;20 ‚Üí 4
                </td></tr>
                <tr><td>WBC (√ó10¬≥/mm¬≥)</td><td>
                  ‚â•40 ‚Üí 4 ‚Ä¢ 20‚Äì39.9 ‚Üí 2 ‚Ä¢ 15‚Äì19.9 ‚Üí 1 ‚Ä¢ 3‚Äì14.9 ‚Üí 0 ‚Ä¢ 1‚Äì2.9 ‚Üí 2 ‚Ä¢ &lt;1 ‚Üí 4
                </td></tr>
                <tr><td>GCS</td><td>Points = 15 ‚àí GCS</td></tr>
                <tr><td>Age points</td><td>
                  ‚â§44 ‚Üí 0 ‚Ä¢ 45‚Äì54 ‚Üí 2 ‚Ä¢ 55‚Äì64 ‚Üí 3 ‚Ä¢ 65‚Äì74 ‚Üí 5 ‚Ä¢ ‚â•75 ‚Üí 6
                </td></tr>
                <tr><td>Chronic health points</td><td>
                  If chronic = No ‚Üí 0<br>
                  If chronic = Yes and surgery = Elective ‚Üí 2<br>
                  If chronic = Yes and surgery = Emergency / Non-operative ‚Üí 5
                </td></tr>
                <tr><td>Mortality bands (display)</td><td>
                  0‚Äì4 ‚Üí 4% / 1% ‚Ä¢ 5‚Äì9 ‚Üí 8% / 3% ‚Ä¢ 10‚Äì14 ‚Üí 15% / 7% ‚Ä¢ 15‚Äì19 ‚Üí 25% / 12% ‚Ä¢
                  20‚Äì24 ‚Üí 40% / 30% ‚Ä¢ 25‚Äì29 ‚Üí 55% / 35% ‚Ä¢ 30‚Äì34 ‚Üí 73% / 73% ‚Ä¢ ‚â•35 ‚Üí 85% / 88%
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- SECTION 2: HOW TO FILL -->
        <div class="help-section">
          <h3>How to Fill the Form</h3>
          <ul class="help-bullets">
            <li>Open <strong>Form</strong> tab.</li>
            <li>Fill Patient details (Name, UHID, Age, Sex, Admission Date, Diagnosis, GCS).</li>
            <li>Enter Clinical inputs (Vitals, Oxygenation, Labs).</li>
            <li>Choose Mortality Y/N.</li>
            <li>Scroll down and click <strong>Submit to Google Sheets</strong>.</li>
          </ul>
          <div class="help-note">
            <strong>Important:</strong> On clicking submit, the data is just sent to the server ‚Äî it does NOT guarantee an Excel entry yet.
          </div>
          <ul class="help-bullets">
            <li>If the server actually inserts the row into the monthly sheet, you will see: <strong>Successfully submitted to Google Sheets ‚úÖ</strong></li>
            <li>If something fails (network, secret, script error), you will see an error message.</li>
          </ul>
        </div>

        <!-- SECTION 3: CONTROLS -->
        <div class="help-section">
          <h3>Controls</h3>
          <ul class="help-bullets">
            <li>Open <strong>Controls</strong> tab to view the month‚Äôs entries.</li>
            <li>Use the <strong>Month selector</strong> to switch months.</li>
            <li><strong>Refresh</strong> is manual ‚Äî if you want the Excel to refresh here, you must click <strong>Refresh</strong>.</li>
          </ul>

          <div class="help-note">
            Mortality Update (KP) steps:
            <br>‚û§ Enter UHID
            <br>‚û§ Select Y or N
            <br>‚û§ Click <strong>Add</strong> (it goes to the queue)
            <br>‚û§ Repeat for multiple UHIDs
            <br>‚û§ Click <strong>Update</strong> and <strong>WAIT</strong>
          </div>

          <ul class="help-bullets">
            <li>If you switch tabs and come back, the entries table will show cached data (fast).</li>
            <li>Only <strong>Refresh</strong> forces reloading from the server.</li>
          </ul>
        </div>

        <!-- SECTION 4: CONTACT DEVELOPER -->
        <div class="help-section">
          <h3>Contact Developer</h3>
          <p class="hint" style="margin:0">
            If you have a suggestion or an issue, write down your query below and click submit.
          </p>

          <div class="grid-2">
            <div>
              <label for="contactName">Your Name</label>
              <input id="contactName" class="input" type="text" placeholder="e.g., Dr. X">
            </div>
            <div>
              <label for="contactClientId">Client ID (optional)</label>
              <input id="contactClientId" class="input" type="text" placeholder="Defaults to device Client ID">
            </div>
          </div>

          <div>
            <label for="contactMsg">Your Message</label>
            <textarea id="contactMsg" class="input" rows="6" style="resize:vertical" placeholder="Type your issue / suggestion here..."></textarea>
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button id="btnContactSubmit" class="btn primary" type="button" style="padding:12px 14px">Submit</button>
            <span id="contactStatus" class="hint" style="margin:0"></span>
          </div>

          <div class="help-note" style="background:rgba(148,163,184,.10);border-color:rgba(148,163,184,.30)">
            Note: Contact Developer requires a script update (tag=CONTACT). If the script is not updated yet, you may see an error.
          </div>
        </div>

      </section>
    </section>

  </main>
</div>

<!-- ACTION DOCK (FORM ONLY) -->
<div id="actionDock" class="action-dock" role="contentinfo">
  <div class="action-dock__inner">
    <div id="incompleteNote" class="incomplete-note" aria-live="polite">Form incomplete: please fill all required items.</div>
    <button id="btnDownload" class="btn ghost" type="button">Download current month</button>
    <button id="btnSubmit" class="btn primary" type="button" disabled>Submit to Google Sheets</button>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="toastCenter" class="toast center warn" role="status" aria-live="assertive"></div>

<!-- DEV MODAL (UNCHANGED) -->
<div id="devBackdrop" class="dev-backdrop" aria-hidden="true"></div>
<div id="devPanel" class="dev-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="devTitle">
  <div class="dev-sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
      <h3 id="devTitle">Developer / Connection</h3>
      <button id="devClose" class="close" type="button">Close</button>
    </div>
    <p class="dev-tip">Values persist per device. Leave blank to fall back to defaults (hardcoded in this HTML).</p>
    <div>
      <label for="onlineUrl">Online Webhook URL</label>
      <input id="onlineUrl" class="input" type="url" placeholder="https://script.google.com/.../exec">
    </div>
    <div>
      <label for="onlineSecret">Online Secret</label>
      <input id="onlineSecret" class="input" type="text" placeholder="Shared secret for Sheets webhook">
    </div>
    <div>
      <label for="clientId">Client ID</label>
      <input id="clientId" class="input" type="text" value="NURSING-STATION-01">
    </div>

    <div style="border-top:1px solid rgba(148,163,184,.35);padding-top:12px">
      <h3 style="margin:0 0 8px 0;font-size:16px">Debug &amp; Tools</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnBuildPreview" class="btn secondary" type="button">Build &amp; show payload</button>
        <button id="btnCopyPreview" class="btn ghost" type="button">Copy JSON</button>
        <button id="btnCopyExcelRow" class="btn ghost" type="button" disabled>Copy APACHE row (Excel)</button>
        <button id="btnDummyFill" class="btn secondary" type="button">Dummy fill</button>
      </div>
      <pre id="debugPreview" style="margin-top:10px;max-height:260px;overflow:auto;border-radius:8px;border:1px solid rgba(148,163,184,.35);padding:12px;background:#081225;color:#e2e8f0;font:13px ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">No payload yet</pre>

      <h3 style="margin:8px 0;font-size:16px">Last server response</h3>
      <pre id="lastResp" style="max-height:180px;overflow:auto;border-radius:8px;border:1px solid rgba(148,163,184,.35);padding:12px;background:#081225;color:#e2e8f0;font:13px ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">None</pre>
    </div>
    <div class="dev-tip">The app is locked to Online (Google Sheets) mode.</div>
  </div>
</div>

<div class="tiny-footer">¬© @ JSFDev</div>

<script>
/* =============================================================================
   DOM helpers
   ============================================================================= */
const $ = (id) => document.getElementById(id);

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, ch => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[ch]));
}

function valStr(id){
  const el=$(id);
  if(!el) return null;
  const v=(el.value||'').trim();
  return v===''?null:v;
}

function valNum(id){
  const el=$(id);
  if(!el) return null;
  const raw=(el.value||'').trim();
  if(raw==='') return null;
  const n = Number(raw);
  return Number.isFinite(n) ? n : null;
}

function radioVal(name){
  const el=document.querySelector('input[name="'+name+'"]:checked');
  return el?el.value:null;
}

function todayISO(){
  const d=new Date();
  const off=d.getTimezoneOffset();
  const k=new Date(d.getTime()-off*60000);
  return k.toISOString().slice(0,10);
}

function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

/* =============================================================================
   Toasts
   ============================================================================= */
function toast(msg, ok=true, klass=''){
  const t=$('toast');
  t.textContent=msg;
  t.className='toast'+(ok?'':' err')+(klass?(' '+klass):'');
  t.style.display='block';
  clearTimeout(toast._timer);
  toast._timer=setTimeout(()=>{ t.style.display='none'; }, 5200);
}

/* Center toast exists (used by duplicate checker etc). Submit flow no longer uses it. */
function toastCenter(msg){
  const t=$('toastCenter');
  t.textContent=msg;
  t.style.display='block';
  clearTimeout(toastCenter._timer);
  toastCenter._timer=setTimeout(()=>{ t.style.display='none'; }, 5200);
}

/* =============================================================================
   Desktop detection
   ============================================================================= */
function detectDesktop(){
  const ua=navigator.userAgent||"";
  const looksDesktop=/(Macintosh|Windows|Linux)/i.test(ua)&&!/(Mobile|Tablet|Android)/i.test(ua);
  const pointerFine=matchMedia('(pointer: fine)').matches;
  const wideEnough=matchMedia('(min-width:1024px)').matches;
  return looksDesktop||(pointerFine&&wideEnough);
}
function applyDesktopClass(){ document.body.classList.toggle('desktop', detectDesktop()); }
applyDesktopClass();
addEventListener('resize', ()=>{ clearTimeout(applyDesktopClass._timer); applyDesktopClass._timer=setTimeout(applyDesktopClass,180); });

/* =============================================================================
   MAIN TOP-LEVEL TAB SYSTEM (Form / Controls / Help)
   - Requirement:
     - Form selected by default
     - Controls shows full-page admin console
     - Help shows instructions page
   ============================================================================= */
const MAIN_TABS = [
  { key:'form', btn:'mainTabForm', panel:'panelForm' },
  { key:'controls', btn:'mainTabControls', panel:'panelControls' },
  { key:'help', btn:'mainTabHelp', panel:'panelHelp' }
];

let CURRENT_MAIN_TAB = 'form';

function setMainTab(key){
  const next = String(key||'form');
  CURRENT_MAIN_TAB = next;

  // toggle buttons + panels
  for(const t of MAIN_TABS){
    const b = $(t.btn);
    const p = $(t.panel);
    const on = (t.key === next);
    if(b) b.classList.toggle('active', on);
    if(p) p.style.display = on ? '' : 'none';
  }

  // Form-only header strip + action dock:
  const formStrip = $('formHeaderStrip');
  const dock = $('actionDock');
  if(formStrip) formStrip.style.display = (next === 'form') ? '' : 'none';
  if(dock) dock.style.display = (next === 'form') ? '' : 'none';

  // When entering Controls:
  if(next === 'controls'){
    controlsOnEnter();
  }
}

MAIN_TABS.forEach(t=>{
  $(t.btn)?.addEventListener('click', ()=>setMainTab(t.key));
});

/* =============================================================================
   Mini <-> Main sync (kept same)
   ============================================================================= */
['patientName','uhid'].forEach((id)=>{
  const main=$(id); if(!main) return;
  main.addEventListener('input',()=>{
    const mini=$(id+'Mini');
    if(mini && mini.value!==main.value) mini.value=main.value;
    scheduleCompute();
  });
});
['patientNameMini','uhidMini'].forEach((id)=>{
  const mini=$(id); if(!mini) return;
  mini.addEventListener('input',()=>{
    const main=$(id.replace('Mini',''));
    if(main && main.value!==mini.value) main.value=mini.value;
    scheduleCompute();
  });
});

/* =============================================================================
   ‚úÖ HARD-CODED DEFAULTS (ALWAYS AVAILABLE)
   ============================================================================= */
const ONLINE_WEBHOOK_URL =
  'https://script.google.com/macros/s/AKfycbywkECpffrqsV5wCfzTYQyX6oZT9iWRhkwlVZrTAHAwCOuGDFpE66AiedZHd77qu_88/exec';

const ONLINE_SECRET =
  'F8p^7m2bUqW!c4Z9Lh3@r6N0';

/* =============================================================================
   DEV / CONNECTION OVERRIDES (OPTIONAL ONLY)
   ============================================================================= */
function saveDevOverrides(){
  const overrides={
    onlineUrl:$('onlineUrl')?.value.trim()||'',
    onlineSecret:$('onlineSecret')?.value.trim()||'',
    clientId:$('clientId')?.value.trim()||'NURSING-STATION-01'
  };
  try{ localStorage.setItem('apacheMobileDev', JSON.stringify(overrides)); }catch(_){}
}

function loadDevOverrides(){
  try{
    const raw=localStorage.getItem('apacheMobileDev');
    const o = raw ? JSON.parse(raw) : {};
    if($('onlineUrl')) $('onlineUrl').value = (o.onlineUrl && o.onlineUrl.trim()) ? o.onlineUrl.trim() : ONLINE_WEBHOOK_URL;
    if($('onlineSecret')) $('onlineSecret').value = (o.onlineSecret && o.onlineSecret.trim()) ? o.onlineSecret.trim() : ONLINE_SECRET;
    if($('clientId')) $('clientId').value = (o.clientId && o.clientId.trim()) ? o.clientId.trim() : 'NURSING-STATION-01';
  }catch(_){
    if($('onlineUrl')) $('onlineUrl').value = ONLINE_WEBHOOK_URL;
    if($('onlineSecret')) $('onlineSecret').value = ONLINE_SECRET;
    if($('clientId')) $('clientId').value = 'NURSING-STATION-01';
  }
}

function currentConn(){
  // ALWAYS start from defaults; overrides are optional, only if non-empty.
  let url = ONLINE_WEBHOOK_URL;
  let secret = ONLINE_SECRET;
  let clientId = 'NURSING-STATION-01';

  try{
    const raw = localStorage.getItem('apacheMobileDev');
    if(raw){
      const o = JSON.parse(raw);
      if(o.clientId && o.clientId.trim()) clientId = o.clientId.trim();
      if(o.onlineUrl && o.onlineUrl.trim()) url = o.onlineUrl.trim();
      if(o.onlineSecret && o.onlineSecret.trim()) secret = o.onlineSecret.trim();
    }
  }catch(_){}

  return { url, secret, clientId };
}

/* Google Apps Script links sometimes come as /dev instead of /exec */
function sanitizeExecUrl(u){
  try{
    const x=new URL(u);
    x.pathname = x.pathname.replace(/\/dev(\/)?$/i,'/exec');
    x.pathname = x.pathname.replace(/\/+$/,'');
    return x.toString();
  }catch(_){
    return u;
  }
}

/* Preconnect to the Apps Script ORIGIN */
function ensurePreconnectForUrl(u){
  try{
    const origin = new URL(sanitizeExecUrl(u)).origin;
    const ensure = (rel) => {
      if(document.querySelector('link[rel="'+rel+'"][href="'+origin+'"]')) return;
      const l=document.createElement('link');
      l.rel=rel; l.href=origin;
      document.head.appendChild(l);
    };
    ensure('dns-prefetch');
    ensure('preconnect');
  }catch(_){}
}

/* =============================================================================
   DEV MODAL: Open/Close (UNCHANGED)
   ============================================================================= */
const devPanel=$('devPanel'), devBackdrop=$('devBackdrop'), devClose=$('devClose');
devPanel?.setAttribute('aria-hidden','true'); devBackdrop?.setAttribute('data-visible','false');

function setDevPanel(open){
  if(!devPanel || !devBackdrop) return;
  const wasOpen=devPanel.getAttribute('aria-hidden')==='false';
  devPanel.setAttribute('aria-hidden', open?'false':'true');
  devBackdrop.setAttribute('data-visible', open?'true':'false');
  devBackdrop.setAttribute('aria-hidden', open?'false':'true');

  if(wasOpen && !open){
    // Save on close and warm preconnect for new url
    saveDevOverrides();
    const { url } = currentConn();
    ensurePreconnectForUrl(url);
  }
}
devClose?.addEventListener('click',()=>setDevPanel(false));
devBackdrop?.addEventListener('click',()=>setDevPanel(false));

/* Settings gear now lives in Controls tab */
$('devToggleControls')?.addEventListener('click', ()=>{
  setDevPanel(true);
});

/* ESC to close dev panel */
addEventListener('keydown',(ev)=>{
  if(ev.key!=='Escape') return;
  if(devPanel && devPanel.getAttribute('aria-hidden')==='false'){ setDevPanel(false); return; }
});

/* Dev URL live warm-up */
$('onlineUrl')?.addEventListener('change', ()=>{
  try{
    const u = $('onlineUrl').value.trim();
    if(u) ensurePreconnectForUrl(u);
  }catch(_){}
});

/* =============================================================================
   Chronic toggle + Oxygen toggle + INTERNAL tabs
   ============================================================================= */
$('chronicGrp')?.addEventListener('change',()=>{
  $('surgTypeWrap').style.display = (radioVal('chronic')==='Yes') ? 'grid' : 'none';
  scheduleCompute();
});

function updateOxygenUI(){
  const v = radioVal('fio2');
  const po2=$('po2Wrap'), aagrad=$('aagradWrap'), pao2El=$('pao2'), aagradEl=$('aagrad');
  if(!po2 || !aagrad) return;

  if(v === '<50%'){
    po2.style.display='block'; aagrad.style.display='none';
    if(aagradEl){ aagradEl.value=''; aagradEl.removeAttribute('required'); }
    if(pao2El){ pao2El.setAttribute('required','required'); }
  } else {
    po2.style.display='none'; aagrad.style.display='block';
    if(pao2El){ pao2El.value=''; pao2El.removeAttribute('required'); }
    if(aagradEl){ aagradEl.setAttribute('required','required'); }
  }
}
document.querySelectorAll('input[name="fio2"]').forEach(r=>r.addEventListener('change',()=>{ updateOxygenUI(); scheduleCompute(); }));

document.querySelectorAll('.tab').forEach((btn)=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach((b)=>b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach((p)=>p.classList.remove('active'));
    btn.classList.add('active');
    const target=$('tab-'+btn.dataset.tab);
    if(target) target.classList.add('active');
  });
});

/* =============================================================================
   APACHE II scoring ‚Äî binning (UNCHANGED)
   ============================================================================= */
function fToC(f){ return (f-32)*(5/9); }
function ptsTempC(c){
  if(c==null) return 0;
  if(c>=41) return 4;
  if(c>=39 && c<41) return 3;
  if(c>=38.5 && c<39) return 1;
  if(c>=36 && c<38.5) return 0;
  if(c>=34 && c<36) return 1;
  if(c>=32 && c<34) return 2;
  if(c>=30 && c<32) return 3;
  return 4;
}
function ptsMAP(v){
  if(v==null) return 0;
  if(v>=160) return 4;
  if(v>=130) return 3;
  if(v>=110) return 2;
  if(v>=70)  return 0;
  if(v>=50)  return 2;
  return 4;
}
function ptsHR(v){
  if(v==null) return 0;
  if(v>=180) return 4;
  if(v>=140) return 3;
  if(v>=110) return 2;
  if(v>=70)  return 0;
  if(v>=55)  return 2;
  if(v>=40)  return 3;
  return 4;
}
function ptsRR(v){
  if(v==null) return 0;
  if(v>=50) return 4;
  if(v>=35) return 3;
  if(v>=25) return 1;
  if(v>=12) return 0;
  if(v>=10) return 1;
  if(v>=6)  return 2;
  return 4;
}
function ptsOxygen(fio2Cat,pao2,aagrad){
  if(fio2Cat==='>=50%'){
    if(aagrad==null) return 0;
    if(aagrad>=500) return 4;
    if(aagrad>=350) return 3;
    if(aagrad>=200) return 2;
    return 0;
  } else {
    if(pao2==null) return 0;
    if(pao2>70)    return 0;
    if(pao2>=61)   return 1;
    if(pao2>=55)   return 3;
    return 4;
  }
}
function ptsPH(ph){
  if(ph==null) return 0;
  if(ph>=7.70) return 4;
  if(ph>=7.60) return 3;
  if(ph>=7.50) return 1;
  if(ph>=7.33) return 0;
  if(ph>=7.25) return 2;
  if(ph>=7.15) return 3;
  return 4;
}
function ptsHCO3(h){
  if(h==null) return 0;
  if(h>=52) return 4;
  if(h>=41) return 3;
  if(h>=32) return 1;
  if(h>=22) return 0;
  if(h>=18) return 2;
  if(h>=15) return 3;
  return 4;
}
function acidBasePoints(ph, hco3){
  if(ph!=null) return ptsPH(ph);
  if(hco3!=null) return ptsHCO3(hco3);
  return 0;
}
function ptsNa(v){
  if(v==null) return 0;
  if(v>=180) return 4;
  if(v>=160) return 3;
  if(v>=155) return 2;
  if(v>=150) return 1;
  if(v>=130) return 0;
  if(v>=120) return 2;
  if(v>=111) return 3;
  return 4;
}
function ptsK(v){
  if(v==null) return 0;
  if(v>=7.0) return 4;
  if(v>=6.0) return 3;
  if(v>=5.5) return 1;
  if(v>=3.5) return 0;
  if(v>=3.0) return 1;
  if(v>=2.5) return 2;
  return 4;
}
function ptsCreatinine(v,arf){
  if(v==null) return 0;
  let pts=0;
  if(v>=3.5) pts=4;
  else if(v>=2.0) pts=3;
  else if(v>=1.5) pts=2;
  else if(v<0.6) pts=2;
  else pts=0;
  if(arf) pts*=2;
  return pts;
}
function ptsHct(v){
  if(v==null) return 0;
  if(v>=60) return 4;
  if(v>=50) return 2;
  if(v>=46) return 1;
  if(v>=30) return 0;
  if(v>=20) return 2;
  return 4;
}
function ptsWBC(v){
  if(v==null) return 0;
  if(v>=40) return 4;
  if(v>=20) return 2;
  if(v>=15) return 1;
  if(v>=3)  return 0;
  if(v>=1)  return 2;
  return 4;
}
function ptsGCS(g){ if(g==null) return 0; const diff=15-g; return diff<0?0:diff; }
function agePoints(age){
  if(age==null) return 0;
  if(age<=44) return 0;
  if(age<=54) return 2;
  if(age<=64) return 3;
  if(age<=74) return 5;
  return 6;
}
function chronicPoints(chronic,surgtype){
  if(chronic!=='Yes') return 0;
  if(surgtype==='Elective') return 2;
  return 5;
}
function mortalityBands(score){
  const s = Number(score||0);
  if(s<=4)  return { nonop:4,  postop:1 };
  if(s<=9)  return { nonop:8,  postop:3 };
  if(s<=14) return { nonop:15, postop:7 };
  if(s<=19) return { nonop:25, postop:12 };
  if(s<=24) return { nonop:40, postop:30 };
  if(s<=29) return { nonop:55, postop:35 };
  if(s<=34) return { nonop:73, postop:73 };
  return { nonop:85, postop:88 };
}

/* =============================================================================
   FAST COMPUTE PIPELINE (debounce + cache) (UNCHANGED)
   ============================================================================= */
function istMonthYYYYMM(){
  try{
    const d = new Date();
    const y = d.toLocaleString('en-CA', { timeZone:'Asia/Kolkata', year:'numeric' });
    const m = d.toLocaleString('en-CA', { timeZone:'Asia/Kolkata', month:'2-digit' });
    return y + "-" + m;
  }catch(_){
    return (new Date().toISOString()).slice(0,7);
  }
}

function validateLight(){
  const patientName = valStr('patientName');
  const uhid = valStr('uhid');
  const diagnosis = valStr('diagnosis');
  const admitDate = valStr('admitDate');
  const sex = $('sex')?.value || '';

  const age = valNum('age');
  const gcs = valNum('gcs');
  const tempF = valNum('tempF');
  const map = valNum('map');
  const hr = valNum('hr');
  const rr = valNum('rr');
  const na = valNum('na');
  const k = valNum('k');
  const cr = valNum('cr');
  const wbc = valNum('wbc');
  const hct = valNum('hct');

  const fio2 = radioVal('fio2');
  const mortYN = radioVal('mortality');

  if(!patientName || !uhid || !diagnosis || !admitDate) return { ok:false, why:'Missing required identity/admission fields' };
  if(!sex) return { ok:false, why:'Sex required' };
  if(age==null || gcs==null) return { ok:false, why:'Age/GCS required' };
  if(tempF==null || map==null || hr==null || rr==null) return { ok:false, why:'Vitals incomplete' };
  if(na==null || k==null || cr==null || wbc==null || hct==null) return { ok:false, why:'Labs incomplete' };
  if(!fio2) return { ok:false, why:'FiO2 required' };
  if(!mortYN) return { ok:false, why:'Mortality Y/N required' };

  if(fio2 === '<50%'){
    const pao2 = valNum('pao2');
    if(pao2==null) return { ok:false, why:'PaO2 required for FiO2 <50%' };
  }else{
    const aagrad = valNum('aagrad');
    if(aagrad==null) return { ok:false, why:'A-a gradient required for FiO2 >=50%' };
  }

  const phVal = valNum('ph');
  const hco3Val = valNum('hco3');
  if(phVal==null && hco3Val==null) return { ok:false, why:'pH or HCO3 required' };

  return { ok:true };
}

function computeApacheFast(snap){
  const tempC = snap.tempF!=null ? fToC(snap.tempF) : null;

  const aps = ptsTempC(tempC)+
              ptsMAP(snap.map)+
              ptsHR(snap.hr)+
              ptsRR(snap.rr)+
              ptsOxygen(snap.fio2, snap.pao2, snap.aagrad)+
              acidBasePoints(snap.phVal, snap.hco3Val)+
              ptsNa(snap.na)+
              ptsK(snap.k)+
              ptsCreatinine(snap.cr, snap.arf)+
              ptsHct(snap.hct)+
              ptsWBC(snap.wbc)+
              ptsGCS(snap.gcs);

  const agePts = agePoints(snap.age);
  const chronicPts = chronicPoints(snap.chronic, snap.surgtype);
  const apacheII = aps + agePts + chronicPts;

  const mort = mortalityBands(apacheII);
  return { apacheII, mortNon: mort.nonop, mortPost: mort.postop };
}

function snapshotInputsForCompute(){
  const age = valNum('age');
  const fio2 = radioVal('fio2');
  const tempF = valNum('tempF');
  const map = valNum('map');
  const hr = valNum('hr');
  const rr = valNum('rr');
  const pao2 = fio2 === '<50%' ? valNum('pao2') : null;
  const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;

  const phVal = valNum('ph');
  const hco3Val = valNum('hco3');

  const na = valNum('na');
  const k = valNum('k');
  const cr = valNum('cr');
  const wbc = valNum('wbc');
  const hct = valNum('hct');

  const gcs = valNum('gcs');
  const arf = (radioVal('arf')==='Yes');
  const chronic = radioVal('chronic')==='Yes' ? 'Yes' : 'No';
  const surgtype = chronic==='Yes' ? radioVal('surgtype') : null;

  return { age, fio2, tempF, map, hr, rr, pao2, aagrad, phVal, hco3Val, na, k, cr, wbc, hct, gcs, arf, chronic, surgtype };
}

function signatureKey(s){
  return [
    s.age, s.fio2, s.tempF, s.map, s.hr, s.rr, s.pao2, s.aagrad,
    s.phVal, s.hco3Val, s.na, s.k, s.cr, s.wbc, s.hct, s.gcs,
    s.arf?1:0, s.chronic, s.surgtype||''
  ].join('|');
}

let COMPUTE_CACHE = { key:null, value:null };

function computeCached(){
  const snap = snapshotInputsForCompute();
  const key = signatureKey(snap);
  if(COMPUTE_CACHE.key === key && COMPUTE_CACHE.value) return COMPUTE_CACHE.value;
  const out = computeApacheFast(snap);
  COMPUTE_CACHE = { key, value: out };
  return out;
}

let computeTimer = null;
function scheduleCompute(){
  clearTimeout(computeTimer);
  computeTimer = setTimeout(runComputeAndUI, 120);
}

function runComputeAndUI(){
  const v = validateLight();
  const submit = $('btnSubmit');
  const note = $('incompleteNote');
  const card = $('resultsCard');

  if(!v.ok){
    if(submit) submit.disabled = true;
    if(note) note.setAttribute('data-visible','true');
    if(card) card.setAttribute('data-visible','false');
    if($('btnCopyExcelRow')) $('btnCopyExcelRow').disabled = true;
    return;
  }

  if(submit) submit.disabled = false;
  if(note) note.setAttribute('data-visible','false');

  const res = computeCached();
  $('resApache').textContent = String(res.apacheII) + ' pts';
  $('resMortNon').textContent = String(res.mortNon) + '%';
  $('resMortPost').textContent = String(res.mortPost) + '%';
  if(card) card.setAttribute('data-visible','true');
  if($('btnCopyExcelRow')) $('btnCopyExcelRow').disabled = false;
}

function attachFastListeners(){
  const ids = [
    'patientName','uhid','age','sex','admitDate','diagnosis','gcs',
    'tempF','map','hr','rr','pao2','aagrad','ph','hco3','na','k','cr','wbc','hct'
  ];
  ids.forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener('input', scheduleCompute, { passive:true });
    el.addEventListener('change', scheduleCompute, { passive:true });
  });

  const radioNames = ['fio2','arf','chronic','surgtype','mortality'];
  radioNames.forEach(n=>{
    document.querySelectorAll('input[name="'+n+'"]').forEach(r=>{
      r.addEventListener('change', scheduleCompute, { passive:true });
    });
  });
}

/* =============================================================================
   Strict payload builder (sheetRow) (UNCHANGED)
   ============================================================================= */
function buildPayloadStrict(){
  const patientName=valStr('patientName');
  const uhid=valStr('uhid');
  const age=valNum('age');
  const sexSel=$('sex'); const sex=sexSel?sexSel.value:'';
  const diagnosis=valStr('diagnosis');
  const admitDate=valStr('admitDate');
  const fio2=radioVal('fio2');
  const mortYN=radioVal('mortality');

  if(!patientName) throw new Error('Patient Name is required');
  if(!uhid) throw new Error('UHID is required');
  if(age===null) throw new Error('Age is required');
  if(!sex) throw new Error('Sex is required');
  if(!diagnosis) throw new Error('Diagnosis is required');
  if(!admitDate) throw new Error('Admission Date is required');
  if(!fio2) throw new Error('FiO‚ÇÇ category is required');
  if(!mortYN) throw new Error('Mortality (Y/N) is required');

  const chronic=radioVal('chronic');
  const surgtype=chronic==='Yes' ? radioVal('surgtype') : null;

  const tempF = valNum('tempF'); if(tempF===null) throw new Error('Temperature is required');
  const map   = valNum('map');   if(map===null)   throw new Error('MAP is required');
  const hr    = valNum('hr');    if(hr===null)    throw new Error('Heart Rate is required');
  const rr    = valNum('rr');    if(rr===null)    throw new Error('Respiratory Rate is required');

  const pao2 = fio2 === '<50%' ? valNum('pao2') : null;
  const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;
  if(fio2 === '<50%' && pao2===null) throw new Error('PaO‚ÇÇ is required when FiO‚ÇÇ < 50%');
  if(fio2 !== '<50%' && aagrad===null) throw new Error('A‚Äìa gradient is required when FiO‚ÇÇ ‚â• 50%');

  const phVal = valNum('ph');
  const hco3Val = valNum('hco3');
  if(phVal===null && hco3Val===null) throw new Error('Provide arterial pH or HCO‚ÇÉ‚Åª');

  const na = valNum('na'); if(na===null) throw new Error('Sodium is required');
  const k  = valNum('k');  if(k===null)  throw new Error('Potassium is required');
  const cr = valNum('cr'); if(cr===null) throw new Error('Creatinine is required');
  const wbc= valNum('wbc');if(wbc===null)throw new Error('WBC is required');
  const hct= valNum('hct');if(hct===null)throw new Error('Hematocrit is required');

  const gcs = valNum('gcs'); if(gcs===null) throw new Error('GCS is required');
  const arf = (radioVal('arf')==='Yes');

  const { apacheII, mortNon, mortPost } = computeApacheFast({
    age, fio2, tempF, map, hr, rr, pao2, aagrad, phVal, hco3Val,
    na, k, cr, wbc, hct, gcs,
    arf,
    chronic: chronic==='Yes' ? 'Yes' : 'No',
    surgtype
  });

  const selectedMortality = (surgtype==='Emergency' || surgtype==='Elective') ? mortPost : mortNon;

  // ‚úÖ EXACT row order expected by your Apps Script
  const sheetRow=[ uhid, patientName, age, sex, diagnosis, admitDate, apacheII, selectedMortality, mortYN ];
  return { sheetRow };
}

/* =============================================================================
   BRIDGE TRANSPORT (NO CORS)
   - This is the core trick: iframe+postMessage back to this page.
   - DO NOT break it. We keep it, and only adjust submit-stage messaging.
   ============================================================================= */
const __bridgeInflight = new Map();

window.addEventListener("message", (ev) => {
  const msg = ev && ev.data;
  if (!msg || msg.__APACHE_BRIDGE__ !== true) return;

  const cb = String(msg.cb || "");
  const inflight = __bridgeInflight.get(cb);
  if (!inflight) return;

  clearTimeout(inflight.hardTo);
  clearTimeout(inflight.softTo1);
  clearTimeout(inflight.softTo2);

  __bridgeInflight.delete(cb);
  try { inflight.iframe.remove(); } catch(_) {}
  try { inflight.resolve(msg.data); } catch(_) {}
});

function bridgeCancel(cb){
  const inflight = __bridgeInflight.get(cb);
  if(!inflight) return;
  clearTimeout(inflight.hardTo);
  clearTimeout(inflight.softTo1);
  clearTimeout(inflight.softTo2);
  __bridgeInflight.delete(cb);
  try { inflight.iframe.remove(); } catch(_) {}
  try { inflight.reject(new Error("Canceled")); } catch(_) {}
}

function bridgeGet(execUrl, params, opts){
  const cb = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  const url = new URL(execUrl);
  Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));
  url.searchParams.set("bridge","1");
  url.searchParams.set("cb", cb);
  url.searchParams.set("origin", location.origin);

  const iframe = document.createElement("iframe");
  iframe.style.display = "none";
  iframe.src = url.toString();
  document.body.appendChild(iframe);

  const hardTimeoutMs = (opts && opts.hardTimeoutMs) ? opts.hardTimeoutMs : 20000;
  const soft1 = (opts && opts.soft1Ms) ? opts.soft1Ms : 1600;
  const soft2 = (opts && opts.soft2Ms) ? opts.soft2Ms : 12000;
  const soft1Msg = (opts && opts.soft1Msg) ? opts.soft1Msg : null;
  const soft2Msg = (opts && opts.soft2Msg) ? opts.soft2Msg : null;

  const p = new Promise((resolve, reject) => {
    const softTo1 = setTimeout(() => { if(soft1Msg) toastCenter(soft1Msg); }, soft1);
    const softTo2 = setTimeout(() => { if(soft2Msg) toastCenter(soft2Msg); }, soft2);

    const hardTo = setTimeout(() => {
      __bridgeInflight.delete(cb);
      try { iframe.remove(); } catch(_) {}
      reject(new Error("Bridge GET timeout"));
    }, hardTimeoutMs);

    __bridgeInflight.set(cb, { resolve, reject, hardTo, softTo1, softTo2, iframe });
  });
  p._cb = cb;
  return p;
}

function bridgePost(execUrl, jsonPayload, opts){
  const cb = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  const url = new URL(execUrl);
  url.searchParams.set("bridge","1");
  url.searchParams.set("cb", cb);
  url.searchParams.set("origin", location.origin);

  const iframe = document.createElement("iframe");
  iframe.name = "apacheBridge_" + cb;
  iframe.style.display = "none";
  document.body.appendChild(iframe);

  const form = document.createElement("form");
  form.method = "POST";
  form.action = url.toString();
  form.target = iframe.name;

  const inp = document.createElement("input");
  inp.type = "hidden";
  inp.name = "json";
  inp.value = JSON.stringify(jsonPayload || {});
  form.appendChild(inp);

  document.body.appendChild(form);
  form.submit();
  form.remove();

  const hardTimeoutMs = (opts && opts.hardTimeoutMs) ? opts.hardTimeoutMs : 25000;
  const soft1 = (opts && opts.soft1Ms) ? opts.soft1Ms : 1600;
  const soft2 = (opts && opts.soft2Ms) ? opts.soft2Ms : 15000;
  const soft1Msg = (opts && opts.soft1Msg) ? opts.soft1Msg : null;
  const soft2Msg = (opts && opts.soft2Msg) ? opts.soft2Msg : null;

  const p = new Promise((resolve, reject) => {
    const softTo1 = setTimeout(() => { if(soft1Msg) toastCenter(soft1Msg); }, soft1);
    const softTo2 = setTimeout(() => { if(soft2Msg) toastCenter(soft2Msg); }, soft2);

    const hardTo = setTimeout(() => {
      __bridgeInflight.delete(cb);
      try { iframe.remove(); } catch(_) {}
      reject(new Error("Bridge POST timeout"));
    }, hardTimeoutMs);

    __bridgeInflight.set(cb, { resolve, reject, hardTo, softTo1, softTo2, iframe });
  });
  p._cb = cb;
  return p;
}

/* =============================================================================
   Response helpers
   ============================================================================= */
function isOkish(data){
  if(!data) return false;
  if(data.ok === true) return true;
  if(data.success === true) return true;
  if(String(data.status||'').toLowerCase() === 'ok') return true;
  if(String(data.result||'').toLowerCase() === 'ok') return true;
  return false;
}

/* =============================================================================
   ‚úÖ SUBMIT (changed UX: only ‚ÄúSent To Server‚Ä¶‚Äù then success/error)
   ============================================================================= */
async function postOnline(sheetRow){
  const { url, secret } = currentConn();
  const execUrl = sanitizeExecUrl(url);

  const payload = {
    authToken: secret,
    auth: secret,
    month: istMonthYYYYMM(),
    sheetRow: sheetRow
  };

  /* IMPORTANT:
     - We intentionally do NOT pass soft1Msg / soft2Msg here,
       because you asked: no intermediate alerts.
     - Hard timeout remains long to tolerate Apps Script slowness.
  */
  const data = await bridgePost(execUrl, payload, {
    hardTimeoutMs: 75000,
    soft1Msg: null,
    soft2Msg: null
  });

  if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);

  if(!isOkish(data)){
    const detail = data && (data.error || data.message || JSON.stringify(data).slice(0,200));
    throw new Error('Sheets webhook did not confirm success' + (detail?': '+detail:''));
  }
  return data;
}

$('btnSubmit')?.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const button=$('btnSubmit');
  button.disabled=true;

  try{
    // Save overrides (does NOT break defaults when empty)
    saveDevOverrides();

    const { sheetRow } = buildPayloadStrict();

    // ‚úÖ Only message on click (per requirement)
    toast('Sent to Server ‚Ä¶');

    // Wait for server confirmation (no intermediate messages)
    await postOnline(sheetRow);

    // ‚úÖ Server-confirmed success
    toast('Successfully submitted to Google Sheets ‚úÖ');
    scheduleCompute();
  }catch(e){
    if($('lastResp')) $('lastResp').textContent = (e && e.message) ? e.message : String(e);
    toast('Submission failed: '+(e && e.message ? e.message : String(e)), false);
  }finally{
    scheduleCompute();
  }
});

/* =============================================================================
   Download current month (unchanged)
   ============================================================================= */
function downloadCurrentMonth(){
  const { url, secret } = currentConn();
  const ym = istMonthYYYYMM();
  const execUrl = sanitizeExecUrl(url);

  const qs = new URLSearchParams({
    action:'download',
    month: ym,
    auth: secret,
    authToken: secret
  }).toString();

  const full = execUrl + (execUrl.includes('?')?'&':'?') + qs;
  try{
    window.open(full, '_blank', 'noopener');
    toast('Download opened ‚úÖ');
  }catch(_){
    toast('Download could not open (popup blocked).', false);
  }
}
$('btnDownload')?.addEventListener('click', downloadCurrentMonth);

/* =============================================================================
   Dev tools (preview/copy/dummy) (unchanged)
   ============================================================================= */
$('btnBuildPreview')?.addEventListener('click', ()=>{
  try{
    const { sheetRow } = buildPayloadStrict();
    const { secret } = currentConn();
    const payload = { authToken: secret, auth: secret, month: istMonthYYYYMM(), sheetRow };
    $('debugPreview').textContent = JSON.stringify(payload, null, 2);
    toast('Payload built');
  }catch(e){
    $('debugPreview').textContent = 'Error: '+e.message;
    toast(e.message, false);
  }
});

$('btnCopyPreview')?.addEventListener('click', ()=>{
  try{ navigator.clipboard.writeText($('debugPreview').textContent||''); toast('Copied JSON'); }
  catch(_){ toast('Copy failed', false); }
});

$('btnCopyExcelRow')?.addEventListener('click', ()=>{
  try{
    const { sheetRow } = buildPayloadStrict();
    navigator.clipboard.writeText(sheetRow.join('\t'));
    toast('Row copied (tab-separated). Paste into Excel/Sheets.');
  }catch(e){
    toast('Copy failed: '+(e && e.message ? e.message : String(e)), false);
  }
});

function dummyFill(){
  const age = randInt(45,70);
  $('patientName').value = 'Jane Doe';
  $('patientNameMini').value = 'Jane Doe';
  $('uhid').value = '2010' + String(randInt(1000,9999));
  $('uhidMini').value = $('uhid').value;

  $('age').value = String(age);
  $('sex').value = 'Female';
  $('admitDate').value = todayISO();
  $('diagnosis').value = 'CKD on HTN; CAP; on oxygen';

  $('tempF').value = '99.1';
  $('map').value = '78';
  $('hr').value = '96';
  $('rr').value = '22';
  $('gcs').value = '14';

  document.querySelector('input[name="fio2"][value="<50%"]').checked = true;
  updateOxygenUI();
  $('pao2').value = '72';
  $('aagrad').value = '';

  $('ph').value = '7.36';
  $('hco3').value = '22';
  $('na').value = '138';
  $('k').value = '4.8';
  $('cr').value = '2.6';
  $('wbc').value = '13.2';
  $('hct').value = '33';

  document.querySelector('input[name="arf"][value="Yes"]').checked = true;

  document.querySelector('input[name="chronic"][value="Yes"]').checked = true;
  $('surgTypeWrap').style.display = 'grid';
  document.querySelector('input[name="surgtype"][value="Nonoperative"]').checked = true;

  document.querySelector('input[name="mortality"][value="N"]').checked = true;

  toast('Dummy data filled');
  scheduleCompute();
}
$('btnDummyFill')?.addEventListener('click', ()=>{ try{ dummyFill(); }catch(e){ toast('Dummy fill failed: '+e.message, false); } });

/* =============================================================================
   Duplicate-check ‚Äî bridge GET (unchanged)
   ============================================================================= */
let dupInflightCb = null;
const dupEl = $('dupIndicator');

function setDupStatus(state, text){
  if(!dupEl) return;
  dupEl.dataset.state = state || '';
  if(state === 'checking'){
    dupEl.innerHTML = '<span class="spinner" aria-hidden="true"></span><span>'+(text||'Looking for duplicates‚Ä¶')+'</span>';
    dupEl.style.display = 'inline-flex';
  }else if(state === 'none'){
    dupEl.innerHTML = '<span>‚úì</span><span>'+(text||'No duplicates')+'</span>';
    dupEl.style.display = 'inline-flex';
    setTimeout(()=>{ dupEl.style.display='none'; }, 1600);
  }else if(state === 'error'){
    dupEl.innerHTML = '<span>!</span><span>'+(text||'Check failed')+'</span>';
    dupEl.style.display = 'inline-flex';
    setTimeout(()=>{ dupEl.style.display='none'; }, 2000);
  }else{
    dupEl.style.display='none';
  }
}

function bothFilled(){
  const name = valStr('patientName');
  const uhid = valStr('uhid');
  return !!(name && uhid);
}

function looksDuplicate(data){
  if(!data) return false;
  if(data.tag === 'duplicate_entry') return true;
  if(data.duplicate === true) return true;
  if(data.isDuplicate === true) return true;
  if((data.matches|0) > 0) return true;
  if(Array.isArray(data.matches) && data.matches.length>0) return true;
  if(Array.isArray(data.duplicates) && data.duplicates.length>0) return true;
  return false;
}

async function checkDuplicateNow(){
  const name = valStr('patientName');
  const uhid = valStr('uhid');
  if(!name || !uhid) return;

  const { url, secret } = currentConn();
  const execUrl = sanitizeExecUrl(url);
  const ym = istMonthYYYYMM();

  if(dupInflightCb){
    bridgeCancel(dupInflightCb);
    dupInflightCb = null;
  }

  setDupStatus('checking', 'Looking for duplicates‚Ä¶');

  try{
    const p = bridgeGet(execUrl, {
      action:'check',
      uhid: String(uhid).trim(),
      patientName: String(name).trim(),
      name: String(name).trim(),
      month: ym,
      auth: secret,
      authToken: secret
    }, {
      hardTimeoutMs: 22000,
      soft1Msg: null,
      soft2Msg: null
    });
    dupInflightCb = p._cb;

    const data = await p;
    dupInflightCb = null;

    if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);

    if(looksDuplicate(data)){
      setDupStatus('', '');
      toastCenter('Possible duplicate entry found!');
    }else{
      setDupStatus('none','No duplicates');
    }
  }catch(e){
    if(String(e?.message||'').toLowerCase().includes('canceled')) return;
    setDupStatus('error','Check failed');
  }
}

function onBlurTrigger(){ if(bothFilled()) checkDuplicateNow(); }
function onFocusCancel(){
  if(dupInflightCb){
    bridgeCancel(dupInflightCb);
    dupInflightCb = null;
  }
  setDupStatus('', '');
}
['patientName','uhid','patientNameMini','uhidMini'].forEach(id=>{
  const el=$(id);
  if(!el) return;
  el.addEventListener('focus', onFocusCancel, true);
  el.addEventListener('blur', onBlurTrigger, true);
});

/* =============================================================================
   CONTROLS TAB: LIST entries + local cache + manual refresh
   =============================================================================

   Requirements met:
   - Month selector + refresh button above table
   - Forced scrollbars on table container
   - First time Controls tab opened:
       - If cached data for selected month exists -> show it immediately
       - Else fetch from server
   - Switching Form -> Controls -> Form -> Controls:
       - Does NOT auto-fetch again; shows cached until Refresh is clicked
   - Refresh button:
       - Forces fetch from server and overwrites cache

   Cache keys:
   - apacheControlsCache::<YYYY-MM>
   - Contains { ts, month, entries: [...] }

   Entry normalization:
   - Because Apps Script can return various shapes, we robustly normalize:
       - root.entries / root.rows / root.patients / root.list / root.items
       - array-of-arrays or array-of-objects
   ============================================================================= */

const controlsMonthInput = $('controlsMonth');
const controlsMonthPill = $('controlsMonthPill');
const controlsLoadSpinner = $('controlsLoadSpinner');
const controlsEntriesTbody = $('controlsEntriesTbody');
const controlsEntriesTheadRow = $('controlsEntriesTheadRow');
const controlsCountPill = $('controlsCountPill');
const controlsCachePill = $('controlsCachePill');
const btnControlsRefresh = $('btnControlsRefresh');

let CONTROLS_LOADED_ONCE = false;

function cacheKeyForMonth(month){
  return 'apacheControlsCache::' + String(month||'').trim();
}

function controlsShowSpinner(on){
  if(!controlsLoadSpinner) return;
  controlsLoadSpinner.style.display = on ? '' : 'none';
}

function controlsSetCachePill(text){
  if(controlsCachePill) controlsCachePill.textContent = text;
}

function controlsSetCountPill(n){
  if(controlsCountPill) controlsCountPill.textContent = 'Rows: ' + (Number.isFinite(n) ? n : '‚Äî');
}

function readControlsCache(month){
  try{
    const raw = localStorage.getItem(cacheKeyForMonth(month));
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !Array.isArray(obj.entries)) return null;
    return obj;
  }catch(_){
    return null;
  }
}

function writeControlsCache(month, entries){
  try{
    const payload = { ts: Date.now(), month, entries: Array.isArray(entries)?entries:[] };
    localStorage.setItem(cacheKeyForMonth(month), JSON.stringify(payload));
    return true;
  }catch(_){
    return false;
  }
}

function fmtISTMonthForInput(yyyyMm){
  // input type=month expects YYYY-MM
  return String(yyyyMm||'').slice(0,7);
}

/* Robust conversion:
   - if object has fields with different naming, map to canonical keys.
*/
function pick(obj, keys){
  for(const k of keys){
    if(obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return obj[k];
  }
  return null;
}

function normalizeEntriesFromListResponse(data){
  const root = data?.data ?? data ?? {};
  let patients = root.patients ?? root.rows ?? root.list ?? root.items ?? [];
  if(!Array.isArray(patients)) patients = [];

  const out = [];
  for(const item of patients){
    // If script returns arrays (row style)
    if(Array.isArray(item)){
      // EXPECTED (example): [uhid, name, age, sex, admitDate, diagnosis, apache, predictedMortality, mortYN, ...]
      out.push({
        uhid: item[0] ?? '',
        name: item[1] ?? '',
        age: item[2] ?? '',
        sex: item[3] ?? '',
        admitDate: item[4] ?? '',
        diagnosis: item[5] ?? '',
        apache: item[6] ?? '',
        predictedMortality: item[7] ?? '',
        mortalityYN: item[8] ?? ''
      });
      continue;
    }

    // If script returns objects
    if(item && typeof item === 'object'){
      out.push({
        uhid: item.uhid ?? item.UHID ?? item.id ?? '',
        name: item.name ?? item.patientName ?? item.PatientName ?? '',
        age: item.age ?? item.Age ?? '',
        sex: item.sex ?? item.Sex ?? '',
        admitDate: item.admitDate ?? item.admissionDate ?? item.AdmissionDate ?? '',
        diagnosis: item.diagnosis ?? item.Diagnosis ?? '',
        apache: item.apache ?? item.apacheII ?? item.APACHE ?? item.APACHEII ?? '',
        predictedMortality: item.predictedMortality ?? item.predMort ?? item.PredMortality ?? '',
        mortalityYN: item.mortalityYN ?? item.mortality ?? item.Mortality ?? ''
      });
    }
  }

  return out.filter(x => String(x.uhid ?? '').trim() || String(x.name ?? '').trim());
}



/* Define preferred columns in display order.
   - If you later expand script fields, you can extend this list.
*/
const CONTROLS_COLUMNS = [
  { key:'uhid', label:'UHID' },
  { key:'patientName', label:'Patient Name' },
  { key:'age', label:'Age' },
  { key:'sex', label:'Sex' },
  { key:'admitDate', label:'Admission Date' },
  { key:'diagnosis', label:'Diagnosis' },
  { key:'apacheII', label:'APACHE II' },
  { key:'predictedMortality', label:'Pred Mortality (%)' },
  { key:'mortalityYN', label:'Mortality (Y/N)' }
];

function renderControlsHeader(){
  if(!controlsEntriesTheadRow) return;
  controlsEntriesTheadRow.innerHTML = CONTROLS_COLUMNS.map(c => '<th>'+escapeHtml(c.label)+'</th>').join('');
}

function renderControlsTable(entries){

  if(!adminPatientsTbody) return;
  if(!patients || patients.length===0){
    adminPatientsTbody.innerHTML =
      '<tr><td colspan="9" style="color:rgba(226,232,240,.75);font-weight:700">No entries found for this month.</td></tr>';
    return;
  }

  let html = '';
  for(const p of patients){
    const u = escapeHtml(p.uhid||'');
    const n = escapeHtml(p.name||'');
    const age = escapeHtml(p.age||'');
    const sex = escapeHtml(p.sex||'');
    const ad = escapeHtml(p.admitDate||'');
    const dx = escapeHtml(p.diagnosis||'');
    const ap = escapeHtml(p.apache||'');
    const pm = escapeHtml(p.predictedMortality||'');
    const yn = escapeHtml(p.mortalityYN||'');

    html += '<tr>'
      + '<td style="font-weight:800;color:#e2e8f0">'+u+'</td>'
      + '<td style="color:rgba(226,232,240,.92)">'+n+'</td>'
      + '<td>'+age+'</td>'
      + '<td>'+sex+'</td>'
      + '<td>'+ad+'</td>'
      + '<td>'+dx+'</td>'
      + '<td style="font-weight:900">'+ap+'</td>'
      + '<td style="font-weight:900">'+pm+'</td>'
      + '<td style="font-weight:900">'+yn+'</td>'
      + '</tr>';
  }
  adminPatientsTbody.innerHTML = html;
}

async function listEntriesViaGet(execUrl, secret, month, limit, offset){
  // Script style: doGet?tag=LIST&month=...&limit=...&offset=...&auth=...
  return bridgeGet(execUrl, {
    tag:'LIST',
    month: month,
    limit: String(limit||500),
    offset: String(offset||0),
    auth: secret,
    authToken: secret
  }, {
    hardTimeoutMs: 25000,
    soft1Msg: null,
    soft2Msg: null
  });
}

async function listEntriesViaPost(execUrl, secret, month, limit, offset){
  const payload = {
    tag:'LIST',
    month: month,
    limit: Number(limit||500),
    offset: Number(offset||0),
    authToken: secret,
    auth: secret
  };
  return bridgePost(execUrl, payload, {
    hardTimeoutMs: 30000,
    soft1Msg: null,
    soft2Msg: null
  });
}

async function fetchControlsEntries(month){
  const m = String(month||'').trim();
  if(!m) throw new Error('Month missing');

  const { url, secret } = currentConn();
  const execUrl = sanitizeExecUrl(url);

  let offset = 0;
  const limit = 500;
  let all = [];
  let mode = null;

  while(true){
    let data = null;

    if(!mode){
      try{
        data = await listEntriesViaGet(execUrl, secret, m, limit, offset);
        mode = 'GET';
      }catch(_e){
        data = await listEntriesViaPost(execUrl, secret, m, limit, offset);
        mode = 'POST';
      }
    }else if(mode === 'GET'){
      data = await listEntriesViaGet(execUrl, secret, m, limit, offset);
    }else{
      data = await listEntriesViaPost(execUrl, secret, m, limit, offset);
    }

    if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);

    if(!isOkish(data)){
      const detail = data && (data.error || data.message || JSON.stringify(data).slice(0,220));
      throw new Error('LIST did not confirm ok' + (detail?': '+detail:''));
    }

    const chunk = normalizeEntriesFromListResponse(data);
    all = all.concat(chunk);

    if(chunk.length < limit) break;
    offset += limit;
    if(offset > 20000) break; // safety
  }

  // de-dup by UHID (keep first)
  const seen = new Set();
  const dedup = [];
  for(const r of all){
    const u = String(r.uhid||'').trim();
    const k = u || (String(r.patientName||'').trim());
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    dedup.push(r);
  }
  return dedup;
}

function setControlsMonthUI(month){
  const m = fmtISTMonthForInput(month);
  if(controlsMonthPill) controlsMonthPill.textContent = 'Month: ' + m;
  if(controlsMonthInput && controlsMonthInput.value !== m) controlsMonthInput.value = m;
}

async function controlsLoadMonth(month, forceFetch){
  const m = fmtISTMonthForInput(month);
  setControlsMonthUI(m);

  // show cached immediately if allowed and present
  if(!forceFetch){
    const cached = readControlsCache(m);
    if(cached && Array.isArray(cached.entries)){
      renderControlsHeader();
      renderControlsTable(cached.entries);
      const dt = new Date(cached.ts || Date.now());
      controlsSetCachePill('Cache: ' + dt.toLocaleString());
      return;
    }
  }

  // no cache OR forced fetch
  controlsShowSpinner(true);
  controlsSetCachePill('Cache: fetching‚Ä¶');
  renderControlsHeader();
  if(controlsEntriesTbody){
    controlsEntriesTbody.innerHTML =
      '<tr><td colspan="'+CONTROLS_COLUMNS.length+'" style="color:rgba(226,232,240,.75);font-weight:900">Loading‚Ä¶</td></tr>';
  }

  try{
    const entries = await fetchControlsEntries(m);
    renderControlsHeader();
    renderControlsTable(entries);

    const ok = writeControlsCache(m, entries);
    controlsSetCachePill(ok ? 'Cache: updated just now' : 'Cache: update failed');
  }catch(e){
    renderControlsHeader();
    renderControlsTable([]);
    controlsSetCachePill('Cache: error');
    toast('Controls LIST failed: ' + (e?.message || String(e)), false);
  }finally{
    controlsShowSpinner(false);
  }
}

function controlsOnEnter(){
  // Called each time Controls tab is opened.
  // Requirement: do NOT refetch if already loaded; show cached.
  const m = controlsMonthInput?.value ? fmtISTMonthForInput(controlsMonthInput.value) : istMonthYYYYMM();
  setControlsMonthUI(m);

  if(!CONTROLS_LOADED_ONCE){
    CONTROLS_LOADED_ONCE = true;
    // On first entry, load from cache if exists else fetch
    controlsLoadMonth(m, false).catch(()=>{});
  }else{
    // On later entries, just show cache (if exists). Do NOT fetch.
    controlsLoadMonth(m, false).catch(()=>{});
  }
}

/* Month selector: when changed, show cache if available; else fetch */
controlsMonthInput?.addEventListener('change', ()=>{
  const m = fmtISTMonthForInput(controlsMonthInput.value);
  controlsLoadMonth(m, false).catch(()=>{});
});

/* Refresh: always fetch from server and overwrite cache */
btnControlsRefresh?.addEventListener('click', ()=>{
  const m = controlsMonthInput?.value ? fmtISTMonthForInput(controlsMonthInput.value) : istMonthYYYYMM();
  controlsLoadMonth(m, true).catch(()=>{});
});

/* =============================================================================
   CONTROLS: KP queue + Update (same logic, just moved out of overlay)
   ============================================================================= */
const kpUhid=$('kpUhid'), kpYN=$('kpYN'), btnKpAdd=$('btnKpAdd'), btnKpUpdate=$('btnKpUpdate'), btnKpClear=$('btnKpClear');
const kpQueueTbody=$('kpQueueTbody');
const adminQueuePill=$('adminQueuePill');

let KP_QUEUE = []; // [{uhid, yn}]
function normalizeUhid(u){ return String(u||'').trim(); }

function kpQueueSet(next){
  KP_QUEUE = Array.isArray(next) ? next : [];
  renderKpQueue();
}

function renderKpQueue(){
  const n = KP_QUEUE.length;
  if(adminQueuePill) adminQueuePill.textContent = 'Queued: '+n;
  if(btnKpUpdate) btnKpUpdate.disabled = (n===0);

  if(!kpQueueTbody) return;
  if(n===0){
    kpQueueTbody.innerHTML = '<tr><td colspan="3" style="color:rgba(226,232,240,.75);font-weight:900">No entries yet.</td></tr>';
    return;
  }

  let html = '';
  for(let i=0;i<n;i++){
    const item = KP_QUEUE[i];
    const u = escapeHtml(item.uhid||'');
    const yn = escapeHtml(item.yn||'Y');
    html += '<tr>' +
      '<td style="font-weight:900;color:#e2e8f0">'+u+'</td>' +
      '<td style="font-weight:900">'+yn+'</td>' +
      '<td><button class="btn ghost" type="button" style="padding:8px 10px;font-size:12px" data-kp-remove="'+i+'">Remove</button></td>' +
      '</tr>';
  }
  kpQueueTbody.innerHTML = html;

  kpQueueTbody.querySelectorAll('button[data-kp-remove]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = Number(btn.getAttribute('data-kp-remove'));
      if(Number.isFinite(idx)){
        KP_QUEUE.splice(idx,1);
        renderKpQueue();
      }
    });
  });
}

function kpAdd(){
  const u = normalizeUhid(kpUhid?.value);
  const ynRaw = String(kpYN?.value || 'Y').trim().toUpperCase();
  const yn = (ynRaw === 'N') ? 'N' : 'Y';

  if(!u){
    toast('Enter UHID', false);
    return;
  }

  // de-dupe: overwrite existing UHID
  const existing = KP_QUEUE.findIndex(x => String(x.uhid).trim() === u);
  if(existing >= 0) KP_QUEUE.splice(existing, 1);

  KP_QUEUE.push({ uhid:u, yn:yn });
  kpUhid.value = '';
  kpUhid.focus();
  renderKpQueue();
}

btnKpAdd?.addEventListener('click', kpAdd);
kpUhid?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); kpAdd(); }
});

btnKpClear?.addEventListener('click', ()=>{
  kpQueueSet([]);
  toast('Queue cleared');
});

async function doKPCall(uhids, yn){
  const { url, secret } = currentConn();
  const execUrl = sanitizeExecUrl(url);

  const payload = {
    tag: 'KP',
    uhids: Array.isArray(uhids) ? uhids : String(uhids||''),
    mortality: String(yn||'Y').toUpperCase(),
    authToken: secret,
    auth: secret
  };

  const data = await bridgePost(execUrl, payload, {
    hardTimeoutMs: 45000,
    soft1Msg: null,
    soft2Msg: null
  });

  if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);
  if(!isOkish(data)){
    const detail = data && (data.error || data.message || JSON.stringify(data).slice(0,220));
    throw new Error('KP did not confirm ok' + (detail?': '+detail:''));
  }
  return data;
}

btnKpUpdate?.addEventListener('click', async ()=>{
  if(KP_QUEUE.length === 0) return;

  btnKpUpdate.disabled = true;
  btnKpAdd.disabled = true;
  btnKpClear.disabled = true;

  try{
    saveDevOverrides();

    const ys = KP_QUEUE.filter(x=>x.yn==='Y').map(x=>x.uhid);
    const ns = KP_QUEUE.filter(x=>x.yn==='N').map(x=>x.uhid);

    toast('Updating mortality‚Ä¶');

    if(ys.length) await doKPCall(ys, 'Y');
    if(ns.length) await doKPCall(ns, 'N');

    toast('Mortality updated ‚úÖ');
    kpQueueSet([]);

    // Optional: refresh current month cache after KP if user clicks refresh later.
    // We will NOT auto-refresh table (to respect ‚Äúmanual refresh‚Äù requirement).
  }catch(e){
    toast('KP failed: '+(e && e.message ? e.message : String(e)), false);
  }finally{
    btnKpAdd.disabled = false;
    btnKpClear.disabled = false;
    renderKpQueue();
  }
});

/* =============================================================================
   HELP TAB: Contact Developer (tag=CONTACT)
   - Script not updated yet; this will show error until it is.
   - Kept isolated so it cannot break other features.
   ============================================================================= */
async function sendContactMessage(name, clientOverride, message){
  const { url, secret, clientId } = currentConn();
  const execUrl = sanitizeExecUrl(url);

  const payload = {
    tag: 'CONTACT',
    authToken: secret,
    auth: secret,
    month: istMonthYYYYMM(),
    clientId: (clientOverride && clientOverride.trim()) ? clientOverride.trim() : clientId,
    name: (name && name.trim()) ? name.trim() : '',
    message: (message && message.trim()) ? message.trim() : ''
  };

  const data = await bridgePost(execUrl, payload, {
    hardTimeoutMs: 30000,
    soft1Msg: null,
    soft2Msg: null
  });

  if($('lastResp')) $('lastResp').textContent = JSON.stringify(data, null, 2);
  if(!isOkish(data)){
    const detail = data && (data.error || data.message || JSON.stringify(data).slice(0,220));
    throw new Error('CONTACT did not confirm ok' + (detail?': '+detail:''));
  }
  return data;
}

$('btnContactSubmit')?.addEventListener('click', async ()=>{
  const btn = $('btnContactSubmit');
  const status = $('contactStatus');

  const name = valStr('contactName') || '';
  const clientOverride = valStr('contactClientId') || '';
  const msg = valStr('contactMsg') || '';

  if(status) status.textContent = '';

  if(!msg.trim()){
    toast('Please enter your message', false);
    return;
  }

  btn.disabled = true;
  try{
    toast('Sent to Server ‚Ä¶');
    await sendContactMessage(name, clientOverride, msg);

    // Success behavior requested:
    // - button grays (disabled) and textarea clears and success alerted
    if($('contactMsg')) $('contactMsg').value = '';
    if(status) status.textContent = 'Submitted ‚úÖ';
    toast('Query submitted ‚úÖ');

    // Keep button disabled (requested). If you later want re-enable, change here.
  }catch(e){
    btn.disabled = false;
    toast('Contact submit failed: ' + (e?.message || String(e)), false);
  }
});

/* =============================================================================
   Final init
   ============================================================================= */
function init(){
  loadDevOverrides();

  // preconnect to default url immediately (speed-up)
  ensurePreconnectForUrl(currentConn().url);

  // set admission date default today
  if($('admitDate') && !$('admitDate').value) $('admitDate').value = todayISO();

  updateOxygenUI();
  attachFastListeners();
  scheduleCompute();
  renderKpQueue();

  // Controls month default
  const m = istMonthYYYYMM();
  if(controlsMonthInput && !controlsMonthInput.value) controlsMonthInput.value = fmtISTMonthForInput(m);
  setControlsMonthUI(m);
  renderControlsHeader();

  // Start in Form tab
  setMainTab('form');
}
init();
</script>
</body>
</html>
