<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>APACHE II Bedside Entry</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root {
    color-scheme: light;
    --surface: rgba(255, 255, 255, 0.9);
    --surface-strong: rgba(255, 255, 255, 0.98);
    --outline: rgba(148, 163, 184, 0.4);
    --outline-strong: rgba(37, 99, 235, 0.35);
    --muted: #475569;
    --text: #0f172a;
    --accent: #2563eb;
    --accent-dark: #1d4ed8;
    --accent-soft: rgba(37, 99, 235, 0.12);
    --bg-gradient: radial-gradient(circle at 5% 0%, rgba(59, 130, 246, 0.22), transparent 45%),
      radial-gradient(circle at 95% 0%, rgba(14, 165, 233, 0.18), transparent 40%),
      linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 55%, #f8fafc 100%);
    --shadow: 0 30px 60px -25px rgba(15, 23, 42, 0.35);
    --shadow-soft: 0 20px 50px -30px rgba(15, 23, 42, 0.35);
    --radius-lg: 26px;
    --radius-md: 18px;
    --radius-sm: 12px;
    --max-width: 1260px;
    font-synthesis: none;
    text-rendering: optimizeLegibility;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: var(--text);
    background: var(--bg-gradient);
    display: flex;
    flex-direction: column;
  }

  a {
    color: inherit;
  }

  .masthead {
    position: relative;
    padding: clamp(24px, 5vw, 42px) clamp(18px, 7vw, 64px) clamp(28px, 6vw, 52px);
    display: flex;
    flex-direction: column;
    gap: clamp(18px, 4vw, 36px);
    overflow: hidden;
  }

  .masthead::before {
    content: "";
    position: absolute;
    inset: 12% auto -20% 50%;
    width: clamp(240px, 40vw, 520px);
    height: clamp(240px, 45vw, 560px);
    background: radial-gradient(circle, rgba(37, 99, 235, 0.45), transparent 70%);
    transform: translateX(-50%) rotate(18deg);
    filter: blur(42px);
    opacity: 0.6;
  }

  .masthead__inner {
    position: relative;
    z-index: 1;
    max-width: var(--max-width);
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: clamp(18px, 4vw, 36px);
  }

  .topline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 18px;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .brand__mark {
    width: 48px;
    height: 48px;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.92), rgba(59, 130, 246, 0.7));
    display: grid;
    place-items: center;
    color: #fff;
    font-family: "Plus Jakarta Sans", "Inter", sans-serif;
    font-weight: 700;
    font-size: 20px;
    letter-spacing: 0.04em;
    box-shadow: var(--shadow-soft);
  }

  .brand__copy h1 {
    margin: 0;
    font-family: "Plus Jakarta Sans", "Inter", sans-serif;
    font-size: clamp(30px, 5vw, 44px);
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .brand__copy p {
    margin: 6px 0 0;
    max-width: 520px;
    color: var(--muted);
    font-size: clamp(15px, 2.5vw, 18px);
    line-height: 1.6;
  }

  .dev-bubble {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.7);
    background: rgba(15, 23, 42, 0.75);
    color: #e2e8f0;
    display: grid;
    place-items: center;
    cursor: pointer;
    box-shadow: 0 16px 40px -20px rgba(15, 23, 42, 0.65);
    backdrop-filter: blur(12px);
    transition: transform 0.2s ease;
  }

  .dev-bubble:hover {
    transform: translateY(-2px);
  }

  .mode-switcher {
    display: grid;
    gap: 10px;
    align-items: start;
  }

  .mode-pills {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
  }

  .mode {
    position: relative;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    padding: 14px 18px;
    background: rgba(255, 255, 255, 0.65);
    color: var(--muted);
    font-weight: 600;
    text-align: left;
    cursor: pointer;
    transition: all 0.25s ease;
  }

  .mode::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid transparent;
    pointer-events: none;
    transition: inherit;
  }

  .mode.active {
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.95), rgba(14, 165, 233, 0.8));
    color: #fff;
    box-shadow: 0 18px 42px -18px rgba(37, 99, 235, 0.6);
  }

  .mode.active::after {
    border-color: rgba(255, 255, 255, 0.55);
  }

  .mode-hint {
    font-size: 14px;
    color: var(--muted);
  }

  .patient-mini {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    color: var(--muted);
  }

  .mini-field {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: rgba(255, 255, 255, 0.75);
    box-shadow: 0 12px 28px -22px rgba(15, 23, 42, 0.45);
  }

  .mini-field span {
    font-size: 16px;
  }

  .mini-field input {
    border: 0;
    background: transparent;
    font-size: 14px;
    outline: none;
    min-width: 110px;
  }

  .workspace-wrapper {
    flex: 1;
    padding: 0 clamp(18px, 7vw, 64px) clamp(140px, 12vw, 200px);
  }

  .workspace {
    position: relative;
    z-index: 1;
    max-width: var(--max-width);
    margin: 0 auto;
    display: grid;
    gap: clamp(20px, 4vw, 36px);
  }

  .cards-flow {
    display: grid;
    gap: clamp(18px, 3vw, 28px);
  }

  .panel {
    background: var(--surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--outline);
    padding: clamp(18px, 3vw, 28px);
    box-shadow: var(--shadow-soft);
    backdrop-filter: blur(14px);
    display: grid;
    gap: clamp(16px, 2.5vw, 26px);
  }

  .panel header {
    display: grid;
    gap: 6px;
  }

  .panel h2 {
    margin: 0;
    font-size: clamp(18px, 2.7vw, 22px);
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .panel .hint {
    margin: 0;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.5;
  }

  label {
    font-weight: 600;
    font-size: 14px;
    color: #1e293b;
    display: block;
    margin-bottom: 6px;
  }

  .input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(148, 163, 184, 0.5);
    background: rgba(248, 250, 252, 0.92);
    font-size: 15px;
    transition: border 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: rgba(37, 99, 235, 0.6);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
    background: #fff;
  }

  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .grid-2,
  .grid-3 {
    display: grid;
    gap: 18px;
  }

  .grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    background: rgba(148, 163, 184, 0.14);
    border: 1px solid transparent;
    font-weight: 600;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s ease;
  }

  .chip input[type=radio] {
    accent-color: var(--accent);
  }

  .chip:hover {
    background: rgba(37, 99, 235, 0.1);
  }

  .tab-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .tab {
    flex: 1 1 150px;
    text-align: center;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    background: rgba(15, 23, 42, 0.08);
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tab.active {
    background: rgba(37, 99, 235, 0.9);
    color: #fff;
    box-shadow: 0 12px 28px -18px rgba(37, 99, 235, 0.6);
  }

  .tab-panel {
    display: none;
    gap: 18px;
  }

  .tab-panel.active {
    display: grid;
  }

  .insight-card {
    position: relative;
    background: var(--surface-strong);
    border-radius: var(--radius-lg);
    border: 1px solid rgba(148, 163, 184, 0.35);
    padding: clamp(18px, 3vw, 28px);
    box-shadow: var(--shadow);
    display: grid;
    gap: 16px;
    backdrop-filter: blur(16px);
  }

  .insight-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    font-weight: 600;
  }

  .insight-hint {
    font-size: 13px;
    color: var(--muted);
  }

  .preview-collapse {
    display: none;
    font-size: 14px;
    color: var(--accent-dark);
    cursor: pointer;
  }

  .preview-body {
    border-radius: var(--radius-sm);
    border: 1px solid rgba(15, 23, 42, 0.4);
    background: #0f172a;
    color: #e2e8f0;
    padding: 16px;
    font-family: "SFMono-Regular", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    max-height: 360px;
    overflow: auto;
    line-height: 1.6;
  }

  .preview-body.empty {
    display: grid;
    place-items: center;
    color: rgba(226, 232, 240, 0.6);
  }

  .action-dock {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 18px clamp(18px, 7vw, 64px) max(env(safe-area-inset-bottom, 24px), 28px);
    background: rgba(255, 255, 255, 0.96);
    border-top: 1px solid rgba(148, 163, 184, 0.35);
    box-shadow: 0 -18px 42px -24px rgba(15, 23, 42, 0.45);
    backdrop-filter: blur(16px);
  }

  .action-dock__inner {
    max-width: var(--max-width);
    margin: 0 auto;
    display: grid;
    gap: 12px;
  }

  .btn {
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    padding: 16px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
  }

  .btn.primary {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: #fff;
    box-shadow: 0 20px 40px -18px rgba(37, 99, 235, 0.55);
  }

  .btn.primary:hover:not([disabled]) {
    transform: translateY(-1px);
  }

  .btn.secondary {
    background: rgba(37, 99, 235, 0.08);
    color: var(--accent-dark);
    border: 1px solid rgba(37, 99, 235, 0.18);
  }

  .btn.ghost {
    background: transparent;
    border: 1px solid rgba(148, 163, 184, 0.35);
    color: var(--muted);
  }

  .btn[disabled] {
    opacity: 0.6;
    cursor: progress;
  }

  .toast {
    position: fixed;
    right: clamp(18px, 5vw, 64px);
    bottom: clamp(120px, 12vw, 180px);
    min-width: min(360px, calc(100vw - 48px));
    background: #fff;
    border-radius: var(--radius-md);
    border-left: 4px solid #16a34a;
    padding: 16px 20px;
    box-shadow: var(--shadow);
    font-weight: 600;
    color: var(--text);
    display: none;
    z-index: 90;
  }

  .toast.err {
    border-left-color: #dc2626;
    color: #dc2626;
  }

  .dev-panel,
  .dev-backdrop {
    position: fixed;
    inset: 0;
    z-index: 130;
  }

  .dev-backdrop {
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(6px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
  }

  .dev-backdrop[data-visible="true"] {
    opacity: 1;
    pointer-events: auto;
  }

  .dev-panel {
    display: grid;
    place-items: center;
    pointer-events: none;
  }

  .dev-sheet {
    width: min(420px, calc(100vw - 48px));
    background: #0f172a;
    color: #f8fafc;
    border-radius: var(--radius-lg);
    border: 1px solid rgba(148, 163, 184, 0.35);
    box-shadow: 0 30px 80px -30px rgba(15, 23, 42, 0.8);
    padding: 26px;
    display: grid;
    gap: 18px;
    pointer-events: auto;
  }

  .dev-sheet h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  .dev-sheet .close {
    justify-self: end;
    border: 0;
    background: rgba(148, 163, 184, 0.15);
    color: #e2e8f0;
    border-radius: 999px;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 600;
  }

  .dev-sheet label {
    color: #cbd5f5;
  }

  .dev-sheet .input {
    background: rgba(15, 23, 42, 0.75);
    color: #f8fafc;
    border: 1px solid rgba(148, 163, 184, 0.4);
  }

  .dev-tip {
    font-size: 13px;
    color: rgba(226, 232, 240, 0.7);
  }

  code {
    font-family: "SFMono-Regular", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  body.desktop .workspace {
    grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1fr);
    align-items: start;
  }

  body.desktop .cards-flow {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  body.desktop .panel[data-span="full"] {
    grid-column: 1 / -1;
  }

  body.desktop .preview-collapse {
    display: none !important;
  }

  body.desktop .insight-card {
    position: sticky;
    top: clamp(32px, 8vw, 64px);
  }

  body.desktop .action-dock__inner {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  body.desktop .action-dock__inner .btn.secondary {
    order: 1;
  }

  @media (max-width: 899px) {
    body.desktop .workspace {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 720px) {
    .topline {
      flex-direction: column;
      align-items: flex-start;
    }

    .dev-bubble {
      position: absolute;
      top: 0;
      right: 12px;
      transform: translateY(-50%);
    }

    .workspace-wrapper {
      padding-bottom: clamp(200px, 24vw, 260px);
    }

    .preview-collapse {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .insight-card[data-collapsed="true"] .preview-body {
      display: none;
    }

    .insight-card[data-collapsed="true"] .preview-collapse::after {
      content: "Show";
    }

    .insight-card[data-collapsed="false"] .preview-collapse::after {
      content: "Hide";
    }

    .action-dock__inner {
      grid-template-columns: 1fr;
    }
  }

  body.fold6 .patient-mini {
    display: flex;
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }
</style>
</head>
<body>
  <header class="masthead" role="banner">
    <div class="masthead__inner">
      <div class="topline">
        <div class="brand">
          <div class="brand__mark" aria-hidden="true">AI</div>
          <div class="brand__copy">
            <h1>APACHE II bedside console</h1>
            <p>Faster ICU data capture with layouts that reshape themselves from small phones to expansive desktops.</p>
          </div>
        </div>
        <button id="devToggle" class="dev-bubble" aria-label="Developer settings" aria-haspopup="dialog" aria-expanded="false">⚙️</button>
      </div>

      <div class="mode-switcher" aria-label="Submission mode selector">
        <div class="mode-pills" role="group">
          <button id="modeOnline" type="button" class="mode active">Online (Google Sheets)</button>
          <button id="modeDesktop" type="button" class="mode">Desktop (Hospital PC)</button>
        </div>
        <div id="modeHint" class="mode-hint">Data goes straight to secure Google Sheets. You can download the current month anytime.</div>
        <div class="patient-mini" aria-label="Quick patient entry">
          <div class="mini-field"><span>👤</span><input id="patientNameMini" type="text" placeholder="Patient name"></div>
          <div class="mini-field"><span>🆔</span><input id="uhidMini" type="text" placeholder="UHID"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="workspace-wrapper">
    <main class="workspace" id="formContent">
      <div class="cards-flow">
        <section class="panel" data-span="full" aria-labelledby="patient-h">
          <header>
            <h2 id="patient-h">Patient</h2>
            <p class="hint">Identifiers sync between compact and expanded entry areas automatically.</p>
          </header>
          <div class="grid-2">
            <div>
              <label for="patientName">Patient Name*</label>
              <input id="patientName" class="input" type="text" required placeholder="e.g., Jane Doe">
            </div>
            <div>
              <label for="uhid">UHID*</label>
              <input id="uhid" class="input" type="text" required placeholder="Unit health ID">
            </div>
          </div>
        </section>

        <section class="panel" aria-labelledby="demo-h">
          <header>
            <h2 id="demo-h">Demographics</h2>
            <p class="hint">Baseline metrics anchor APACHE II scoring models.</p>
          </header>
          <div class="grid-2">
            <div>
              <label for="age">Age (years)*</label>
              <input id="age" class="input" type="number" min="0" max="120" step="1" required placeholder="Years">
            </div>
            <div>
              <label for="gcs">GCS (3–15)</label>
              <input id="gcs" class="input" type="number" min="3" max="15" step="1" placeholder="e.g., 12">
            </div>
          </div>
        </section>

        <section class="panel" aria-labelledby="chronic-h">
          <header>
            <h2 id="chronic-h">Chronic health</h2>
            <p class="hint">Reveal surgical pathways when significant organ failure is present.</p>
          </header>
          <div class="chip-row" id="chronicGrp">
            <label class="chip"><input type="radio" name="chronic" value="No" checked> No</label>
            <label class="chip"><input type="radio" name="chronic" value="Yes"> Yes – severe organ failure / immunocompromise</label>
          </div>
          <div id="surgTypeWrap" class="grid-2" style="display:none">
            <div>
              <label>Type of surgery (if chronic = Yes)</label>
              <div class="chip-row">
                <label class="chip"><input type="radio" name="surgtype" value="Emergency" checked> Emergency</label>
                <label class="chip"><input type="radio" name="surgtype" value="Elective"> Elective</label>
                <label class="chip"><input type="radio" name="surgtype" value="Nonoperative"> Non-operative</label>
              </div>
            </div>
          </div>
        </section>

        <section class="panel" data-span="full" aria-labelledby="inputs-h">
          <header>
            <h2 id="inputs-h">Clinical inputs</h2>
            <p class="hint">Segment vitals, oxygenation and labs with quick swipe tabs.</p>
          </header>
          <div class="tab-bar" role="tablist">
            <button class="tab active" type="button" data-tab="vitals">Vitals</button>
            <button class="tab" type="button" data-tab="oxygen">Oxygenation</button>
            <button class="tab" type="button" data-tab="labs">Labs</button>
          </div>

          <div id="tab-vitals" class="tab-panel active" role="tabpanel">
            <div class="grid-3">
              <div>
                <label for="tempF">Temperature (°F)</label>
                <input id="tempF" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="map">Mean Arterial Pressure (mmHg)</label>
                <input id="map" class="input" type="number" step="1">
              </div>
              <div>
                <label for="hr">Heart Rate (bpm)</label>
                <input id="hr" class="input" type="number" step="1">
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label for="rr">Respiratory Rate (breaths/min)</label>
                <input id="rr" class="input" type="number" step="1">
              </div>
            </div>
          </div>

          <div id="tab-oxygen" class="tab-panel" role="tabpanel">
            <div>
              <label>FiO₂ category*</label>
              <div class="chip-row" id="fio2Grp">
                <label class="chip"><input type="radio" name="fio2" value="<50%" checked> &lt; 50% (or non-intubated)</label>
                <label class="chip"><input type="radio" name="fio2" value=">=50%"> ≥ 50%</label>
              </div>
            </div>
            <div id="po2Wrap">
              <label for="pao2">PaO₂ (mmHg)</label>
              <input id="pao2" class="input" type="number" step="1" placeholder="e.g., 80">
              <p class="hint">If FiO₂ &lt; 50% → provide PaO₂.</p>
            </div>
            <div id="aagradWrap" style="display:none">
              <label for="aagrad">A–a gradient (mmHg)</label>
              <input id="aagrad" class="input" type="number" step="1" placeholder="e.g., 220">
              <p class="hint">If FiO₂ ≥ 50% → provide A–a gradient.</p>
            </div>
          </div>

          <div id="tab-labs" class="tab-panel" role="tabpanel">
            <div class="grid-3">
              <div>
                <label for="ph">pH (arterial)</label>
                <input id="ph" class="input" type="number" step="0.01" min="6.8" max="7.8">
              </div>
              <div>
                <label for="hco3">HCO₃⁻ (mEq/L)</label>
                <input id="hco3" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="na">Na⁺ (mEq/L)</label>
                <input id="na" class="input" type="number" step="1">
              </div>
            </div>
            <div class="grid-3">
              <div>
                <label for="k">K⁺ (mEq/L)</label>
                <input id="k" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="cr">Creatinine (mg/dL)</label>
                <input id="cr" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="bun">BUN (mg/dL)</label>
                <input id="bun" class="input" type="number" step="0.1">
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label for="wbc">WBC (cells x10³/mm³)</label>
                <input id="wbc" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="hct">Hematocrit (%)</label>
                <input id="hct" class="input" type="number" step="0.1">
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label>Acute Renal Failure</label>
                <div class="chip-row" id="arfGrp">
                  <label class="chip"><input type="radio" name="arf" value="No" checked> No</label>
                  <label class="chip"><input type="radio" name="arf" value="Yes"> Yes</label>
                </div>
              </div>
              <div>
                <label for="platelets">Platelets (10³/mm³)</label>
                <input id="platelets" class="input" type="number" step="1">
              </div>
            </div>
          </div>
        </section>
      </div>

      <aside class="insight-card" id="previewCard" data-collapsed="false">
        <div class="insight-title">
          <span>Submission preview</span>
          <button id="btnPreview" class="btn ghost" type="button">Refresh preview</button>
        </div>
        <div id="previewToggle" class="preview-collapse" role="button" aria-expanded="true">Preview</div>
        <pre id="preview" class="preview-body empty">Nothing captured yet</pre>
        <div class="insight-hint">Updated automatically on submit to mirror what leaves the device.</div>
      </aside>
    </main>
  </div>

  <div class="action-dock" role="contentinfo">
    <div class="action-dock__inner">
      <button id="btnDownload" class="btn ghost" type="button">Download current month</button>
      <button id="btnPreviewDock" class="btn secondary" type="button">Preview only</button>
      <button id="btnSubmit" class="btn primary" type="button">Submit to selected mode</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div id="devBackdrop" class="dev-backdrop" aria-hidden="true"></div>
  <div id="devPanel" class="dev-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="devTitle">
    <div class="dev-sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:16px;">
        <h3 id="devTitle">Developer overrides</h3>
        <button id="devClose" class="close" type="button">Close</button>
      </div>
      <p class="dev-tip">Values persist per device. Leave blank to fall back to defaults.</p>
      <div>
        <label for="onlineUrl">Online Webhook URL</label>
        <input id="onlineUrl" class="input" type="url" placeholder="https://script.google.com/...">
      </div>
      <div>
        <label for="onlineSecret">Online Secret</label>
        <input id="onlineSecret" class="input" type="text" placeholder="Shared secret for Sheets webhook">
      </div>
      <div>
        <label for="clientId">Client ID</label>
        <input id="clientId" class="input" type="text" value="NURSING-STATION-01">
      </div>
      <div>
        <label for="authToken">Auth Token</label>
        <input id="authToken" class="input" type="text" value="SUPER_STRONG_SHARED_TOKEN">
      </div>
      <div class="dev-tip">Desktop API: <code>https://apache-bridge-server-production.up.railway.app</code> · WS: <code>wss://apache-bridge-server-production.up.railway.app/ws/mobile</code></div>
    </div>
  </div>

  <script>
  function detectDesktop() {
    const ua = navigator.userAgent || "";
    const looksDesktop = /(Macintosh|Windows|Linux)/i.test(ua) && !/(Mobile|Tablet|Android)/i.test(ua);
    const pointerFine = window.matchMedia('(pointer: fine)').matches;
    const wideEnough = window.matchMedia('(min-width: 1024px)').matches;
    return looksDesktop || (pointerFine && wideEnough);
  }

  function applyDesktopClass() {
    document.body.classList.toggle('desktop', detectDesktop());
  }

  applyDesktopClass();
  window.addEventListener('resize', () => {
    clearTimeout(applyDesktopClass._timer);
    applyDesktopClass._timer = setTimeout(applyDesktopClass, 180);
  });

  const $ = (id) => document.getElementById(id);
  const q = (sel) => document.querySelector(sel);

  function valNum(id) {
    const v = $(id).value.trim();
    return v === '' ? null : Number(v);
  }

  function valStr(id) {
    const v = $(id).value.trim();
    return v === '' ? null : v;
  }

  function radioVal(name) {
    const el = document.querySelector('input[name="' + name + '"]:checked');
    return el ? el.value : null;
  }

  function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
      const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
      const v = c === 'x' ? r : ((r & 0x3) | 0x8);
      return v.toString(16);
    });
  }

  function toast(msg, ok = true) {
    const t = $('toast');
    t.textContent = msg;
    t.className = 'toast' + (ok ? '' : ' err');
    t.style.display = 'block';
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => {
      t.style.display = 'none';
    }, 4800);
  }

  ['patientName', 'uhid'].forEach((id) => {
    const main = $(id);
    if (!main) return;
    main.addEventListener('input', () => {
      const mini = $(id + 'Mini');
      if (mini && mini.value !== main.value) mini.value = main.value;
    });
  });

  ['patientNameMini', 'uhidMini'].forEach((id) => {
    const mini = $(id);
    if (!mini) return;
    mini.addEventListener('input', () => {
      const main = $(id.replace('Mini', ''));
      if (main && main.value !== mini.value) main.value = mini.value;
    });
  });

  const devToggle = $('devToggle');
  const devPanel = $('devPanel');
  const devBackdrop = $('devBackdrop');
  const devClose = $('devClose');

  devPanel.setAttribute('aria-hidden', 'true');
  devBackdrop.setAttribute('data-visible', 'false');

  function setDevPanel(open) {
    const wasOpen = devPanel.getAttribute('aria-hidden') === 'false';
    devPanel.setAttribute('aria-hidden', open ? 'false' : 'true');
    devBackdrop.setAttribute('data-visible', open ? 'true' : 'false');
    devBackdrop.setAttribute('aria-hidden', open ? 'false' : 'true');
    devToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    if (wasOpen && !open) saveDevOverrides();
  }

  devToggle.addEventListener('click', () => {
    const open = devPanel.getAttribute('aria-hidden') !== 'false';
    setDevPanel(open);
  });

  devClose.addEventListener('click', () => setDevPanel(false));
  devBackdrop.addEventListener('click', () => setDevPanel(false));

  function saveDevOverrides() {
    const overrides = {
      onlineUrl: $('onlineUrl')?.value.trim() || '',
      onlineSecret: $('onlineSecret')?.value.trim() || '',
      clientId: $('clientId')?.value.trim() || 'NURSING-STATION-01',
      authToken: $('authToken')?.value.trim() || ''
    };
    localStorage.setItem('apacheMobileDev', JSON.stringify(overrides));
    if (overrides.onlineUrl) ONLINE_WEBHOOK_URL = overrides.onlineUrl;
    if (overrides.onlineSecret) ONLINE_SECRET = overrides.onlineSecret;
  }

  function loadDevOverrides() {
    try {
      const raw = localStorage.getItem('apacheMobileDev');
      if (!raw) return;
      const overrides = JSON.parse(raw);
      if ($('onlineUrl')) $('onlineUrl').value = overrides.onlineUrl || '';
      if ($('onlineSecret')) $('onlineSecret').value = overrides.onlineSecret || '';
      if ($('clientId')) $('clientId').value = overrides.clientId || 'NURSING-STATION-01';
      if ($('authToken')) $('authToken').value = overrides.authToken || '';
      if (overrides.onlineUrl) ONLINE_WEBHOOK_URL = overrides.onlineUrl;
      if (overrides.onlineSecret) ONLINE_SECRET = overrides.onlineSecret;
    } catch (_) {}
  }

  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape' && devPanel.getAttribute('aria-hidden') === 'false') {
      setDevPanel(false);
    }
  });

  (function () {
    const ua = (navigator.userAgent || '').toUpperCase();
    const isFold6 = ua.includes('SM-F956') || ua.includes('Z FOLD 6') || ua.includes('Z FOLD6');
    if (isFold6) document.body.classList.add('fold6');
  })();

  $('chronicGrp').addEventListener('change', () => {
    $('surgTypeWrap').style.display = radioVal('chronic') === 'Yes' ? 'grid' : 'none';
  });

  $('fio2Grp').addEventListener('change', () => {
    const v = radioVal('fio2');
    $('po2Wrap').style.display = v === '<50%';
    $('aagradWrap').style.display = v !== '<50%';
  });

  document.querySelectorAll('.tab').forEach((btn) => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach((b) => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach((panel) => panel.classList.remove('active'));
      btn.classList.add('active');
      const target = $('tab-' + btn.dataset.tab);
      if (target) target.classList.add('active');
    });
  });

  const previewCard = $('previewCard');
  const previewToggle = $('previewToggle');
  if (previewToggle) {
    previewToggle.addEventListener('click', () => {
      const collapsed = previewCard.getAttribute('data-collapsed') !== 'false';
      previewCard.setAttribute('data-collapsed', collapsed ? 'false' : 'true');
      previewToggle.setAttribute('aria-expanded', collapsed ? 'true' : 'false');
    });
  }

  const API_BASE = 'https://apache-bridge-server-production.up.railway.app';
  const SERVER_HTTP_URL = API_BASE + '/api/submit';
  const SERVER_WS_URL = 'wss://apache-bridge-server-production.up.railway.app/ws/mobile';

  let ONLINE_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbwnmv8Qgt38LeeMgYQfh9Or83i-woNkz-gFIgIFjNJoKw_YF2rpVxh9V6syRoHEEw8/exec';
  let ONLINE_SECRET = 'SUPER_STRONG_SHARED_TOKEN';

  loadDevOverrides();

  let MODE = 'online';

  function syncModeButtons(m) {
    $('modeOnline').classList.toggle('active', m === 'online');
    $('modeDesktop').classList.toggle('active', m !== 'online');
  }

  function setMode(m) {
    MODE = m;
    syncModeButtons(m);
    $('btnDownload').style.display = m === 'online' ? 'block' : 'none';
    $('modeHint').textContent = m === 'online'
      ? 'Data goes straight to secure Google Sheets. You can download the current month anytime.'
      : 'Data is sent to the hospital desktop app. Requires the desktop client to be connected.';
  }

  $('modeOnline').addEventListener('click', () => setMode('online'));
  $('modeDesktop').addEventListener('click', () => setMode('desktop'));
  setMode('online');

  function buildPayload() {
    const patientName = valStr('patientName');
    const uhid = valStr('uhid');
    const age = valNum('age');
    const fio2 = radioVal('fio2');
    if (!patientName) throw new Error('Patient Name is required');
    if (!uhid) throw new Error('UHID is required');
    if (age === null) throw new Error('Age is required');
    if (!fio2) throw new Error('FiO₂ category is required');

    const chronic = radioVal('chronic');
    const surgtype = chronic === 'Yes' ? radioVal('surgtype') : null;

    const pao2 = fio2 === '<50%' ? valNum('pao2') : null;
    const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;
    if (fio2 === '<50%' && pao2 === null) throw new Error('PaO₂ is required when FiO₂ < 50%');
    if (fio2 !== '<50%' && aagrad === null) throw new Error('A–a gradient is required when FiO₂ ≥ 50%');

    return {
      clientId: $('clientId') ? $('clientId').value.trim() : 'NURSING-STATION-01',
      authToken: MODE === 'online'
        ? (($('onlineSecret') && $('onlineSecret').value.trim()) || ONLINE_SECRET || '')
        : (($('authToken') && $('authToken').value.trim()) || ''),
      patientName,
      uhid,
      timestamp: new Date().toISOString(),
      submissionId: uuidv4(),
      apacheInputs: {
        Age_years: age,
        GCS: valNum('gcs'),
        Temperature_F: valNum('tempF'),
        MAP_mmHg: valNum('map'),
        HeartRate_bpm: valNum('hr'),
        RespRate_bpm: valNum('rr'),
        FiO2_Category: fio2,
        PaO2_mmHg: pao2,
        AaGradient_mmHg: aagrad,
        pH: valNum('ph'),
        HCO3_mEqL: valNum('hco3'),
        Na_mEqL: valNum('na'),
        K_mEqL: valNum('k'),
        Creatinine_mgdl: valNum('cr'),
        BUN_mgdl: valNum('bun'),
        AcuteRenalFailure: radioVal('arf') === 'Yes',
        Hematocrit_pct: valNum('hct'),
        WBC_10e3uL: valNum('wbc'),
        Platelets_10e3uL: valNum('platelets'),
        ChronicHealth: chronic === 'Yes' ? 'Yes' : 'No',
        SurgeryType: surgtype
      }
    };
  }

  async function sendJson(url, payload, label) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    if (!res.ok) {
      const bodyHint = text ? ' ' + text : '';
      throw new Error(label + ' responded with ' + res.status + '.' + bodyHint);
    }

    if (!text) return {};
    try {
      const data = JSON.parse(text);
      if (data && typeof data === 'object' && data.error) {
        throw new Error(label + ' error: ' + data.error);
      }
      return data;
    } catch (_) {
      return { message: text };
    }
  }

  async function postOnline(payload) {
    const url = ($('onlineUrl')?.value.trim() || ONLINE_WEBHOOK_URL || '');
    if (!url) throw new Error('Online Webhook URL not set (Developer → Online Webhook URL).');
    if (!payload.authToken) throw new Error('Online Secret not set (Developer → Online Secret).');
    return sendJson(url, payload, 'Google Sheets webhook');
  }

  async function postDesktop(payload) {
    return sendJson(SERVER_HTTP_URL, payload, 'Desktop bridge');
  }

  function waitForAckWS(submissionId, onAck, onError) {
    try {
      const url = new URL(SERVER_WS_URL);
      url.searchParams.set('clientId', $('clientId') ? $('clientId').value.trim() : '');
      url.searchParams.set('submissionId', submissionId);
      const ws = new WebSocket(url.toString());
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.status === 'SUCCESS' || msg.status === 'ERROR' || msg.clientId) {
            onAck(msg);
            ws.close();
          }
        } catch (_) {}
      };
      ws.onerror = () => onError(new Error('WS error'));
      return ws;
    } catch (e) {
      onError(e);
      return null;
    }
  }

  $('btnDownload').addEventListener('click', () => {
    try {
      const url = ($('onlineUrl')?.value.trim() || ONLINE_WEBHOOK_URL || '');
      const secret = ($('onlineSecret')?.value.trim() || ONLINE_SECRET || '');
      if (!url || !secret) {
        toast('Set Online URL and Secret in Developer panel.', false);
        return;
      }
      const ym = new Date().toISOString().slice(0, 7);
      const link = url + '?action=download&month=' + encodeURIComponent(ym) + '&auth=' + encodeURIComponent(secret);
      window.open(link, '_blank');
    } catch (e) {
      toast(e.message, false);
    }
  });

  $('btnPreviewDock').addEventListener('click', () => {
    try {
      const payload = buildPayload();
      $('preview').textContent = JSON.stringify(payload, null, 2);
      $('preview').classList.remove('empty');
      previewCard.setAttribute('data-collapsed', 'false');
      toast('Preview updated');
    } catch (e) {
      toast(e.message, false);
    }
  });

  $('btnPreview').addEventListener('click', () => {
    try {
      const payload = buildPayload();
      $('preview').textContent = JSON.stringify(payload, null, 2);
      $('preview').classList.remove('empty');
      previewCard.setAttribute('data-collapsed', 'false');
      toast('Preview updated');
    } catch (e) {
      toast(e.message, false);
    }
  });

  $('btnSubmit').addEventListener('click', async (ev) => {
    ev.preventDefault();
    const button = $('btnSubmit');
    button.disabled = true;
    try {
      saveDevOverrides();
      const payload = buildPayload();
      $('preview').textContent = JSON.stringify(payload, null, 2);
      $('preview').classList.remove('empty');
      previewCard.setAttribute('data-collapsed', 'false');

      if (MODE === 'online') {
        toast('Sending to Google Sheets…');
        await postOnline(payload);
        toast('Saved to Google Sheets ✅');
      } else {
        toast('Sending to desktop…');
        await postDesktop(payload);
        let acked = false;
        const ackToast = setTimeout(() => {
          if (!acked) toast('Submitted. Waiting for desktop…');
        }, 1400);
        waitForAckWS(payload.submissionId,
          (ack) => {
            acked = true;
            clearTimeout(ackToast);
            if (ack.status === 'SUCCESS') toast('Saved on desktop ✅');
            else if (ack.status === 'ERROR') toast('Desktop error: ' + (ack.message || 'unknown'), false);
            else toast('Submitted. Check desktop.');
          },
          () => toast('Submitted. No live ack yet.')
        );
      }
    } catch (e) {
      toast('Submit failed: ' + e.message, false);
    } finally {
      button.disabled = false;
    }
  });
  </script>
</body>
</html></style>
</head>
<body>
  <div class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="title">
        <h1>APACHE II · Bedside Entry</h1>
        <div class="sub">Mobile-friendly ICU data capture</div>
      </div>
      <!-- Quick chips (Fold 6 only) -->
      <div class="patient-mini" aria-label="Quick patient entry">
        <div class="mini-field"><span>👤</span><input id="patientNameMini" type="text" placeholder="Patient name"></div>
        <div class="mini-field"><span>🆔</span><input id="uhidMini" type="text" placeholder="UHID"></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Mode -->
    <section class="card" aria-labelledby="mode-h">
      <h2 id="mode-h">Mode</h2>
      <div class="modewrap">
        <button id="modeOnline"  class="mode active" type="button">Online (Google Sheets)</button>
        <button id="modeDesktop" class="mode"          type="button">Desktop (Hospital PC)</button>
      </div>
      <div class="hint" id="modeHint" style="margin-top:6px">
        Data goes straight to secure Google Sheets. You can download the current month anytime.
      </div>
    </section>

    <!-- Patient -->
    <section class="card" aria-labelledby="patient-h">
      <h2 id="patient-h">Patient</h2>
      <div class="grid2">
        <div><label for="patientName">Patient Name*</label><input id="patientName" class="ipt" type="text" required></div>
        <div><label for="uhid">UHID*</label><input id="uhid" class="ipt" type="text" required></div>
      </div>
    </section>

    <!-- Chronic Health -->
    <section class="card" aria-labelledby="chronic-h">
      <h2 id="chronic-h">Chronic Health</h2>
      <div class="radio-row" id="chronicGrp">
        <label class="chip-radio"><input type="radio" name="chronic" value="No" checked> No</label>
        <label class="chip-radio"><input type="radio" name="chronic" value="Yes"> Yes – severe organ failure / immunocompromise</label>
      </div>
      <div id="surgTypeWrap" style="display:none; margin-top:8px;">
        <label>Type of surgery (if chronic = Yes)</label>
        <div class="radio-row">
          <label class="chip-radio"><input type="radio" name="surgtype" value="Emergency" checked> Emergency</label>
          <label class="chip-radio"><input type="radio" name="surgtype" value="Elective"> Elective</label>
          <label class="chip-radio"><input type="radio" name="surgtype" value="Nonoperative"> Non-operative</label>
        </div>
      </div>
    </section>

    <!-- Demographics -->
    <section class="card" aria-labelledby="demo-h">
      <h2 id="demo-h">Demographics</h2>
      <div class="grid2">
        <div><label for="age">Age (years)*</label><input id="age" class="ipt" type="number" min="0" max="120" step="1" required></div>
        <div><label for="gcs">GCS (3–15)</label><input id="gcs" class="ipt" type="number" min="3" max="15" step="1" placeholder="e.g., 12"></div>
      </div>
    </section>

    <!-- Clinical Inputs -->
    <section class="card" aria-labelledby="inputs-h">
      <h2 id="inputs-h">Clinical Inputs</h2>
      <div class="tabs" role="tablist" aria-label="Sections">
        <button class="tab active" data-tab="vitals"   type="button">Vitals</button>
        <button class="tab"         data-tab="oxygen"   type="button">Oxygenation</button>
        <button class="tab"         data-tab="labs"     type="button">Labs</button>
      </div>

      <div id="tab-vitals" class="tab-panel active" role="tabpanel">
        <div class="grid3">
          <div><label for="tempF">Temperature (°F)</label><input id="tempF" class="ipt" type="number" step="0.1"></div>
          <div><label for="map">Mean Arterial Pressure (mmHg)</label><input id="map" class="ipt" type="number" step="1"></div>
          <div><label for="hr">Heart Rate (bpm)</label><input id="hr" class="ipt" type="number" step="1"></div>
        </div>
        <div class="grid2">
          <div><label for="rr">Respiratory Rate (breaths/min)</label><input id="rr" class="ipt" type="number" step="1"></div>
        </div>
      </div>

      <div id="tab-oxygen" class="tab-panel" role="tabpanel">
        <label>FiO₂ category*</label>
        <div class="radio-row" id="fio2Grp">
          <label class="chip-radio"><input type="radio" name="fio2" value="<50%" checked> < 50% (or non-intubated)</label>
          <label class="chip-radio"><input type="radio" name="fio2" value=">=50%"> ≥ 50%</label>
        </div>
        <div id="po2Wrap" style="margin-top:10px">
          <label for="pao2">PaO₂ (mmHg)</label>
          <input id="pao2" class="ipt" type="number" step="1" placeholder="e.g., 80">
          <div class="hint">If FiO₂ &lt; 50% → provide PaO₂.</div>
        </div>
        <div id="aagradWrap" style="display:none; margin-top:10px">
          <label for="aagrad">A–a gradient (mmHg)</label>
          <input id="aagrad" class="ipt" type="number" step="1" placeholder="e.g., 220">
          <div class="hint">If FiO₂ ≥ 50% → provide A–a gradient.</div>
        </div>
      </div>

      <div id="tab-labs" class="tab-panel" role="tabpanel">
        <div class="grid3">
          <div><label for="ph">pH (arterial)</label><input id="ph" class="ipt" type="number" step="0.01" min="6.8" max="7.8"></div>
          <div><label for="hco3">HCO₃⁻ (mEq/L)</label><input id="hco3" class="ipt" type="number" step="0.1"></div>
          <div><label for="na">Na⁺ (mEq/L)</label><input id="na" class="ipt" type="number" step="1"></div>
        </div>
        <div class="grid3">
          <div><label for="k">K⁺ (mEq/L)</label><input id="k" class="ipt" type="number" step="0.1"></div>
          <div><label for="cr">Creatinine (mg/dL)</label><input id="cr" class="ipt" type="number" step="0.1"></div>
          <div>
            <label>Acute Renal Failure</label>
            <div class="radio-row">
              <label class="chip-radio"><input type="radio" name="arf" value="No" checked> No</label>
              <label class="chip-radio"><input type="radio" name="arf" value="Yes"> Yes</label>
            </div>
          </div>
        </div>
        <div class="grid3">
          <div><label for="hct">Hematocrit (%)</label><input id="hct" class="ipt" type="number" step="0.1"></div>
          <div><label for="wbc">WBC (×10³/μL)</label><input id="wbc" class="ipt" type="number" step="0.1"></div>
        </div>
      </div>
    </section>

    <!-- Developer (collapsed by default) -->
    <section class="card" aria-labelledby="dev-h">
      <div class="collapser">
        <h2 id="dev-h" style="margin:0">Developer</h2>
        <span id="toggleDev" class="link" role="button" aria-expanded="false" aria-controls="devwrap">Show developer options</span>
      </div>
      <div id="devwrap" class="devwrap" aria-hidden="true" style="display:none">
        <div class="hint" style="margin:6px 0 12px">
          Online endpoints are fixed for safety. You can override credentials here for testing.
        </div>
        <div class="grid2">
          <div><label for="onlineUrl">Online Webhook URL</label>
            <input id="onlineUrl" class="ipt" type="text" value="https://script.google.com/macros/s/AKfycbwnmv8Qgt38LeeMgYQfh9Or83i-woNkz-gFIgIFjNJoKw_YF2rpVxh9V6syRoHEEw8/exec">
          </div>
          <div><label for="onlineSecret">Online Secret</label>
            <input id="onlineSecret" class="ipt" type="text" value="SUPER_STRONG_SHARED_TOKEN">
          </div>
        </div>

        <div class="hint" style="margin:12px 0 6px">Desktop overrides (optional)</div>
        <div class="grid2">
          <div><label for="clientId">Client ID</label><input id="clientId" class="ipt" type="text" value="NURSING-STATION-01"></div>
          <div><label for="authToken">Auth Token</label><input id="authToken" class="ipt" type="text" value="SUPER_STRONG_SHARED_TOKEN"></div>
        </div>
        <div class="hint" style="margin-top:10px">
          Desktop API: <code>https://apache-bridge-server-production.up.railway.app</code> · WS: <code>wss://.../ws/mobile</code>
        </div>
      </div>
    </section>

    <!-- Preview (collapsed) -->
    <section class="card" aria-labelledby="preview-h">
      <div class="collapser">
        <h2 id="preview-h" style="margin:0">Preview</h2>
        <span id="togglePreview" class="link" role="button" aria-expanded="false" aria-controls="previewwrap">Show payload</span>
      </div>
      <div id="previewwrap" class="devwrap" aria-hidden="true" style="display:none">
        <pre id="preview" class="preview" aria-live="polite">(No payload yet)</pre>
      </div>
    </section>
  </div>

  <!-- Action dock -->
  <div class="dock" role="contentinfo">
    <div class="dock-inner" id="dockBtns">
      <button id="btnSubmit" class="btn primary" type="button">Submit</button>
      <button id="btnPreview" class="btn" type="button">Preview</button>
      <button id="btnDownload" class="btn ghost" type="button" style="display:none">Download current month</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* Explicit Z Fold 6 detect → wide layout */
(function(){
  const ua=(navigator.userAgent||"").toUpperCase();
  const byModel = ua.includes("SM-F956");
  const byName  = ua.includes("Z FOLD 6") || ua.includes("Z FOLD6");
  if (byModel || byName) document.body.classList.add('fold6');
})();

/* Fixed desktop endpoints */
const API_BASE = "https://apache-bridge-server-production.up.railway.app";
const SERVER_HTTP_URL = API_BASE + "/api/submit";
const SERVER_WS_URL   = "wss://apache-bridge-server-production.up.railway.app/ws/mobile";

/* Online defaults (hardcoded) */
let ONLINE_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwnmv8Qgt38LeeMgYQfh9Or83i-woNkz-gFIgIFjNJoKw_YF2rpVxh9V6syRoHEEw8/exec";
let ONLINE_SECRET      = "SUPER_STRONG_SHARED_TOKEN";

/* Utilities */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
function valNum(id){ const v=$(id).value.trim(); return v===''?null:Number(v); }
function valStr(id){ const v=$(id).value.trim(); return v===''?null:v; }
function radioVal(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:null; }
function uuidv4(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15; const v=c==='x'?r:(r&0x3|0x8); return v.toString(16);});}
function toast(msg, ok=true){ const t=$('toast'); t.textContent=msg; t.className='toast'+(ok?'':' err'); t.style.display='block'; clearTimeout(toast._tmr); toast._tmr=setTimeout(()=>t.style.display='none',4200); }

/* Persist Dev overrides locally (no server storage) */
function saveDevOverrides(){
  const o = {
    onlineUrl:   $('onlineUrl')?.value.trim() || "",
    onlineSecret:$('onlineSecret')?.value.trim() || "",
    clientId:    $('clientId')?.value.trim() || "NURSING-STATION-01",
    authToken:   $('authToken')?.value.trim() || ""
  };
  localStorage.setItem('apacheMobileDev', JSON.stringify(o));
  ONLINE_WEBHOOK_URL = o.onlineUrl || ONLINE_WEBHOOK_URL;
  ONLINE_SECRET      = o.onlineSecret || ONLINE_SECRET;
}
function loadDevOverrides(){
  try{
    const raw = localStorage.getItem('apacheMobileDev');
    if (!raw) return;
    const o = JSON.parse(raw);
    if ($('onlineUrl'))    $('onlineUrl').value    = o.onlineUrl    || "";
    if ($('onlineSecret')) $('onlineSecret').value = o.onlineSecret || "";
    if ($('clientId'))     $('clientId').value     = o.clientId     || "NURSING-STATION-01";
    if ($('authToken'))    $('authToken').value    = o.authToken    || "";
    ONLINE_WEBHOOK_URL = o.onlineUrl    || ONLINE_WEBHOOK_URL;
    ONLINE_SECRET      = o.onlineSecret || ONLINE_SECRET;
  }catch(_){}
}

/* Tabs */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    const target = document.getElementById('tab-' + btn.dataset.tab);
    if (target) target.classList.add('active');
  });
});

/* Field logic */
$('chronicGrp').addEventListener('change', ()=>{
  $('surgTypeWrap').style.display = (radioVal('chronic')==='Yes') ? 'block' : 'none';
});
$('fio2Grp').addEventListener('change', ()=>{
  const v = radioVal('fio2');
  $('po2Wrap').style.display   = (v === '<50%');
  $('aagradWrap').style.display= (v !== '<50%');
});

/* Sync mini chips (Fold 6) */
['patientName','uhid'].forEach(id => $(id).addEventListener('input', e => { const m=$(id+'Mini'); if(m) m.value=e.target.value; }));
['patientNameMini','uhidMini'].forEach(id => { const m=$(id); if(m) m.addEventListener('input', e => { const main=$(id.replace('Mini','')); if(main) main.value=e.target.value; }); });

/* Developer collapsers */
function setDevVisible(show){
  const w=$('devwrap'), t=$('toggleDev');
  w.style.display = show ? 'block' : 'none';
  w.setAttribute('aria-hidden', show ? 'false' : 'true');
  t.textContent = show ? 'Hide developer options' : 'Show developer options';
  t.setAttribute('aria-expanded', show ? 'true' : 'false');
}
document.addEventListener('DOMContentLoaded', ()=> { setDevVisible(false); setTimeout(()=>setDevVisible(false), 250); loadDevOverrides(); });
window.addEventListener('load', ()=> { setTimeout(()=>setDevVisible(false), 0); setTimeout(()=>setDevVisible(false), 800); });
$('toggleDev').addEventListener('click', ()=>{ const show = $('devwrap').style.display !== 'block'; setDevVisible(show); if(!show) saveDevOverrides(); });

/* Mode toggle */
let MODE = 'online'; // default
function setMode(m){
  MODE = m;
  $('modeOnline').classList.toggle('active', m==='online');
  $('modeDesktop').classList.toggle('active', m!=='online');
  $('btnDownload').style.display = (m==='online') ? 'block' : 'none';
  $('modeHint').textContent = m==='online'
    ? 'Data goes straight to secure Google Sheets. You can download the current month anytime.'
    : 'Data is sent to the hospital desktop app. Requires the desktop client to be connected.';
}
$('modeOnline').addEventListener('click', ()=> setMode('online'));
$('modeDesktop').addEventListener('click', ()=> setMode('desktop'));
setMode('online');

/* Preview collapse */
$('togglePreview').addEventListener('click', ()=>{
  const w=$('previewwrap'); const show=w.style.display!=='block';
  w.style.display = show ? 'block' : 'none';
  $('togglePreview').textContent = show ? 'Hide payload' : 'Show payload';
});

/* Build payload */
function buildPayload(){
  const patientName = valStr('patientName');
  const uhid = valStr('uhid');
  const age = valNum('age');
  const fio2 = radioVal('fio2');
  if(!patientName) throw new Error('Patient Name is required');
  if(!uhid) throw new Error('UHID is required');
  if(age===null) throw new Error('Age is required');
  if(!fio2) throw new Error('FiO₂ category is required');

  const chronic = radioVal('chronic');
  const surgtype = chronic === 'Yes' ? radioVal('surgtype') : null;

  const pao2   = fio2 === '<50%' ? valNum('pao2')   : null;
  const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;
  if (fio2 === '<50%' && pao2===null) throw new Error('PaO₂ is required when FiO₂ < 50%');
  if (fio2 !== '<50%' && aagrad===null) throw new Error('A–a gradient is required when FiO₂ ≥ 50%');

  return {
    clientId: $('clientId') ? $('clientId').value.trim() : 'NURSING-STATION-01',
    authToken: (MODE==='online')
      ? (($('onlineSecret') && $('onlineSecret').value.trim()) || ONLINE_SECRET || '')
      : (($('authToken') && $('authToken').value.trim()) || ''),
    patientName, uhid, timestamp:new Date().toISOString(), submissionId:uuidv4(),
    apacheInputs:{
      Age_years: age, GCS: valNum('gcs'),
      Temperature_F: valNum('tempF'), MAP_mmHg: valNum('map'),
      HeartRate_bpm: valNum('hr'), RespRate_bpm: valNum('rr'),
      FiO2_Category: fio2, PaO2_mmHg: pao2, AaGradient_mmHg: aagrad,
      pH: valNum('ph'), HCO3_mEqL: valNum('hco3'), Na_mEqL: valNum('na'),
      K_mEqL: valNum('k'), Creatinine_mgdl: valNum('cr'),
      AcuteRenalFailure: radioVal('arf')==='Yes',
      Hematocrit_pct: valNum('hct'), WBC_10e3uL: valNum('wbc'),
      ChronicHealth: chronic==='Yes'?'Yes':'No', SurgeryType: surgtype
    }
  };
}

/* Networking */
async function sendJson(url, payload, label){
  const body = JSON.stringify(payload);
  let res;
  try{
    res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body});
  }catch(err){
    if(err instanceof TypeError){
      const origin = window.location.origin === 'null' ? 'file://' : window.location.origin;
      const advice = navigator.onLine === false
        ? 'You appear to be offline. Check your internet connection.'
        : (origin === 'file://'
            ? 'Please open this tool through https:// (or a local web server) instead of double-clicking the HTML file.'
            : 'The request was blocked before reaching the server. Check your firewall/VPN allow-list.');
      throw new Error(`${label} request failed: ${err.message}. ${advice}`);
    }
    throw err;
  }

  const text = await res.text().catch(()=> '');
  if(!res.ok){
    const bodyHint = text ? ` ${text}` : '';
    throw new Error(`${label} responded with ${res.status}.${bodyHint}`);
  }

  if(!text) return {};
  try{
    const data = JSON.parse(text);
    if(data && typeof data === 'object' && data.error){
      throw new Error(`${label} error: ${data.error}`);
    }
    return data;
  }catch(_){
    return { message: text };
  }
}

async function postOnline(payload){
  const url = ($('onlineUrl')?.value.trim() || ONLINE_WEBHOOK_URL || "");
  if (!url) throw new Error("Online Webhook URL not set (Developer → Online Webhook URL).");
  if (!payload.authToken) throw new Error("Online Secret not set (Developer → Online Secret).");

  return sendJson(url, payload, 'Google Sheets webhook');
}

async function postDesktop(payload){
  return sendJson(SERVER_HTTP_URL, payload, 'Desktop bridge');
}

function waitForAckWS(submissionId, onAck, onError){
  try{
    const url=new URL(SERVER_WS_URL);
    url.searchParams.set('clientId', $('clientId')?$('clientId').value.trim():'');
    url.searchParams.set('submissionId', submissionId);
    const ws=new WebSocket(url.toString());
    ws.onmessage = ev => { try{ const m=JSON.parse(ev.data); if(m.status==='SUCCESS'||m.status==='ERROR'||m.clientId){ onAck(m); ws.close(); } }catch(e){} };
    ws.onerror = ()=> onError(new Error('WS error'));
    return ws;
  }catch(e){ onError(e); return null; }
}

/* Download current month (Online) */
$('btnDownload').addEventListener('click', ()=>{
  try{
    const url = ($('onlineUrl')?.value.trim() || ONLINE_WEBHOOK_URL || "");
    const secret = ($('onlineSecret')?.value.trim() || ONLINE_SECRET || "");
    if (!url || !secret) { toast("Set Online URL and Secret in Developer panel.", false); return; }
    const ym = new Date().toISOString().slice(0,7);
    const link = url + "?action=download&month=" + encodeURIComponent(ym) + "&auth=" + encodeURIComponent(secret);
    window.open(link, "_blank");
  }catch(e){ toast(e.message, false); }
});

/* Buttons */
$('btnPreview').addEventListener('click', ()=>{
  try{ const p=buildPayload(); $('preview').textContent=JSON.stringify(p,null,2); $('previewwrap').style.display='block'; toast('Preview ready'); }
  catch(e){ toast(e.message,false); }
});

$('btnSubmit').addEventListener('click', async (ev)=>{
  ev.preventDefault(); const b=$('btnSubmit'); b.disabled=true;
  try{
    saveDevOverrides(); // persist dev fields
    const payload=buildPayload();
    $('preview').textContent=JSON.stringify(payload,null,2); $('previewwrap').style.display='block';

    if (MODE==='online'){
      toast('Sending to Google Sheets…');
      await postOnline(payload);
      toast('Saved to Google Sheets ✅');
    } else {
      toast('Sending to desktop…');
      await postDesktop(payload);
      let acked=false; const t=setTimeout(()=>{ if(!acked) toast('Submitted. Waiting for desktop…'); }, 1200);
      waitForAckWS(payload.submissionId,
        ack=>{ acked=true; clearTimeout(t);
          if(ack.status==='SUCCESS') toast('Saved on desktop ✅');
          else if(ack.status==='ERROR') toast('Desktop error: '+(ack.message||'unknown'), false);
          else toast('Submitted. Check desktop.');
        },
        ()=> toast('Submitted. No live ack yet.')
      );
    }
  }catch(e){ toast('Submit failed: '+e.message, false); }
  finally{ b.disabled=false; }
});
</script>
</body>
</html>
