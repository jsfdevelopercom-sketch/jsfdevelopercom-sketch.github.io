<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>APACHE II Bedside Entry</title>

<!--
================================================================================
APACHE II Bedside Entry — HTML (Tightly synced to latest Apps Script bridge)

THIS FILE IS BUILT TO MATCH YOUR LATEST SCRIPT EXACTLY.

SERVER EXPECTATIONS (from your script)
-------------------------------------
1) SUBMIT (POST /exec) expects JSON body:
   {
     authToken: "<ONLINE_SECRET>",
     month: "YYYY-MM",
     sheetRow: [
       UHID, Patient Name, Age, Sex, Diagnosis, Admission Date, Apache Score, Mortality percentage, Mortality(Y/N)
     ]
   }

2) TAG routes (LIST / KP / COUNT) require auth in query/body:
   auth/authToken/token/key/secret must equal ONLINE_SECRET

3) Bridge mode must be used for cross-origin reliability:
   Add ?bridge=1
   Server responds with HTML that postMessage({type:"APACHE_BRIDGE", data:<JSON>})

KEY FIXES IMPLEMENTED HERE (your 4 points)
------------------------------------------
(1) LIST not populating:
    - Uses TAG=LIST + auth in QUERY + bridge=1 via hidden iframe transport.
    - Uses month selector; default current IST month computed client-side.

(2) Bridge timeout with no console error:
    - Verbose logging: every request logs start, URL, payload size, timeout value.
    - On timeout: shows detailed toast + dumps diagnostics to on-screen log.
    - Also logs the raw postMessage reception event.

(3) KP success UX:
    - KP runs via bridge POST (not GET) so long UHID lists are safe.
    - On server ok:true: shows success summary THEN clears the KP "pending table".

(4) Tight sync:
    - Uses tag/customTag exactly as script parses (tag -> uppercased).
    - Uses auth fields exactly as script checks (auth in query for LIST/COUNT, auth in body for KP).
    - Uses action=check via bridge GET with uhid + patientName + month.

HOW TO USE
----------
- Put your Apps Script Web App /exec URL in the Dev panel.
- Put the ONLINE_SECRET in the Dev panel.
- The top-right ⚙️ opens the Admin overlay:
   - Live List (UHID + Name)
   - Update Mortality (KP builder + submit)
================================================================================
-->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    color-scheme: light;
    --surface: rgba(255,255,255,0.90);
    --surface-strong: rgba(255,255,255,0.98);
    --outline: rgba(148,163,184,0.40);
    --muted:#475569; --text:#0f172a;
    --accent:#2563eb; --accent-dark:#1d4ed8;

    --bg:
      radial-gradient(circle at 10% 0%, rgba(59,130,246,.22), transparent 45%),
      radial-gradient(circle at 90% 0%, rgba(14,165,233,.18), transparent 40%),
      linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 55%,#f8fafc 100%);

    --shadow: 0 30px 60px -25px rgba(15,23,42,.35);
    --shadow-soft: 0 20px 50px -30px rgba(15,23,42,.35);

    --radius-lg: 26px; --radius-md:18px; --radius-sm:12px;
    --max: 1260px;

    font-synthesis:none; text-rendering:optimizeLegibility;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    font-family:Inter,system-ui,-apple-system,"Segoe UI",sans-serif;
    color:var(--text);
    background:var(--bg);
    display:flex;
    flex-direction:column;
  }

  .masthead{
    padding:clamp(22px,5vw,42px) clamp(18px,7vw,64px) clamp(20px,5vw,38px);
    position:relative;
    overflow:hidden;
  }
  .masthead::before{
    content:"";
    position:absolute;
    inset:12% auto -20% 50%;
    width:clamp(240px,40vw,520px);
    height:clamp(240px,45vw,560px);
    background:radial-gradient(circle, rgba(37,99,235,.45), transparent 70%);
    transform:translateX(-50%) rotate(18deg);
    filter:blur(42px);
    opacity:.55;
  }
  .mast-inner{
    position:relative;
    z-index:1;
    max-width:var(--max);
    margin:0 auto;
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .topline{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:14px;
    min-width:0;
  }
  .mark{
    width:48px;height:48px;
    border-radius:16px;
    background:linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.70));
    display:grid;place-items:center;
    color:#fff;
    font-family:"Plus Jakarta Sans",Inter,sans-serif;
    font-weight:800;
    box-shadow:var(--shadow-soft);
    flex:0 0 auto;
  }
  .brand h1{
    margin:0;
    font-family:"Plus Jakarta Sans",Inter,sans-serif;
    font-size:clamp(24px,4.2vw,40px);
    letter-spacing:-.02em;
    line-height:1.1;
  }
  .brand p{
    margin:6px 0 0;
    color:var(--muted);
    font-size:14px;
    line-height:1.5;
    max-width:640px;
  }

  .gear{
    width:42px;height:42px;
    border-radius:50%;
    border:1px solid rgba(255,255,255,.7);
    background:rgba(15,23,42,.78);
    color:#e2e8f0;
    display:grid;place-items:center;
    cursor:pointer;
    box-shadow:0 16px 40px -20px rgba(15,23,42,.65);
    backdrop-filter:blur(12px);
    transition:transform .18s ease;
    flex:0 0 auto;
  }
  .gear:hover{transform:translateY(-1px)}
  .gear:active{transform:translateY(0)}

  .workspace-wrap{
    flex:1;
    padding:0 clamp(18px,7vw,64px) 160px;
  }
  .workspace{
    max-width:var(--max);
    margin:0 auto;
    display:grid;
    gap:18px;
  }

  .panel{
    background:var(--surface);
    border-radius:var(--radius-lg);
    border:1px solid var(--outline);
    padding:clamp(16px,3vw,26px);
    box-shadow:var(--shadow-soft);
    backdrop-filter:blur(14px);
    display:grid;
    gap:16px;
  }
  .panel header{display:grid;gap:6px}
  .panel h2{margin:0;font-size:18px;font-weight:800;letter-spacing:-.01em}
  .hint{margin:0;color:var(--muted);font-size:13px;line-height:1.45}

  label{font-weight:700;font-size:13px;color:#1e293b;display:block;margin:0 0 6px}
  .input, select, textarea{
    width:100%;
    padding:12px 14px;
    border-radius:var(--radius-sm);
    border:1px solid rgba(148,163,184,.55);
    background:rgba(248,250,252,.92);
    font-size:14px;
    transition:border .18s ease, box-shadow .18s ease, background .18s ease;
  }
  .input:focus, select:focus, textarea:focus{
    outline:none;
    border-color:rgba(37,99,235,.6);
    box-shadow:0 0 0 4px rgba(37,99,235,.15);
    background:#fff;
  }
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

  .grid-2{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .grid-3{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:9px 12px;border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background:rgba(148,163,184,.12);
    font-weight:800;
    color:#0f172a;
    font-size:12px;
  }

  .action-dock{
    position:fixed;
    left:0;right:0;bottom:0;
    padding:14px clamp(18px,7vw,64px) max(env(safe-area-inset-bottom,20px),18px);
    background:rgba(255,255,255,.96);
    border-top:1px solid rgba(148,163,184,.35);
    box-shadow:0 -18px 42px -24px rgba(15,23,42,.45);
    backdrop-filter:blur(16px);
    z-index:140;
  }
  .dock-inner{
    max-width:var(--max);
    margin:0 auto;
    display:grid;
    gap:10px;
  }
  .btn-row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .btn{
    border-radius:var(--radius-md);
    border:1px solid transparent;
    padding:14px 16px;
    font-weight:800;
    font-size:15px;
    cursor:pointer;
    transition:transform .15s ease, opacity .15s ease;
  }
  .btn.primary{
    background:linear-gradient(135deg,#2563eb,#1e40af);
    color:#fff;
    box-shadow:0 20px 40px -18px rgba(37,99,235,.55);
  }
  .btn.secondary{
    background:rgba(37,99,235,.10);
    color:var(--accent-dark);
    border:1px solid rgba(37,99,235,.20);
  }
  .btn.ghost{
    background:transparent;
    color:var(--muted);
    border:1px solid rgba(148,163,184,.35);
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.primary:hover:not(:disabled){transform:translateY(-1px)}
  .btn:active:not(:disabled){transform:translateY(0)}

  .toast{
    position:fixed;
    right:clamp(14px,4vw,56px);
    bottom:clamp(110px,10vw,170px);
    min-width:min(420px,calc(100vw - 28px));
    background:#fff;
    border-radius:var(--radius-md);
    border-left:5px solid #16a34a;
    padding:14px 16px;
    box-shadow:var(--shadow);
    font-weight:700;
    color:var(--text);
    display:none;
    z-index:260;
  }
  .toast.err{border-left-color:#dc2626;color:#b91c1c}
  .toast.warn{border-left-color:#f59e0b;color:#92400e}
  .toast small{display:block;margin-top:6px;font-weight:600;color:rgba(15,23,42,.65)}

  /* =========================
     ADMIN OVERLAY (settings)
     ========================= */
  .admin-backdrop,.admin-panel{position:fixed;inset:0;z-index:300}
  .admin-backdrop{
    background:rgba(15,23,42,.55);
    backdrop-filter:blur(6px);
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
  }
  .admin-backdrop[data-visible="true"]{opacity:1;pointer-events:auto}

  .admin-panel{
    display:grid;
    place-items:center;
    opacity:0;
    visibility:hidden;
    pointer-events:none;
    transition:opacity .18s ease, visibility .18s ease;
  }
  .admin-panel[aria-hidden="false"]{
    opacity:1;
    visibility:visible;
    pointer-events:auto;
  }

  .admin-sheet{
    width:min(980px,calc(100vw - 20px));
    background:#0f172a;
    color:#f8fafc;
    border-radius:26px;
    border:1px solid rgba(148,163,184,.35);
    box-shadow:0 30px 80px -30px rgba(15,23,42,.85);
    padding:16px;
    display:grid;
    gap:12px;
    max-height:min(88vh, 820px);
    overflow:hidden; /* inner scroll areas forced below */
  }
  .admin-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:4px 6px 0;
  }
  .admin-title{
    margin:0;
    font-size:18px;
    font-weight:900;
    letter-spacing:-.01em;
  }
  .admin-sub{
    margin:2px 0 0;
    font-size:12px;
    color:rgba(226,232,240,.72);
    line-height:1.35;
  }
  .admin-close{
    border:0;
    background:rgba(148,163,184,.15);
    color:#e2e8f0;
    border-radius:999px;
    padding:8px 12px;
    cursor:pointer;
    font-weight:900;
  }

  /* COMPULSORY scrollbars (both directions) */
  .admin-body{
    display:grid;
    gap:12px;
    overflow:scroll;                 /* ALWAYS visible */
    scrollbar-gutter: stable both-edges;
    padding:0 6px 6px;
    max-height:min(76vh, 700px);
  }

  .admin-card{
    border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.35);
    border-radius:18px;
    padding:12px;
    display:grid;
    gap:10px;
  }
  .admin-card h4{margin:0;font-size:14px;font-weight:900}
  .admin-minihelp{margin:0;color:rgba(226,232,240,.70);font-size:12px;line-height:1.4}

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    border:1px solid rgba(148,163,184,.28);
    background:rgba(15,23,42,.45);
    color:#e2e8f0;
    padding:8px 12px;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    font-size:13px;
  }
  .tab.active{
    background:linear-gradient(135deg,#2563eb,#14a3e9);
    border-color:transparent;
  }
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .admin-sheet label{color:#cbd5f5}
  .admin-sheet .input{
    background:rgba(15,23,42,.75);
    color:#f8fafc;
    border:1px solid rgba(148,163,184,.40);
  }
  .admin-sheet select.input{appearance:none}

  /* Table wrapper with forced scrollbars (both directions) */
  .table-wrap{
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background:rgba(2,6,23,.35);
    overflow:scroll;
    scrollbar-gutter: stable both-edges;
    max-height:340px;
  }
  table.admin-table{
    border-collapse:collapse;
    width:max(1100px,100%);
    font-size:13px;
  }
  table.admin-table th, table.admin-table td{
    padding:10px 10px;
    border-bottom:1px solid rgba(148,163,184,.16);
    white-space:nowrap;
    text-align:left;
    vertical-align:top;
  }
  table.admin-table th{
    position:sticky;
    top:0;
    z-index:2;
    background:rgba(15,23,42,.95);
    color:#e2e8f0;
    font-weight:900;
  }

  .admin-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:end;
  }
  .admin-actions .btn{padding:10px 12px;font-size:13px}
  .admin-actions .btn.primary{box-shadow:none}

  .kp-grid{
    display:grid;
    grid-template-columns:1fr 140px auto;
    gap:10px;
    align-items:end;
  }
  @media (max-width:720px){
    .kp-grid{grid-template-columns:1fr}
  }

  .logbox{
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background:rgba(2,6,23,.35);
    padding:10px;
    overflow:auto;
    max-height:180px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    font-size:12px;
    color:rgba(226,232,240,.86);
    white-space:pre-wrap;
    line-height:1.35;
  }

  /* Hidden bridge iframe */
  #bridgeFrame{
    position:absolute;
    left:-9999px;
    top:-9999px;
    width:1px;height:1px;
    border:0;
    opacity:0;
    pointer-events:none;
  }
</style>
</head>

<body>

<section class="masthead">
  <div class="mast-inner">
    <div class="topline">
      <div class="brand">
        <div class="mark">A2</div>
        <div style="min-width:0">
          <h1>APACHE II Bedside Entry</h1>
          <p>Fast submit + reliable LIST/KP/COUNT via <b>bridge=1</b>. Admin overlay (⚙️) shows live UHID list and lets you update mortality (KP).</p>
        </div>
      </div>
      <button class="gear" id="openAdminBtn" title="Admin / List / KP">⚙️</button>
    </div>

    <div class="row">
      <span class="pill" id="pillMonth">Month: —</span>
      <span class="pill" id="pillBridge">Bridge: idle</span>
      <span class="pill" id="pillDup">Duplicate: —</span>
      <span class="pill" id="pillReq">Last reqId: —</span>
    </div>
  </div>
</section>

<main class="workspace-wrap">
  <div class="workspace">
    <section class="panel">
      <header>
        <h2>Patient + Admission</h2>
        <p class="hint">These fields map 1:1 to your sheetRow order in the Apps Script (UHID → Mortality(Y/N)).</p>
      </header>

      <div class="grid-3">
        <div>
          <label>UHID</label>
          <input class="input" id="uhid" placeholder="e.g. 123456" inputmode="numeric" />
        </div>
        <div>
          <label>Patient Name</label>
          <input class="input" id="patientName" placeholder="e.g. Ravi Kumar" />
        </div>
        <div>
          <label>Sex</label>
          <select class="input" id="sex">
            <option value="">Select…</option>
            <option value="M">M</option>
            <option value="F">F</option>
            <option value="O">O</option>
          </select>
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Age (years)</label>
          <input class="input" id="age" type="number" min="0" step="1" placeholder="e.g. 61" />
        </div>
        <div>
          <label>Admission Date</label>
          <input class="input" id="admissionDate" placeholder="YYYY-MM-DD or DD/MM/YYYY" />
        </div>
        <div>
          <label>Diagnosis</label>
          <input class="input" id="diagnosis" placeholder="Short diagnosis" />
        </div>
      </div>
    </section>

    <section class="panel">
      <header>
        <h2>APACHE II Calculator (client-side)</h2>
        <p class="hint">This computes <b>Apache Score</b> and a simple <b>Mortality % band</b>. You can overwrite before submit if needed.</p>
      </header>

      <div class="grid-3">
        <div>
          <label>Temp (°C)</label>
          <input class="input" id="vTemp" type="number" step="0.1" placeholder="e.g. 38.2" />
        </div>
        <div>
          <label>MAP (mmHg)</label>
          <input class="input" id="vMap" type="number" step="1" placeholder="e.g. 75" />
        </div>
        <div>
          <label>HR (/min)</label>
          <input class="input" id="vHr" type="number" step="1" placeholder="e.g. 112" />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>RR (/min)</label>
          <input class="input" id="vRr" type="number" step="1" placeholder="e.g. 28" />
        </div>
        <div>
          <label>FiO₂ (0.21–1.0)</label>
          <input class="input" id="vFiO2" type="number" step="0.01" placeholder="e.g. 0.5" />
        </div>
        <div>
          <label>PaO₂ (mmHg)</label>
          <input class="input" id="vPaO2" type="number" step="1" placeholder="e.g. 70" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>A–a gradient (mmHg) <span style="font-weight:600;color:var(--muted)">(optional; used if FiO₂ ≥ 0.5)</span></label>
          <input class="input" id="vAaGrad" type="number" step="1" placeholder="e.g. 250" />
        </div>
        <div>
          <label>Arterial pH</label>
          <input class="input" id="vPh" type="number" step="0.01" placeholder="e.g. 7.28" />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Na (mmol/L)</label>
          <input class="input" id="vNa" type="number" step="1" placeholder="e.g. 132" />
        </div>
        <div>
          <label>K (mmol/L)</label>
          <input class="input" id="vK" type="number" step="0.1" placeholder="e.g. 4.2" />
        </div>
        <div>
          <label>Creatinine (mg/dL)</label>
          <input class="input" id="vCr" type="number" step="0.1" placeholder="e.g. 2.1" />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Hematocrit (%)</label>
          <input class="input" id="vHct" type="number" step="0.1" placeholder="e.g. 30" />
        </div>
        <div>
          <label>WBC (×10⁹/L)</label>
          <input class="input" id="vWbc" type="number" step="0.1" placeholder="e.g. 24" />
        </div>
        <div>
          <label>GCS</label>
          <input class="input" id="vGcs" type="number" step="1" min="3" max="15" placeholder="3–15" />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Acute renal failure?</label>
          <select class="input" id="vArf">
            <option value="N">No</option>
            <option value="Y">Yes</option>
          </select>
        </div>
        <div>
          <label>Chronic health points</label>
          <select class="input" id="vChronic">
            <option value="0">None</option>
            <option value="2">Nonoperative / emergency? (2)</option>
            <option value="5">Postoperative? (5)</option>
          </select>
        </div>
        <div>
          <label>Override Mortality(Y/N)</label>
          <select class="input" id="mortYN">
            <option value="N">N</option>
            <option value="Y">Y</option>
          </select>
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Apache Score (computed)</label>
          <input class="input" id="apacheScore" type="number" step="1" />
        </div>
        <div>
          <label>Mortality % (band)</label>
          <input class="input" id="mortPct" type="number" step="0.1" />
        </div>
        <div>
          <label>Notes (optional; not sent)</label>
          <input class="input" id="localNotes" placeholder="Local note (not posted)" />
        </div>
      </div>
    </section>

    <section class="panel">
      <header>
        <h2>Diagnostics (client)</h2>
        <p class="hint">This is for visibility only. The admin overlay has the verbose bridge log.</p>
      </header>
      <div class="row">
        <button class="btn ghost" id="btnRecalc">Recalculate APACHE</button>
        <button class="btn ghost" id="btnCheckDup">Check duplicate (bridge)</button>
        <button class="btn ghost" id="btnPing">Ping server (bridge)</button>
      </div>
    </section>
  </div>
</main>

<!-- Action Dock -->
<footer class="action-dock">
  <div class="dock-inner">
    <div class="btn-row">
      <button class="btn primary" id="btnSubmit">Submit to Google Sheets (bridge)</button>
      <button class="btn secondary" id="btnDownload">Download current month (CSV)</button>
      <button class="btn ghost" id="btnOpenAdmin2">Open Admin (LIST/KP)</button>
    </div>
  </div>
</footer>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Hidden iframe used for ALL bridge requests -->
<iframe id="bridgeFrame" name="apache_bridge_iframe"></iframe>

<!-- ADMIN OVERLAY -->
<div class="admin-backdrop" id="adminBackdrop" data-visible="false"></div>
<div class="admin-panel" id="adminPanel" aria-hidden="true">
  <div class="admin-sheet" role="dialog" aria-modal="true" aria-label="Admin Panel">
    <div class="admin-top">
      <div>
        <p class="admin-title">Admin — Live List + Update Mortality (KP)</p>
        <p class="admin-sub">Uses <b>tag=LIST</b>, <b>tag=KP</b>, <b>tag=COUNT</b> with auth. Bridge transport logs everything here.</p>
      </div>
      <button class="admin-close" id="adminCloseBtn">Close</button>
    </div>

    <div class="admin-body">
      <div class="admin-card">
        <div class="tabs">
          <button class="tab active" id="tabListBtn">Live List</button>
          <button class="tab" id="tabKpBtn">Update Mortality (KP)</button>
          <button class="tab" id="tabDevBtn">Dev / Logs</button>
        </div>
      </div>

      <!-- LIST TAB -->
      <div class="admin-card tab-panel active" id="tabList">
        <h4>Live UHID + Name (TAG: LIST)</h4>
        <p class="admin-minihelp">Fetches <b>patients[]</b> from server response. If this is empty, the log below will show exactly why (timeout/auth/month).</p>

        <div class="admin-actions">
          <div style="min-width:200px;flex:1">
            <label>Month (YYYY-MM)</label>
            <input class="input" id="adminMonth" placeholder="YYYY-MM" />
          </div>
          <div style="width:130px">
            <label>Limit</label>
            <input class="input" id="adminLimit" type="number" min="1" max="5000" step="1" value="500" />
          </div>
          <div style="width:130px">
            <label>Offset</label>
            <input class="input" id="adminOffset" type="number" min="0" step="1" value="0" />
          </div>
          <button class="btn secondary" id="btnList">Refresh LIST</button>
          <button class="btn ghost" id="btnCount">COUNT all</button>
        </div>

        <div class="row">
          <span class="pill" id="listStatus">Status: idle</span>
          <span class="pill" id="listMeta">Total: —</span>
        </div>

        <div class="table-wrap">
          <table class="admin-table" id="listTable">
            <thead>
              <tr>
                <th>#</th>
                <th>UHID</th>
                <th>Name</th>
              </tr>
            </thead>
            <tbody id="listTbody">
              <tr><td colspan="3" style="color:rgba(226,232,240,.7)">No data yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- KP TAB -->
      <div class="admin-card tab-panel" id="tabKp">
        <h4>Update Mortality by UHID (TAG: KP)</h4>
        <p class="admin-minihelp">
          Add UHIDs to the pending list, then send one KP request.
          On <b>ok:true</b> response: shows success summary + clears the pending table.
        </p>

        <div class="kp-grid">
          <div>
            <label>UHID</label>
            <input class="input" id="kpUhid" placeholder="Enter UHID and press ADD" />
          </div>
          <div>
            <label>Mortality (Y/N)</label>
            <select class="input" id="kpMort">
              <option value="Y">Y</option>
              <option value="N">N</option>
            </select>
          </div>
          <button class="btn secondary" id="btnAddKp">ADD</button>
        </div>

        <div class="admin-actions" style="margin-top:8px">
          <button class="btn primary" id="btnSendKp">Send KP (bridge POST)</button>
          <button class="btn ghost" id="btnClearKp">Clear pending list</button>
          <span class="pill" id="kpStatus">Pending: 0</span>
        </div>

        <div class="table-wrap" style="max-height:260px">
          <table class="admin-table" id="kpTable">
            <thead>
              <tr>
                <th>#</th>
                <th>UHID</th>
                <th>Mortality</th>
              </tr>
            </thead>
            <tbody id="kpTbody">
              <tr><td colspan="3" style="color:rgba(226,232,240,.7)">No pending UHIDs.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="admin-card" style="background:rgba(2,6,23,.25)">
          <h4>Last KP Result (summary)</h4>
          <div class="logbox" id="kpResultBox">No KP run yet.</div>
        </div>
      </div>

      <!-- DEV / LOGS TAB -->
      <div class="admin-card tab-panel" id="tabDev">
        <h4>Dev Settings + Verbose Bridge Log</h4>
        <p class="admin-minihelp">
          These values are stored in <b>localStorage</b>. The secret must match your script's ONLINE_SECRET.
        </p>

        <div class="grid-2">
          <div>
            <label>Apps Script Web App /exec URL</label>
            <input class="input" id="cfgUrl" placeholder="https://script.google.com/macros/s/.../exec" />
          </div>
          <div>
            <label>ONLINE_SECRET</label>
            <input class="input" id="cfgSecret" placeholder="Paste ONLINE_SECRET here" />
          </div>
        </div>

        <div class="admin-actions">
          <button class="btn secondary" id="btnSaveCfg">Save</button>
          <button class="btn ghost" id="btnClearCfg">Clear</button>
          <button class="btn ghost" id="btnCopyCfg">Copy config</button>
        </div>

        <div class="admin-card" style="background:rgba(2,6,23,.25)">
          <h4>Bridge Log</h4>
          <div class="logbox" id="bridgeLog"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================================================
   CONFIG + STORAGE
   ========================================================================== */

const STORAGE_KEY = "APACHE2_CFG_V1";

function loadCfg(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { url:"", secret:"" };
    const obj = JSON.parse(raw);
    return { url: String(obj.url||""), secret: String(obj.secret||"") };
  }catch(e){
    return { url:"", secret:"" };
  }
}

function saveCfg(cfg){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ url: cfg.url || "", secret: cfg.secret || "" }));
}

function clearCfg(){
  localStorage.removeItem(STORAGE_KEY);
}

/* ============================================================================
   IST MONTH HELPERS (client-side)
   - Server uses Asia/Kolkata. We compute month similarly for default UI.
   ========================================================================== */

function pad2(n){ return String(n).padStart(2,"0"); }

function monthIST(){
  // Using Intl with Asia/Kolkata to avoid local timezone mismatch.
  const dt = new Date();
  const parts = new Intl.DateTimeFormat("en-CA", { timeZone:"Asia/Kolkata", year:"numeric", month:"2-digit" }).formatToParts(dt);
  const y = parts.find(p=>p.type==="year")?.value || String(dt.getFullYear());
  const m = parts.find(p=>p.type==="month")?.value || pad2(dt.getMonth()+1);
  return `${y}-${m}`;
}

/* ============================================================================
   TOAST + LOGGING (verbosity fix)
   ========================================================================== */

const toastEl = document.getElementById("toast");
const logEl = document.getElementById("bridgeLog");
const pillBridge = document.getElementById("pillBridge");
const pillReq = document.getElementById("pillReq");

function nowStamp(){
  const dt = new Date();
  return dt.toISOString().replace("T"," ").replace("Z","");
}

function logLine(msg, obj){
  const line = `[${nowStamp()}] ${msg}` + (obj ? ` :: ${safeJson(obj)}` : "");
  console.log(line);
  if(logEl){
    logEl.textContent = (logEl.textContent ? (logEl.textContent + "\n") : "") + line;
    logEl.scrollTop = logEl.scrollHeight;
  }
}

function safeJson(x){
  try{
    return JSON.stringify(x, (k,v)=>{
      if(typeof v === "string" && v.length > 800) return v.slice(0,800)+"…";
      return v;
    });
  }catch(e){
    return String(x);
  }
}

function showToast(type, title, detail){
  toastEl.className = "toast" + (type ? (" " + type) : "");
  toastEl.innerHTML = `<div>${escapeHtml(title || "")}</div>` + (detail ? `<small>${escapeHtml(detail)}</small>` : "");
  toastEl.style.display = "block";
  setTimeout(()=>{ toastEl.style.display = "none"; }, 5200);
}

function escapeHtml(s){
  return String(s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ============================================================================
   BRIDGE TRANSPORT (single outstanding request to avoid cross-talk)
   - Uses hidden iframe + postMessage from your server's _bridgeHtml_.
   - Works for BOTH GET and POST via form-target to iframe.
   ========================================================================== */

const bridgeFrame = document.getElementById("bridgeFrame");

// one-at-a-time pending request (keeps message correlation deterministic)
let pending = null;

// receive server postMessage
window.addEventListener("message", (ev)=>{
  const msg = ev && ev.data;
  if(!msg || msg.type !== "APACHE_BRIDGE") return;

  logLine("bridge: postMessage received", {
    origin: ev.origin,
    hasData: !!msg.data,
    keys: msg.data ? Object.keys(msg.data) : []
  });

  if(!pending){
    logLine("bridge: received message but no pending request (ignored)", msg.data);
    return;
  }

  // resolve pending
  clearTimeout(pending.timer);
  pillBridge.textContent = "Bridge: idle";
  const resolve = pending.resolve;
  pending = null;

  try{
    resolve(msg.data);
  }catch(e){
    // nothing else
  }
});

function buildUrl(base, params){
  const u = new URL(base);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v === undefined || v === null || String(v).trim()==="") return;
    u.searchParams.set(k, String(v));
  });
  return u.toString();
}

function requireCfg(){
  const cfg = loadCfg();
  if(!cfg.url || !cfg.secret){
    showToast("err", "Missing config", "Open ⚙️ → Dev / Logs and set /exec URL + ONLINE_SECRET.");
    throw new Error("Missing config (url/secret)");
  }
  return cfg;
}

/**
 * Bridge GET (loads iframe src with bridge=1, waits for postMessage)
 */
function bridgeGet(params, timeoutMs){
  const cfg = requireCfg();

  // IMPORTANT: server checks bridge via e.parameter.bridge
  const url = buildUrl(cfg.url, Object.assign({}, params, { bridge:"1" }));

  return bridgeSend({ method:"GET", url, timeoutMs: timeoutMs || 12000 });
}

/**
 * Bridge POST (submits a hidden form to iframe, encoded as x-www-form-urlencoded)
 * The Apps Script accepts json=... via _safeReadBody_/_readBody_
 */
function bridgePost(params, bodyObj, timeoutMs){
  const cfg = requireCfg();

  const url = buildUrl(cfg.url, Object.assign({}, params, { bridge:"1" }));
  const payload = bodyObj || {};

  return bridgeSend({ method:"POST", url, body: payload, timeoutMs: timeoutMs || 15000 });
}

function bridgeSend(req){
  if(pending){
    // serialize: reject fast + show reason (prevents overlapping timeouts)
    const msg = "Bridge busy (previous request still pending).";
    logLine(msg, pending.meta);
    showToast("warn", msg, "Wait for the current request to finish.");
    return Promise.reject(new Error(msg));
  }

  const startedAt = Date.now();
  const timeoutMs = Number(req.timeoutMs || 12000);

  pillBridge.textContent = "Bridge: working…";

  logLine("bridge: request start", {
    method: req.method,
    url: req.url,
    timeoutMs,
    bodyBytes: req.body ? safeJson(req.body).length : 0
  });

  return new Promise((resolve, reject)=>{
    const timer = setTimeout(()=>{
      const dt = Date.now() - startedAt;
      pillBridge.textContent = "Bridge: idle";
      const meta = pending ? pending.meta : null;
      pending = null;

      const detail = `Timeout after ${dt}ms. ${meta ? "Last URL: " + meta.url : ""}`;
      logLine("bridge: TIMEOUT", { dt, meta });
      showToast("err", "Bridge post timeout", detail);
      reject(new Error(detail));
    }, timeoutMs);

    pending = {
      resolve, reject, timer,
      meta: { method:req.method, url:req.url, timeoutMs }
    };

    try{
      if(req.method === "GET"){
        bridgeFrame.src = req.url;
        return;
      }

      // POST via hidden form to iframe
      const form = document.createElement("form");
      form.method = "POST";
      form.action = req.url;
      form.target = bridgeFrame.name;
      form.style.display = "none";

      // x-www-form-urlencoded is default encoding; server reads json=
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "json";
      input.value = JSON.stringify(req.body || {});
      form.appendChild(input);

      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>{ try{ form.remove(); }catch(e){} }, 0);

    }catch(e){
      clearTimeout(timer);
      pillBridge.textContent = "Bridge: idle";
      pending = null;
      logLine("bridge: send failed", { err: String(e && e.message ? e.message : e) });
      showToast("err", "Bridge send failed", String(e && e.message ? e.message : e));
      reject(e);
    }
  }).then((data)=>{
    const dt = Date.now() - startedAt;
    pillBridge.textContent = "Bridge: idle";

    // Verbose: show reqId if present
    if(data && data.reqId){
      pillReq.textContent = "Last reqId: " + data.reqId;
    }

    logLine("bridge: response", {
      dt,
      ok: data ? data.ok : null,
      reqId: data ? data.reqId : null,
      tag: data ? data.tag : null,
      error: data ? data.error : null,
      warnings: data ? data.warnings : null
    });

    // Surface server warnings/errors visually (helps debugging silent failures)
    if(data && data.ok === false){
      showToast("err", "Server error", (data.error || "Unknown error") + (data.reqId ? (" | reqId: " + data.reqId) : ""));
    }else if(data && Array.isArray(data.warnings) && data.warnings.length){
      showToast("warn", "Server warnings", data.warnings.slice(0,2).join(" | "));
    }

    return data;
  });
}

/* ============================================================================
   SERVER ROUTES — EXACTLY MATCH YOUR SCRIPT
   ========================================================================== */

// TAG constants (must match server)
const TAG_LIST  = "LIST";
const TAG_KP    = "KP";
const TAG_COUNT = "COUNT";

// ACTION constants
const ACTION_CHECK = "check";
const ACTION_PING  = "ping";

/**
 * LIST patients (TAG: LIST) — AUTH REQUIRED
 * Server returns: { ok, reqId, month, total, returned, offset, limit, patients:[{uhid,name}] }
 */
async function apiListPatients(month, limit, offset){
  const cfg = requireCfg();
  return bridgeGet({
    tag: TAG_LIST,
    auth: cfg.secret,
    month: String(month || ""),
    limit: String(limit || 500),
    offset: String(offset || 0)
  }, 12000);
}

/**
 * COUNT entries (TAG: COUNT) — AUTH REQUIRED
 */
async function apiCountEntries(){
  const cfg = requireCfg();
  return bridgeGet({
    tag: TAG_COUNT,
    auth: cfg.secret
  }, 15000);
}

/**
 * KP (TAG: KP) — AUTH REQUIRED
 * Use POST because uhids list can be large (avoid URL length limits).
 * Server accepts: body.tag/body.customTag + body.uhids/body.uhidList/body.uhid + body.mortality/body.mortYN/body.yn
 */
async function apiKillPatients(uhids, mortality){
  const cfg = requireCfg();
  return bridgePost(
    { /* query params */ },
    {
      tag: TAG_KP,
      auth: cfg.secret,
      uhids: Array.isArray(uhids) ? uhids : [],
      mortality: String(mortality || "Y").toUpperCase()
    },
    15000
  );
}

/**
 * CHECK duplicate (action=check) — NO AUTH REQUIRED in your script, but we still use bridge for CORS safety.
 * Server expects:
 *  - action=check
 *  - month (optional; default IST month)
 *  - uhid
 *  - patientName OR name
 */
async function apiCheckDuplicate(month, uhid, patientName){
  return bridgeGet({
    action: ACTION_CHECK,
    month: String(month || monthIST()),
    uhid: String(uhid || "").trim(),
    patientName: String(patientName || "").trim()
  }, 12000);
}

/**
 * PING (action=ping) — bridge GET
 */
async function apiPing(){
  return bridgeGet({ action: ACTION_PING }, 8000);
}

/**
 * SUBMIT — bridge POST
 * Must match server validation:
 * - authToken must equal ONLINE_SECRET
 * - month must be YYYY-MM
 * - sheetRow must have EXACT 9 cols in EXACT order
 */
async function apiSubmit(payload){
  return bridgePost({}, payload, 15000);
}

/* ============================================================================
   UI: Admin overlay open/close + tab switching
   ========================================================================== */

const adminPanel = document.getElementById("adminPanel");
const adminBackdrop = document.getElementById("adminBackdrop");

function openAdmin(){
  adminBackdrop.dataset.visible = "true";
  adminPanel.setAttribute("aria-hidden","false");

  // default month
  const m = monthIST();
  document.getElementById("adminMonth").value = m;

  // try to auto-refresh list (best-effort)
  refreshList().catch(()=>{});
}

function closeAdmin(){
  adminBackdrop.dataset.visible = "false";
  adminPanel.setAttribute("aria-hidden","true");
}

document.getElementById("openAdminBtn").addEventListener("click", openAdmin);
document.getElementById("btnOpenAdmin2").addEventListener("click", openAdmin);
document.getElementById("adminCloseBtn").addEventListener("click", closeAdmin);
adminBackdrop.addEventListener("click", closeAdmin);

// tabs
const tabListBtn = document.getElementById("tabListBtn");
const tabKpBtn = document.getElementById("tabKpBtn");
const tabDevBtn = document.getElementById("tabDevBtn");

const tabList = document.getElementById("tabList");
const tabKp = document.getElementById("tabKp");
const tabDev = document.getElementById("tabDev");

function setTab(which){
  [tabListBtn, tabKpBtn, tabDevBtn].forEach(b=>b.classList.remove("active"));
  [tabList, tabKp, tabDev].forEach(p=>p.classList.remove("active"));

  if(which==="LIST"){ tabListBtn.classList.add("active"); tabList.classList.add("active"); }
  if(which==="KP"){ tabKpBtn.classList.add("active"); tabKp.classList.add("active"); }
  if(which==="DEV"){ tabDevBtn.classList.add("active"); tabDev.classList.add("active"); }
}

tabListBtn.addEventListener("click", ()=>setTab("LIST"));
tabKpBtn.addEventListener("click", ()=>setTab("KP"));
tabDevBtn.addEventListener("click", ()=>setTab("DEV"));

/* ============================================================================
   Admin LIST UI
   ========================================================================== */

const listStatus = document.getElementById("listStatus");
const listMeta = document.getElementById("listMeta");
const listTbody = document.getElementById("listTbody");

function renderList(patients){
  const arr = Array.isArray(patients) ? patients : [];
  listTbody.innerHTML = "";

  if(arr.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="3" style="color:rgba(226,232,240,.7)">No rows returned.</td>`;
    listTbody.appendChild(tr);
    return;
  }

  arr.forEach((p, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${escapeHtml(p.uhid || "")}</td>
      <td>${escapeHtml(p.name || "")}</td>
    `;
    listTbody.appendChild(tr);
  });
}

async function refreshList(){
  const m = String(document.getElementById("adminMonth").value || "").trim();
  const limit = Number(document.getElementById("adminLimit").value || 500);
  const offset = Number(document.getElementById("adminOffset").value || 0);

  listStatus.textContent = "Status: loading…";
  listMeta.textContent = "Total: —";

  try{
    const resp = await apiListPatients(m, limit, offset);
    if(!resp || resp.ok !== true){
      listStatus.textContent = "Status: failed";
      renderList([]);
      return;
    }

    listStatus.textContent = `Status: ok (returned ${resp.returned || 0})`;
    listMeta.textContent = `Total: ${resp.total || 0} | Offset: ${resp.offset || 0} | Limit: ${resp.limit || limit}`;

    renderList(resp.patients || []);
  }catch(e){
    listStatus.textContent = "Status: timeout/error";
    renderList([]);
    logLine("LIST failed", { err: String(e && e.message ? e.message : e) });
  }
}

document.getElementById("btnList").addEventListener("click", ()=>refreshList());

document.getElementById("btnCount").addEventListener("click", async ()=>{
  try{
    const resp = await apiCountEntries();
    if(resp && resp.ok === true){
      const total = resp.totalEntries || 0;
      showToast("", "COUNT ok", `Total entries: ${total} across ${resp.monthsCounted || 0} months`);
      logLine("COUNT details", resp);
    }
  }catch(e){
    logLine("COUNT failed", { err: String(e && e.message ? e.message : e) });
  }
});

/* ============================================================================
   Admin KP UI
   ========================================================================== */

const kpTbody = document.getElementById("kpTbody");
const kpStatus = document.getElementById("kpStatus");
const kpResultBox = document.getElementById("kpResultBox");

let kpPending = []; // [{uhid, mortality}]

function renderKpPending(){
  kpTbody.innerHTML = "";
  if(kpPending.length === 0){
    kpTbody.innerHTML = `<tr><td colspan="3" style="color:rgba(226,232,240,.7)">No pending UHIDs.</td></tr>`;
    kpStatus.textContent = "Pending: 0";
    return;
  }

  kpPending.forEach((x, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${escapeHtml(x.uhid)}</td>
      <td>${escapeHtml(x.mortality)}</td>
    `;
    kpTbody.appendChild(tr);
  });
  kpStatus.textContent = "Pending: " + kpPending.length;
}

function addKp(){
  const u = String(document.getElementById("kpUhid").value || "").trim();
  const m = String(document.getElementById("kpMort").value || "Y").toUpperCase();

  if(!u){
    showToast("warn","UHID missing","Enter a UHID to add.");
    return;
  }
  if(!/^[YN]$/.test(m)){
    showToast("warn","Bad mortality","Must be Y or N.");
    return;
  }

  // dedupe
  const exists = kpPending.some(x=>x.uhid === u);
  if(exists){
    showToast("warn","Already added",u);
    return;
  }

  kpPending.push({ uhid: u, mortality: m });
  document.getElementById("kpUhid").value = "";
  renderKpPending();
}

function clearKp(){
  kpPending = [];
  renderKpPending();
}

document.getElementById("btnAddKp").addEventListener("click", addKp);
document.getElementById("btnClearKp").addEventListener("click", clearKp);

// Enter key in UHID field
document.getElementById("kpUhid").addEventListener("keydown", (ev)=>{
  if(ev.key === "Enter"){ ev.preventDefault(); addKp(); }
});

document.getElementById("btnSendKp").addEventListener("click", async ()=>{
  if(kpPending.length === 0){
    showToast("warn","Nothing to send","Add at least one UHID.");
    return;
  }

  // IMPORTANT: your server KP takes ONE mortality value per request.
  // If user mixes Y and N in pending list, split into batches by mortality.
  const groupY = kpPending.filter(x=>x.mortality === "Y").map(x=>x.uhid);
  const groupN = kpPending.filter(x=>x.mortality === "N").map(x=>x.uhid);

  kpResultBox.textContent = "Sending KP… (see log for full details)";

  try{
    let summaries = [];

    if(groupY.length){
      const respY = await apiKillPatients(groupY, "Y");
      summaries.push(summarizeKpResp(respY));
    }
    if(groupN.length){
      const respN = await apiKillPatients(groupN, "N");
      summaries.push(summarizeKpResp(respN));
    }

    // Success UX requirement:
    // "KP list to show success upon receiving success from server..then kill patient table needs to be cleared."
    const okAll = summaries.every(s=>s.ok);
    const title = okAll ? "KP success" : "KP completed with issues";

    showToast(okAll ? "" : "warn", title, summaries.map(s=>s.short).join(" | "));

    kpResultBox.textContent = summaries.map(s=>s.long).join("\n\n");

    // CLEAR pending list ONLY when we got server ok:true for all batches
    if(okAll){
      clearKp(); // clears table (your requirement)
      logLine("KP: pending list cleared after success");
    }

    // Optionally refresh list after KP
    refreshList().catch(()=>{});

  }catch(e){
    const msg = String(e && e.message ? e.message : e);
    kpResultBox.textContent = "KP failed: " + msg;
    showToast("err","KP failed", msg);
    logLine("KP failed", { err: msg });
  }
});

function summarizeKpResp(resp){
  if(!resp){
    return { ok:false, short:"No response", long:"No response object." };
  }

  const ok = resp.ok === true;
  const reqId = resp.reqId || "";
  const warnings = Array.isArray(resp.warnings) ? resp.warnings : [];

  // count updated
  let updated = 0;
  let notFound = 0;

  const results = resp.results || {};
  Object.keys(results).forEach(k=>{
    const r = results[k];
    const mu = r && r.main && Number(r.main.updated || 0);
    if(mu > 0) updated += mu;
    else notFound += 1;
  });

  const short = `${ok ? "ok" : "fail"} | updated:${updated} | notFound:${notFound}` + (reqId ? ` | reqId:${reqId}` : "");
  const long = [
    `ok: ${ok}`,
    `reqId: ${reqId}`,
    `mortality: ${resp.mortality || ""}`,
    `uhids: ${Array.isArray(resp.uhids) ? resp.uhids.join(", ") : ""}`,
    `updated(main cells): ${updated}`,
    `notFound: ${notFound}`,
    warnings.length ? ("warnings:\n- " + warnings.join("\n- ")) : "warnings: none",
    "raw:\n" + safeJson(resp)
  ].join("\n");

  return { ok, short, long };
}

/* ============================================================================
   Dev tab: config wiring
   ========================================================================== */

const cfgUrlEl = document.getElementById("cfgUrl");
const cfgSecretEl = document.getElementById("cfgSecret");

function syncCfgToInputs(){
  const cfg = loadCfg();
  cfgUrlEl.value = cfg.url;
  cfgSecretEl.value = cfg.secret;
}

function syncInputsToCfg(){
  const cfg = {
    url: String(cfgUrlEl.value || "").trim(),
    secret: String(cfgSecretEl.value || "").trim()
  };
  saveCfg(cfg);
  showToast("", "Saved", "Config stored locally.");
  logLine("config saved", { hasUrl: !!cfg.url, hasSecret: !!cfg.secret, url: cfg.url });
}

document.getElementById("btnSaveCfg").addEventListener("click", syncInputsToCfg);

document.getElementById("btnClearCfg").addEventListener("click", ()=>{
  clearCfg();
  syncCfgToInputs();
  showToast("warn","Cleared","Config removed from localStorage.");
  logLine("config cleared");
});

document.getElementById("btnCopyCfg").addEventListener("click", async ()=>{
  const cfg = loadCfg();
  const txt = safeJson(cfg);
  try{
    await navigator.clipboard.writeText(txt);
    showToast("", "Copied", "Config JSON copied to clipboard.");
  }catch(e){
    showToast("warn", "Copy failed", "Clipboard blocked by browser.");
  }
});

/* ============================================================================
   Main: APACHE II scoring (client-side)
   - This is a robust default implementation.
   - If you already compute elsewhere, you can keep this; submit mapping stays the same.
   ========================================================================== */

// Physiologic points helpers (APACHE II standard ranges)
function ptsTempC(t){
  if(!isFinite(t)) return 0;
  if(t >= 41) return 4;
  if(t >= 39) return 3;
  if(t >= 38.5) return 1;
  if(t >= 36) return 0;
  if(t >= 34) return 1;
  if(t >= 32) return 2;
  if(t >= 30) return 3;
  return 4;
}

function ptsMAP(map){
  if(!isFinite(map)) return 0;
  if(map >= 160) return 4;
  if(map >= 130) return 3;
  if(map >= 110) return 2;
  if(map >= 70)  return 0;
  if(map >= 50)  return 2;
  return 4;
}

function ptsHR(hr){
  if(!isFinite(hr)) return 0;
  if(hr >= 180) return 4;
  if(hr >= 140) return 3;
  if(hr >= 110) return 2;
  if(hr >= 70)  return 0;
  if(hr >= 55)  return 2;
  if(hr >= 40)  return 3;
  return 4;
}

function ptsRR(rr){
  if(!isFinite(rr)) return 0;
  if(rr >= 50) return 4;
  if(rr >= 35) return 3;
  if(rr >= 25) return 1;
  if(rr >= 12) return 0;
  if(rr >= 10) return 1;
  if(rr >= 6)  return 2;
  return 4;
}

function ptsOxygenation(fiO2, paO2, aaGrad){
  // APACHE II:
  // If FiO2 >= 0.5 -> use A-a gradient
  // Else -> use PaO2
  const f = Number(fiO2);
  if(!isFinite(f)) return 0;

  if(f >= 0.5){
    const a = Number(aaGrad);
    if(!isFinite(a)) return 0; // if not provided, don't invent
    if(a >= 500) return 4;
    if(a >= 350) return 3;
    if(a >= 200) return 2;
    return 0;
  }else{
    const p = Number(paO2);
    if(!isFinite(p)) return 0;
    if(p < 55) return 4;
    if(p < 61) return 3;
    if(p < 71) return 1;
    return 0;
  }
}

function ptsPH(ph){
  if(!isFinite(ph)) return 0;
  if(ph >= 7.7) return 4;
  if(ph >= 7.6) return 3;
  if(ph >= 7.5) return 1;
  if(ph >= 7.33) return 0;
  if(ph >= 7.25) return 2;
  if(ph >= 7.15) return 3;
  return 4;
}

function ptsNa(na){
  if(!isFinite(na)) return 0;
  if(na >= 180) return 4;
  if(na >= 160) return 3;
  if(na >= 155) return 2;
  if(na >= 150) return 1;
  if(na >= 130) return 0;
  if(na >= 120) return 2;
  if(na >= 111) return 3;
  return 4;
}

function ptsK(k){
  if(!isFinite(k)) return 0;
  if(k >= 7.0) return 4;
  if(k >= 6.0) return 3;
  if(k >= 5.5) return 1;
  if(k >= 3.5) return 0;
  if(k >= 3.0) return 1;
  if(k >= 2.5) return 2;
  return 4;
}

function ptsCr(cr, arf){
  if(!isFinite(cr)) return 0;
  let pts = 0;
  if(cr >= 3.5) pts = 4;
  else if(cr >= 2.0) pts = 3;
  else if(cr >= 1.5) pts = 2;
  else if(cr >= 0.6) pts = 0;
  else pts = 2;
  // If acute renal failure, points doubled in APACHE II
  if(String(arf||"N").toUpperCase() === "Y") pts = pts * 2;
  return pts;
}

function ptsHct(hct){
  if(!isFinite(hct)) return 0;
  if(hct >= 60) return 4;
  if(hct >= 50) return 2;
  if(hct >= 46) return 1;
  if(hct >= 30) return 0;
  if(hct >= 20) return 2;
  return 4;
}

function ptsWbc(w){
  if(!isFinite(w)) return 0;
  if(w >= 40) return 4;
  if(w >= 20) return 2;
  if(w >= 15) return 1;
  if(w >= 3)  return 0;
  if(w >= 1)  return 2;
  return 4;
}

function ptsGcs(gcs){
  if(!isFinite(gcs)) return 0;
  // APACHE II: points = 15 - GCS
  const g = Math.max(3, Math.min(15, Math.floor(gcs)));
  return 15 - g;
}

function ptsAge(age){
  if(!isFinite(age)) return 0;
  if(age >= 75) return 6;
  if(age >= 65) return 5;
  if(age >= 55) return 3;
  if(age >= 45) return 2;
  return 0;
}

// crude mortality band (commonly used quick bands; adjust if you have your own bands)
function mortalityBand(score){
  if(!isFinite(score)) return 0;
  if(score >= 35) return 85.0;
  if(score >= 30) return 75.0;
  if(score >= 25) return 55.0;
  if(score >= 20) return 40.0;
  if(score >= 15) return 25.0;
  if(score >= 10) return 15.0;
  return 5.0;
}

function recalcApache(){
  const age = Number(document.getElementById("age").value);
  const t = Number(document.getElementById("vTemp").value);
  const map = Number(document.getElementById("vMap").value);
  const hr = Number(document.getElementById("vHr").value);
  const rr = Number(document.getElementById("vRr").value);
  const fio2 = Number(document.getElementById("vFiO2").value);
  const pao2 = Number(document.getElementById("vPaO2").value);
  const aa = Number(document.getElementById("vAaGrad").value);
  const ph = Number(document.getElementById("vPh").value);
  const na = Number(document.getElementById("vNa").value);
  const k = Number(document.getElementById("vK").value);
  const cr = Number(document.getElementById("vCr").value);
  const hct = Number(document.getElementById("vHct").value);
  const wbc = Number(document.getElementById("vWbc").value);
  const gcs = Number(document.getElementById("vGcs").value);
  const arf = document.getElementById("vArf").value;
  const chronic = Number(document.getElementById("vChronic").value || 0);

  const phys =
    ptsTempC(t) +
    ptsMAP(map) +
    ptsHR(hr) +
    ptsRR(rr) +
    ptsOxygenation(fio2, pao2, aa) +
    ptsPH(ph) +
    ptsNa(na) +
    ptsK(k) +
    ptsCr(cr, arf) +
    ptsHct(hct) +
    ptsWbc(wbc) +
    ptsGcs(gcs);

  const total = phys + ptsAge(age) + (isFinite(chronic) ? chronic : 0);

  document.getElementById("apacheScore").value = isFinite(total) ? Math.round(total) : "";
  document.getElementById("mortPct").value = isFinite(total) ? mortalityBand(total).toFixed(1) : "";

  return total;
}

document.getElementById("btnRecalc").addEventListener("click", ()=>{
  const s = recalcApache();
  showToast("", "Recalculated", "Apache Score = " + (isFinite(s) ? Math.round(s) : "—"));
});

// auto-recalc on relevant inputs
[
  "age","vTemp","vMap","vHr","vRr","vFiO2","vPaO2","vAaGrad","vPh","vNa","vK","vCr","vHct","vWbc","vGcs","vArf","vChronic"
].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener("input", ()=>{ try{ recalcApache(); }catch(e){} });
});

/* ============================================================================
   Submit mapping — EXACT server sheetRow order
   ========================================================================== */

function buildSubmitPayload(){
  const cfg = requireCfg();

  const uhid = String(document.getElementById("uhid").value||"").trim();
  const name = String(document.getElementById("patientName").value||"").trim();
  const age = document.getElementById("age").value;
  const sex = String(document.getElementById("sex").value||"").trim();
  const dx = String(document.getElementById("diagnosis").value||"").trim();
  const admit = String(document.getElementById("admissionDate").value||"").trim();

  const apache = document.getElementById("apacheScore").value;
  const mortPct = document.getElementById("mortPct").value;
  const mortYN = String(document.getElementById("mortYN").value||"N").trim().toUpperCase();

  const m = monthIST();

  // minimal client validation (server will validate strictly too)
  if(!uhid) throw new Error("UHID is required");
  if(!name) throw new Error("Patient Name is required");
  if(age === "" || age === null) throw new Error("Age is required");
  if(!sex) throw new Error("Sex is required");
  if(!dx) throw new Error("Diagnosis is required");
  if(!admit) throw new Error("Admission Date is required");
  if(apache === "" || apache === null) throw new Error("Apache Score missing");
  if(mortPct === "" || mortPct === null) throw new Error("Mortality percentage missing");
  if(!/^[YN]$/.test(mortYN)) throw new Error('Mortality(Y/N) must be "Y" or "N"');

  return {
    authToken: cfg.secret,      // EXACT: server validates authToken/auth/token/key
    month: m,                  // EXACT: YYYY-MM
    sheetRow: [
      uhid,
      name,
      age,
      sex,
      dx,
      admit,
      apache,
      mortPct,
      mortYN
    ]
  };
}

/* ============================================================================
   Buttons: Submit / Download / Dup-check / Ping
   ========================================================================== */

document.getElementById("btnSubmit").addEventListener("click", async ()=>{
  try{
    recalcApache();
    const payload = buildSubmitPayload();

    showToast("", "Submitting…", "Waiting for server response (bridge).");
    const resp = await apiSubmit(payload);

    if(resp && resp.ok === true){
      const rowNo = resp.rowNumber || "";
      const mode = resp.upsertMode || "";
      const warn = Array.isArray(resp.warnings) && resp.warnings.length ? (" | warnings: " + resp.warnings.length) : "";
      showToast("", "Submitted ✅", `Row ${rowNo} (${mode})${warn}`);

      // optional: refresh list if admin open
      if(adminPanel.getAttribute("aria-hidden")==="false"){
        refreshList().catch(()=>{});
      }

      // show reqId pill
      if(resp.reqId) pillReq.textContent = "Last reqId: " + resp.reqId;

    }else{
      // server already toast'ed error, but keep a visible fallback
      showToast("err","Submit failed", (resp && resp.error) ? resp.error : "Unknown");
    }
  }catch(e){
    const msg = String(e && e.message ? e.message : e);
    showToast("err","Cannot submit", msg);
    logLine("submit: client error", { err: msg });
  }
});

document.getElementById("btnDownload").addEventListener("click", ()=>{
  // In your script, download may not require auth (REQUIRE_AUTH_FOR_DOWNLOAD = false).
  // We'll use redirect mode to force download UX.
  const cfg = loadCfg();
  if(!cfg.url){
    showToast("err","Missing /exec URL","Open ⚙️ → Dev / Logs and set it.");
    return;
  }
  const m = monthIST();
  const url = buildUrl(cfg.url, { action:"download", month:m, mode:"redirect" });
  window.open(url, "_blank", "noopener,noreferrer");
});

document.getElementById("btnCheckDup").addEventListener("click", async ()=>{
  try{
    const uhid = String(document.getElementById("uhid").value||"").trim();
    const name = String(document.getElementById("patientName").value||"").trim();
    if(!uhid || !name){
      showToast("warn","Need UHID + Name","Fill those fields first.");
      return;
    }
    const resp = await apiCheckDuplicate(monthIST(), uhid, name);
    if(resp && resp.ok === true){
      const dup = !!resp.duplicate;
      document.getElementById("pillDup").textContent = "Duplicate: " + (dup ? "YES" : "NO");
      showToast(dup ? "warn" : "", "Duplicate check", resp.status || resp.tag || (dup ? "duplicate" : "no_duplicate"));
      logLine("check result", resp);
    }
  }catch(e){
    logLine("check failed", { err: String(e && e.message ? e.message : e) });
  }
});

document.getElementById("btnPing").addEventListener("click", async ()=>{
  try{
    const resp = await apiPing();
    if(resp && resp.ok === true){
      showToast("", "Ping ok", resp.message || "pong");
      logLine("ping response", resp);
    }
  }catch(e){
    logLine("ping failed", { err: String(e && e.message ? e.message : e) });
  }
});

/* ============================================================================
   Boot: set default month pill + load config into dev inputs
   ========================================================================== */

(function init(){
  const m = monthIST();
  document.getElementById("pillMonth").textContent = "Month: " + m;

  // admin defaults
  document.getElementById("adminMonth").value = m;

  // load cfg into dev tab
  syncCfgToInputs();

  // initial calc
  try{ recalcApache(); }catch(e){}

  logLine("UI ready", { monthIST: m });
})();
</script>
</body>
</html>
