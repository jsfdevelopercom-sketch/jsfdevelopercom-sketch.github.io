<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>APACHE II Bedside Entry</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root{
    color-scheme: light;
    --surface: rgba(255,255,255,0.9);
    --surface-strong: rgba(255,255,255,0.98);
    --outline: rgba(148,163,184,0.4);
    --muted:#475569; --text:#0f172a;
    --accent:#2563eb; --accent-dark:#1d4ed8;
    --bg-gradient:
      radial-gradient(circle at 5% 0%, rgba(59,130,246,.22), transparent 45%),
      radial-gradient(circle at 95% 0%, rgba(14,165,233,.18), transparent 40%),
      linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 55%,#f8fafc 100%);
    --shadow: 0 30px 60px -25px rgba(15,23,42,.35);
    --shadow-soft: 0 20px 50px -30px rgba(15,23,42,.35);
    --radius-lg: 26px; --radius-md:18px; --radius-sm:12px;
    --max-width:1260px;
    font-synthesis:none; text-rendering:optimizeLegibility;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--text);background:var(--bg-gradient);display:flex;flex-direction:column}
  a{color:inherit}

  .masthead{position:relative;padding:clamp(24px,5vw,42px) clamp(18px,7vw,64px) clamp(28px,6vw,52px);display:flex;flex-direction:column;gap:clamp(18px,4vw,36px);overflow:hidden}
  .masthead::before{content:"";position:absolute;inset:12% auto -20% 50%;width:clamp(240px,40vw,520px);height:clamp(240px,45vw,560px);background:radial-gradient(circle, rgba(37,99,235,.45), transparent 70%);transform:translateX(-50%) rotate(18deg);filter:blur(42px);opacity:.6}
  .masthead__inner{position:relative;z-index:1;max-width:var(--max-width);margin:0 auto;display:flex;flex-direction:column;gap:clamp(18px,4vw,36px)}
  .topline{display:flex;align-items:center;justify-content:space-between;gap:18px}
  .brand{display:flex;align-items:center;gap:16px}
  .brand__mark{width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.7));display:grid;place-items:center;color:#fff;font-family:"Plus Jakarta Sans","Inter",sans-serif;font-weight:700;font-size:20px;letter-spacing:.04em;box-shadow:var(--shadow-soft)}
  .brand__copy h1{margin:0;font-family:"Plus Jakarta Sans","Inter",sans-serif;font-size:clamp(30px,5vw,44px);font-weight:700;letter-spacing:-.02em}
  .brand__copy p{margin:6px 0 0;max-width:520px;color:var(--muted);font-size:clamp(15px,2.5vw,18px);line-height:1.6}
  .dev-bubble{width:42px;height:42px;border-radius:50%;border:1px solid rgba(255,255,255,.7);background:rgba(15,23,42,.75);color:#e2e8f0;display:grid;place-items:center;cursor:pointer;box-shadow:0 16px 40px -20px rgba(15,23,42,.65);backdrop-filter:blur(12px);transition:transform .2s ease}
  .dev-bubble:hover{transform:translateY(-2px)}

  .mode-switcher{display:grid;gap:10px;align-items:start}
  .mode-pills{display:grid;grid-template-columns:1fr;gap:12px}
  .mode{position:relative;border-radius:var(--radius-md);border:1px solid transparent;padding:14px 18px;background:rgba(255,255,255,.65);color:var(--muted);font-weight:600;text-align:left;cursor:default}
  .mode.active{background:linear-gradient(135deg,#2563eb,#14a3e9);color:#fff;box-shadow:0 18px 42px -18px rgba(37,99,235,.6)}
  .mode-hint{font-size:14px;color:var(--muted)}

  .patient-mini{display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--muted)}
  .mini-field{display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:rgba(255,255,255,.75);box-shadow:0 12px 28px -22px rgba(15,23,42,.45)}
  .mini-field span{font-size:16px}
  .mini-field input{border:0;background:transparent;font-size:14px;outline:none;min-width:110px}

  .workspace-wrapper{flex:1;padding:0 clamp(18px,7vw,64px) clamp(180px,12vw,220px)}
  .workspace{position:relative;z-index:1;max-width:var(--max-width);margin:0 auto;display:grid;gap:clamp(20px,4vw,36px)}
  .cards-flow{display:grid;gap:clamp(18px,3vw,28px)}
  .panel{background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--outline);padding:clamp(18px,3vw,28px);box-shadow:var(--shadow-soft);backdrop-filter:blur(14px);display:grid;gap:clamp(16px,2.5vw,26px)}
  .panel header{display:grid;gap:6px}
  .panel h2{margin:0;font-size:clamp(18px,2.7vw,22px);font-weight:700;letter-spacing:-.01em}
  .panel .hint{margin:0;color:var(--muted);font-size:13px;line-height:1.5}

  label{font-weight:600;font-size:14px;color:#1e293b;display:block;margin-bottom:6px}
  .input,select,textarea{width:100%;padding:12px 14px;border-radius:var(--radius-sm);border:1px solid rgba(148,163,184,.5);background:rgba(248,250,252,.92);font-size:15px;transition:border .2s ease,box-shadow .2s ease,background .2s ease}
  .input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.15);background:#fff}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

  .grid-2,.grid-3{display:grid;gap:18px}
  .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .grid-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

  .chip-row{display:flex;flex-wrap:wrap;gap:12px}
  .chip{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--radius-md);background:rgba(148,163,184,.14);border:1px solid transparent;font-weight:600;cursor:pointer;color:var(--muted);transition:all .2s ease}
  .chip input[type=radio]{accent-color:var(--accent)}
  .chip:hover{background:rgba(37,99,235,.1)}

  .tab-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:4px}
  .tab{border:1px solid rgba(148,163,184,.4);background:rgba(255,255,255,.7);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
  .tab.active{background:linear-gradient(135deg,#2563eb,#14a3e9);color:#fff;border-color:transparent}
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .action-dock{position:fixed;left:0;right:0;bottom:0;padding:18px clamp(18px,7vw,64px) max(env(safe-area-inset-bottom,24px),28px);background:rgba(255,255,255,.96);border-top:1px solid rgba(148,163,184,.35);box-shadow:0 -18px 42px -24px rgba(15,23,42,.45);backdrop-filter:blur(16px)}
  .action-dock__inner{max-width:var(--max-width);margin:0 auto;display:grid;gap:12px}
  .btn{border-radius:var(--radius-md);border:1px solid transparent;padding:16px;font-weight:600;font-size:16px;cursor:pointer;transition:transform .18s ease,box-shadow .18s ease,background .18s ease}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#1e40af);color:#fff;box-shadow:0 20px 40px -18px rgba(37,99,235,.55)}
  .btn.primary:hover:not([disabled]){transform:translateY(-1px)}
  .btn.secondary{background:rgba(37,99,235,.08);color:var(--accent-dark);border:1px solid rgba(37,99,235,.18)}
  .btn.ghost{background:transparent;border:1px solid rgba(148,163,184,.35);color:var(--muted)}
  .btn[disabled]{opacity:.6;cursor:progress}

  .toast{position:fixed;right:clamp(18px,5vw,64px);bottom:clamp(120px,12vw,180px);min-width:min(360px,calc(100vw - 48px));background:#fff;border-radius:var(--radius-md);border-left:4px solid #16a34a;padding:16px 20px;box-shadow:var(--shadow);font-weight:600;color:var(--text);display:none;z-index:90}
  .toast.err{border-left-color:#dc2626;color:#dc2626}

  /* Dev modal */
  .dev-panel,.dev-backdrop{position:fixed;inset:0;z-index:130}
  .dev-backdrop{background:rgba(15,23,42,.5);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .25s ease}
  .dev-backdrop[data-visible="true"]{opacity:1;pointer-events:auto}
  .dev-panel{display:grid;place-items:center;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .25s ease,visibility .25s ease}
  .dev-panel[aria-hidden="false"]{opacity:1;visibility:visible;pointer-events:auto}
  .dev-sheet{
    width:min(560px,calc(100vw - 48px));
    background:#0f172a;color:#f8fafc;border-radius:var(--radius-lg);
    border:1px solid rgba(148,163,184,.35);box-shadow:0 30px 80px -30px rgba(15,23,42,.8);
    padding:26px;display:grid;gap:18px;pointer-events:auto;
    max-height:min(80vh, 720px);
    overflow-y:auto;
  }
  .dev-sheet h3{margin:0;font-size:20px;font-weight:600}
  .dev-sheet .close{justify-self:end;border:0;background:rgba(148,163,184,.15);color:#e2e8f0;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:600}
  .dev-sheet label{color:#cbd5f5}
  .dev-sheet .input{background:rgba(15,23,42,.75);color:#f8fafc;border:1px solid rgba(148,163,184,.4)}
  .dev-tip{font-size:13px;color:rgba(226,232,240,.7)}

  /* Results card */
  .results-card{
    display:none;
    background:var(--surface-strong);
    border:1px solid rgba(148,163,184,.35);
    border-radius:18px;
    box-shadow:var(--shadow);
    padding:16px 18px;
  }
  .results-card[data-visible="true"]{display:block}
  .results-title{margin:0 0 8px 0;font-weight:700}
  .results-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .metric{padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.12);font-weight:700}
  .metric small{display:block;font-weight:600;color:var(--muted)}

  body.desktop .workspace{grid-template-columns:1fr 360px;align-items:start}
  body.desktop .cards-flow{grid-template-columns:repeat(2,minmax(0,1fr))}
  body.desktop .action-dock__inner{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:899px){body.desktop .workspace{grid-template-columns:1fr}}
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
  }
</style>
</head>
<body>
  <header class="masthead" role="banner">
    <div class="masthead__inner">
      <div class="topline">
        <div class="brand">
          <div class="brand__mark" aria-hidden="true">AI</div>
          <div class="brand__copy">
            <h1>APACHE II bedside console</h1>
            <p>Direct to Google Sheets. One shared sheet per month. All doctors, one source of truth.</p>
          </div>
        </div>
        <button id="devToggle" class="dev-bubble" aria-label="Developer settings" aria-haspopup="dialog" aria-expanded="false">‚öôÔ∏è</button>
      </div>

      <div class="mode-switcher" aria-label="Submission mode">
        <div class="mode-pills" role="group">
          <button id="modeOnline" type="button" class="mode active" disabled>Online (Google Sheets)</button>
        </div>
        <div id="modeHint" class="mode-hint">Data goes straight to the shared Google Sheet (one tab per month). ‚ÄúDownload current month‚Äù gives CSV.</div>
        <div class="patient-mini" aria-label="Quick patient entry">
          <div class="mini-field"><span>üë§</span><input id="patientNameMini" type="text" placeholder="Patient name" autocomplete="off"></div>
          <div class="mini-field"><span>üÜî</span><input id="uhidMini" type="text" placeholder="UHID" autocomplete="off"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="workspace-wrapper">
    <main class="workspace" id="formContent">
      <div class="cards-flow">
        <!-- Patient -->
        <section class="panel" data-span="full" aria-labelledby="patient-h">
          <header>
            <h2 id="patient-h">Patient</h2>
            <p class="hint">Identifiers sync between compact and expanded entry areas automatically.</p>
          </header>
          <div class="grid-2">
            <div>
              <label for="patientName">Patient Name*</label>
              <input id="patientName" class="input" type="text" required placeholder="e.g., Jane Doe" autocomplete="off">
            </div>
            <div>
              <label for="uhid">UHID*</label>
              <input id="uhid" class="input" type="text" required placeholder="Unit health ID" autocomplete="off">
            </div>
          </div>
        </section>

        <!-- Demographics -->
        <section class="panel" aria-labelledby="demo-h">
          <header>
            <h2 id="demo-h">Demographics & Admission</h2>
            <p class="hint">These fields are required to build the monthly sheet row.</p>
          </header>
          <div class="grid-3">
            <div>
              <label for="age">Age (years)*</label>
              <input id="age" class="input" type="number" min="0" max="120" step="1" required placeholder="Years">
            </div>
            <div>
              <label for="sex">Sex*</label>
              <select id="sex" class="input" required>
                <option value="" selected disabled>Select</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="admitDate">Admission Date*</label>
              <input id="admitDate" class="input" type="date" required>
            </div>
          </div>
          <div>
            <label for="diagnosis">Diagnosis*</label>
            <input id="diagnosis" class="input" type="text" required placeholder="Primary diagnosis at ICU admission">
          </div>
          <div class="grid-2">
            <div>
              <label for="gcs">GCS (3‚Äì15)</label>
              <input id="gcs" class="input" type="number" min="3" max="15" step="1" placeholder="e.g., 12">
            </div>
          </div>
        </section>

        <!-- Chronic -->
        <section class="panel" aria-labelledby="chronic-h">
          <header>
            <h2 id="chronic-h">Chronic health</h2>
            <p class="hint">Reveal surgical pathways when significant organ failure is present.</p>
          </header>
          <div class="chip-row" id="chronicGrp">
            <label class="chip"><input type="radio" name="chronic" value="No" checked> No</label>
            <label class="chip"><input type="radio" name="chronic" value="Yes"> Yes ‚Äì severe organ failure / immunocompromise</label>
          </div>
          <div id="surgTypeWrap" class="grid-2" style="display:none">
            <div>
              <label>Type of surgery (if chronic = Yes)</label>
              <div class="chip-row">
                <label class="chip"><input type="radio" name="surgtype" value="Emergency" checked> Emergency</label>
                <label class="chip"><input type="radio" name="surgtype" value="Elective"> Elective</label>
                <label class="chip"><input type="radio" name="surgtype" value="Nonoperative"> Non-operative</label>
              </div>
            </div>
          </div>
        </section>

        <!-- Inputs -->
        <section class="panel" data-span="full" aria-labelledby="inputs-h">
          <header>
            <h2 id="inputs-h">Clinical inputs</h2>
            <p class="hint">Segment vitals, oxygenation and labs with quick swipe tabs.</p>
          </header>
          <div class="tab-bar" role="tablist">
            <button class="tab active" type="button" data-tab="vitals">Vitals</button>
            <button class="tab" type="button" data-tab="oxygen">Oxygenation</button>
            <button class="tab" type="button" data-tab="labs">Labs</button>
          </div>

          <div id="tab-vitals" class="tab-panel active" role="tabpanel">
            <div class="grid-3">
              <div>
                <label for="tempF">Temperature (¬∞F)</label>
                <input id="tempF" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="map">Mean Arterial Pressure (mmHg)</label>
                <input id="map" class="input" type="number" step="1">
              </div>
              <div>
                <label for="hr">Heart Rate (bpm)</label>
                <input id="hr" class="input" type="number" step="1">
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label for="rr">Respiratory Rate (breaths/min)</label>
                <input id="rr" class="input" type="number" step="1">
              </div>
            </div>
          </div>

          <div id="tab-oxygen" class="tab-panel" role="tabpanel">
            <div>
              <label>FiO‚ÇÇ category*</label>
              <div class="chip-row" id="fio2Grp">
                <label class="chip"><input type="radio" name="fio2" value="<50%" checked> &lt; 50% (or non-intubated)</label>
                <label class="chip"><input type="radio" name="fio2" value=">=50%"> ‚â• 50%</label>
              </div>
            </div>

            <div id="po2Wrap">
              <label for="pao2">PaO‚ÇÇ (mmHg)</label>
              <input id="pao2" class="input" type="number" step="1" placeholder="e.g., 80" autocomplete="off">
              <p class="hint">If FiO‚ÇÇ &lt; 50% ‚Üí provide PaO‚ÇÇ.</p>
            </div>

            <div id="aagradWrap" style="display:none">
              <label for="aagrad">A‚Äìa gradient (mmHg)</label>
              <input id="aagrad" class="input" type="number" step="1" placeholder="e.g., 220" autocomplete="off">
              <p class="hint">If FiO‚ÇÇ ‚â• 50% ‚Üí provide A‚Äìa gradient.</p>
            </div>
          </div>

          <div id="tab-labs" class="tab-panel" role="tabpanel">
            <div class="grid-3">
              <div>
                <label for="ph">pH (arterial)</label>
                <input id="ph" class="input" type="number" step="0.01" min="6.8" max="7.8">
              </div>
              <div>
                <label for="hco3">HCO‚ÇÉ‚Åª (mEq/L) <span class="hint">(use if pH unavailable)</span></label>
                <input id="hco3" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="na">Na‚Å∫ (mEq/L)</label>
                <input id="na" class="input" type="number" step="1">
              </div>
            </div>
            <div class="grid-3">
              <div>
                <label for="k">K‚Å∫ (mEq/L)</label>
                <input id="k" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="cr">Creatinine (mg/dL)</label>
                <input id="cr" class="input" type="number" step="0.1">
              </div>
              <div>
                <label for="wbc">WBC (√ó10¬≥/mm¬≥)</label>
                <input id="wbc" class="input" type="number" step="0.1">
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label for="hct">Hematocrit (%)</label>
                <input id="hct" class="input" type="number" step="0.1">
              </div>
              <div>
                <label>Acute Renal Failure</label>
                <div class="chip-row" id="arfGrp">
                  <label class="chip"><input type="radio" name="arf" value="No" checked> No</label>
                  <label class="chip"><input type="radio" name="arf" value="Yes"> Yes</label>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Outcome -->
        <section class="panel" aria-labelledby="outcome-h">
          <header>
            <h2 id="outcome-h">Outcome</h2>
          </header>
          <div>
            <label>Mortality (Y/N)*</label>
            <div class="chip-row" role="group" aria-label="Mortality yes/no" id="mortalityGrp">
              <label class="chip"><input type="radio" name="mortality" value="Y" required> Y</label>
              <label class="chip"><input type="radio" name="mortality" value="N" required> N</label>
            </div>
          </div>
        </section>

        <!-- Results -->
        <aside id="resultsCard" class="results-card" aria-live="polite" aria-atomic="true">
          <h4 class="results-title">Computed Result</h4>
          <div class="results-grid">
            <div class="metric"><small>APACHE II</small><span id="resApache">‚Äî</span></div>
            <div class="metric"><small>Estimated mortality</small><span id="resMort">‚Äî</span></div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <div class="action-dock" role="contentinfo">
    <div class="action-dock__inner">
      <button id="btnDownload" class="btn ghost" type="button">Download current month</button>
      <button id="btnSubmit" class="btn primary" type="button">Submit to Google Sheets</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Dev modal -->
  <div id="devBackdrop" class="dev-backdrop" aria-hidden="true"></div>
  <div id="devPanel" class="dev-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="devTitle">
    <div class="dev-sheet">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
        <h3 id="devTitle">Developer / Connection</h3>
        <button id="devClose" class="close" type="button">Close</button>
      </div>
      <p class="dev-tip">Values persist per device. Leave blank to fall back to defaults.</p>
      <div>
        <label for="onlineUrl">Online Webhook URL</label>
        <input id="onlineUrl" class="input" type="url" placeholder="https://script.google.com/.../exec">
      </div>
      <div>
        <label for="onlineSecret">Online Secret</label>
        <input id="onlineSecret" class="input" type="text" placeholder="Shared secret for Sheets webhook">
      </div>
      <div>
        <label for="clientId">Client ID</label>
        <input id="clientId" class="input" type="text" value="NURSING-STATION-01">
      </div>

      <div style="border-top:1px solid rgba(148,163,184,.35);padding-top:12px">
        <h3 style="margin:0 0 8px 0;font-size:16px">Debug &amp; Tools</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnBuildPreview" class="btn secondary" type="button">Build &amp; show payload</button>
          <button id="btnCopyPreview" class="btn ghost" type="button">Copy JSON</button>
          <button id="btnCopyExcelRow" class="btn ghost" type="button" disabled>Copy APACHE row (Excel)</button>
          <button id="btnDummyFill" class="btn secondary" type="button">Dummy fill</button>
        </div>
        <pre id="debugPreview" style="margin-top:10px;max-height:260px;overflow:auto;border-radius:8px;border:1px solid rgba(148,163,184,.35);padding:12px;background:#081225;color:#e2e8f0;font:13px ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">No payload yet</pre>

        <h3 style="margin:8px 0;font-size:16px">Last server response</h3>
        <pre id="lastResp" style="max-height:180px;overflow:auto;border-radius:8px;border:1px solid rgba(148,163,184,.35);padding:12px;background:#081225;color:#e2e8f0;font:13px ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">None</pre>
      </div>
      <div class="dev-tip">The app is locked to Online (Google Sheets) mode.</div>
    </div>
  </div>

<script>
  // ---------- small helper & UX ----------
  const $ = (id) => document.getElementById(id);
  const q = (sel) => document.querySelector(sel);
  function valNum(id){ const el=$(id); if(!el) return null; const v=el.value.trim(); return v===''?null:Number(v); }
  function valStr(id){ const el=$(id); if(!el) return null; const v=el.value.trim(); return v===''?null:v; }
  function radioVal(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:null; }
  function uuidv4(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,(c)=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15; const v=c==='x'?r:((r&0x3)|0x8); return v.toString(16);}); }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function todayISO(){ const d=new Date(); const off=d.getTimezoneOffset(); const k=new Date(d.getTime()-off*60000); return k.toISOString().slice(0,10); }
  function toast(msg, ok=true){
    const t=$('toast');
    t.textContent=msg; t.className='toast'+(ok?'':' err'); t.style.display='block';
    clearTimeout(toast._timer);
    toast._timer=setTimeout(()=>{ t.style.display='none'; }, 5200);
  }
  function vlog(groupLabel, info){
    try{ console.groupCollapsed(groupLabel); if(typeof info === 'object') console.debug(info); else console.debug(String(info)); console.groupEnd(); }catch(_){}
  }

  function detectDesktop(){
    const ua=navigator.userAgent||"";
    const looksDesktop=/(Macintosh|Windows|Linux)/i.test(ua)&&!/(Mobile|Tablet|Android)/i.test(ua);
    const pointerFine=matchMedia('(pointer: fine)').matches;
    const wideEnough=matchMedia('(min-width:1024px)').matches;
    return looksDesktop||(pointerFine&&wideEnough);
  }
  function applyDesktopClass(){ document.body.classList.toggle('desktop', detectDesktop()); }
  applyDesktopClass(); addEventListener('resize', ()=>{ clearTimeout(applyDesktopClass._timer); applyDesktopClass._timer=setTimeout(applyDesktopClass,180); });

  // mini <-> main sync
  ['patientName','uhid'].forEach((id)=>{ const main=$(id); if(!main) return; main.addEventListener('input',()=>{ const mini=$(id+'Mini'); if(mini && mini.value!==main.value) mini.value=main.value; }); });
  ['patientNameMini','uhidMini'].forEach((id)=>{ const mini=$(id); if(!mini) return; mini.addEventListener('input',()=>{ const main=$(id.replace('Mini','')); if(main && main.value!==mini.value) main.value=mini.value; }); });

  // dev modal
  const devToggle=$('devToggle'), devPanel=$('devPanel'), devBackdrop=$('devBackdrop'), devClose=$('devClose');
  devPanel.setAttribute('aria-hidden','true'); devBackdrop.setAttribute('data-visible','false');
  function setDevPanel(open){
    const wasOpen=devPanel.getAttribute('aria-hidden')==='false';
    devPanel.setAttribute('aria-hidden', open?'false':'true');
    devBackdrop.setAttribute('data-visible', open?'true':'false');
    devBackdrop.setAttribute('aria-hidden', open?'false':'true');
    devToggle.setAttribute('aria-expanded', open?'true':'false');
    if(wasOpen&&!open) saveDevOverrides();
  }
  devToggle.addEventListener('click',()=>{ const isHidden=devPanel.getAttribute('aria-hidden')!=='false'; setDevPanel(isHidden); });
  devClose.addEventListener('click',()=>setDevPanel(false));
  devBackdrop.addEventListener('click',()=>setDevPanel(false));
  addEventListener('keydown',(ev)=>{ if(ev.key==='Escape' && devPanel.getAttribute('aria-hidden')==='false') setDevPanel(false); });

  // Persist Dev values without forcing usage
  function saveDevOverrides(){
    const overrides={
      onlineUrl:$('onlineUrl')?.value.trim()||'',
      onlineSecret:$('onlineSecret')?.value.trim()||'',
      clientId:$('clientId')?.value.trim()||'NURSING-STATION-01'
    };
    localStorage.setItem('apacheMobileDev', JSON.stringify(overrides));
  }
  function loadDevOverrides(){
    try{
      const raw=localStorage.getItem('apacheMobileDev');
      if(!raw) return;
      const o=JSON.parse(raw);
      if($('onlineUrl')) $('onlineUrl').value=o.onlineUrl||'';
      if($('onlineSecret')) $('onlineSecret').value=o.onlineSecret||'';
      if($('clientId')) $('clientId').value=o.clientId||'NURSING-STATION-01';
    }catch(_){}
  }

  // Use hardcoded defaults first; Dev overrides only if present.
  function currentConn(){
    let url = ONLINE_WEBHOOK_URL;
    let secret = ONLINE_SECRET;
    let clientId = 'NURSING-STATION-01';
    try{
      const raw = localStorage.getItem('apacheMobileDev');
      if(raw){
        const o = JSON.parse(raw);
        if(o.clientId && o.clientId.trim()) clientId = o.clientId.trim();
        if(o.onlineUrl && o.onlineUrl.trim()) url = o.onlineUrl.trim();
        if(o.onlineSecret && o.onlineSecret.trim()) secret = o.onlineSecret.trim();
      }
    }catch(_){}
    return { url, secret, clientId };
  }

  // cosmetic: Z Fold 6
  (function(){ const ua=(navigator.userAgent||'').toUpperCase(); const isFold6=ua.includes('SM-F956')||ua.includes('Z FOLD 6')||ua.includes('Z FOLD6'); if(isFold6) document.body.classList.add('fold6'); })();

  // Chronic toggle
  $('chronicGrp').addEventListener('change',()=>{ $('surgTypeWrap').style.display = (radioVal('chronic')==='Yes') ? 'grid' : 'none'; });

  // FiO2 toggle + init
  function updateOxygenUI(){
    const v = radioVal('fio2');
    const po2=$('po2Wrap'), aagrad=$('aagradWrap'), pao2El=$('pao2'), aagradEl=$('aagrad');
    if(v === '<50%'){
      po2.style.display='block'; aagrad.style.display='none';
      if(aagradEl){ aagradEl.value=''; aagradEl.removeAttribute('required'); }
      if(pao2El){ pao2El.setAttribute('required','required'); }
    } else {
      po2.style.display='none'; aagrad.style.display='block';
      if(pao2El){ pao2El.value=''; pao2El.removeAttribute('required'); }
      if(aagradEl){ aagradEl.setAttribute('required','required'); }
    }
  }
  document.querySelectorAll('input[name="fio2"]').forEach(r=>r.addEventListener('change',()=>{ updateOxygenUI(); maybeShowResults(); }));

  // Tabs
  document.querySelectorAll('.tab').forEach((btn)=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach((b)=>b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach((p)=>p.classList.remove('active'));
      btn.classList.add('active');
      const target=$('tab-'+btn.dataset.tab);
      if(target) target.classList.add('active');
    });
  });

  // ====== ONLINE ONLY (defaults first) ======
  let ONLINE_WEBHOOK_URL='https://script.google.com/macros/s/AKfycbywkECpffrqsV5wCfzTYQyX6oZT9iWRhkwlVZrTAHAwCOuGDFpE66AiedZHd77qu_88/exec';
  let ONLINE_SECRET='F8p^7m2bUqW!c4Z9Lh3@r6N0';
  loadDevOverrides();

  // === APACHE II scoring ===
  function fToC(f){ return (f-32)*(5/9); }
  function ptsTempC(c){ if(c==null) return 0; if(c>=41) return 4; if(c>=39 && c<=40.9) return 3; if(c>=38.5 && c<=38.9) return 1; if(c>=36 && c<=38.4) return 0; if(c>=34 && c<=35.9) return 1; if(c>=32 && c<=33.9) return 2; if(c>=30 && c<=31.9) return 3; return 4; }
  function ptsMAP(v){ if(v==null) return 0; if(v>=160) return 4; if(v>=130) return 3; if(v>=110) return 2; if(v>=70) return 0; if(v>=50) return 2; return 4; }
  function ptsHR(v){ if(v==null) return 0; if(v>=180) return 4; if(v>=140) return 3; if(v>=110) return 2; if(v>=70) return 0; if(v>=55) return 2; if(v>=40) return 3; return 4; }
  function ptsRR(v){ if(v==null) return 0; if(v>=50) return 4; if(v>=35) return 3; if(v>=25) return 1; if(v>=12) return 0; if(v>=10) return 1; if(v>=6) return 2; return 4; }
  function ptsOxygen(fio2Cat,pao2,aagrad){
    if(fio2Cat==='>=50%'){
      if(aagrad==null) return 0;
      if(aagrad>=500) return 4; if(aagrad>=350) return 3; if(aagrad>=200) return 2; return 0;
    } else {
      if(pao2==null) return 0;
      if(pao2>70) return 0; if(pao2>=61) return 1; if(pao2>=55) return 3; return 4;
    }
  }
  function ptsPH(ph){ if(ph==null) return null; if(ph>=7.70) return 4; if(ph>=7.60) return 3; if(ph>=7.50) return 1; if(ph>=7.33) return 0; if(ph>=7.25) return 2; if(ph>=7.15) return 3; return 4; }
  function ptsHCO3(h){ if(h==null) return 0; if(h>=52) return 4; if(h>=41) return 3; if(h>=32) return 1; if(h>=22) return 0; if(h>=18) return 2; if(h>=15) return 3; return 4; }
  function ptsNa(v){ if(v==null) return 0; if(v>=180) return 4; if(v>=160) return 3; if(v>=155) return 2; if(v>=150) return 1; if(v>=130) return 0; if(v>=120) return 2; if(v>=111) return 3; return 4; }
  function ptsK(v){ if(v==null) return 0; if(v>=7.0) return 4; if(v>=6.0) return 3; if(v>=5.5) return 1; if(v>=3.5) return 0; if(v>=3.0) return 1; if(v>=2.5) return 2; return 4; }
  function ptsCreatinine(v,arf){ if(v==null) return 0; let pts=0; if(v>=3.5) pts=4; else if(v>=2.0) pts=3; else if(v>=1.5) pts=2; else if(v<0.6) pts=2; else pts=0; if(arf) pts*=2; return pts; }
  function ptsHct(v){ if(v==null) return 0; if(v>=60) return 4; if(v>=50) return 2; if(v>=46) return 1; if(v>=30) return 0; if(v>=20) return 2; return 4; }
  function ptsWBC(v){ if(v==null) return 0; if(v>=40) return 4; if(v>=20) return 2; if(v>=15) return 1; if(v>=3) return 0; if(v>=1) return 2; return 4; }
  function ptsGCS(g){ if(g==null) return 0; const diff=15-g; return diff<0?0:diff; }
  function agePoints(age){ if(age==null) return 0; if(age<=44) return 0; if(age<=54) return 2; if(age<=64) return 3; if(age<=74) return 5; return 6; }
  function chronicPoints(chronic,surgtype){ if(chronic!=='Yes') return 0; if(surgtype==='Elective') return 2; return 5; }

  function computeApacheAndMortality(inputs, meta){
    const tempC = inputs.Temperature_F!=null ? fToC(inputs.Temperature_F) : null;
    const acidBasePts = (function(){ const phPts=ptsPH(inputs.pH); return (phPts!=null)?phPts:ptsHCO3(inputs.HCO3_mEqL); })();
    const aps = ptsTempC(tempC)+ptsMAP(inputs.MAP_mmHg)+ptsHR(inputs.HeartRate_bpm)+ptsRR(inputs.RespRate_bpm)+
                ptsOxygen(inputs.FiO2_Category, inputs.PaO2_mmHg, inputs.AaGradient_mmHg)+acidBasePts+
                ptsNa(inputs.Na_mEqL)+ptsK(inputs.K_mEqL)+ptsCreatinine(inputs.Creatinine_mgdl, inputs.AcuteRenalFailure===true)+
                ptsHct(inputs.Hematocrit_pct)+ptsWBC(inputs.WBC_10e3uL)+ptsGCS(inputs.GCS!=null?inputs.GCS:null);
    const agePts=agePoints(meta.age);
    const chronicPts=chronicPoints(inputs.ChronicHealth, inputs.SurgeryType);
    const apacheII=aps+agePts+chronicPts;
    const logit=-3.517 + 0.146*apacheII;
    const mortProb=1/(1+Math.exp(-logit));
    return { apacheII, mortProb };
  }

  function monthKeyFromISO(iso){ return (iso||new Date().toISOString()).slice(0,7); }

  // Build payload (+ sheet row)
  function buildPayload(){
    const patientName=valStr('patientName');
    const uhid=valStr('uhid');
    const age=valNum('age');
    const sexSel=$('sex'); const sex=sexSel?sexSel.value:'';
    const diagnosis=valStr('diagnosis');
    const admitDate=valStr('admitDate');
    const fio2=radioVal('fio2');
    const mortYN=radioVal('mortality');

    if(!patientName) throw new Error('Patient Name is required');
    if(!uhid) throw new Error('UHID is required');
    if(age===null) throw new Error('Age is required');
    if(!sex) throw new Error('Sex is required');
    if(!diagnosis) throw new Error('Diagnosis is required');
    if(!admitDate) throw new Error('Admission Date is required');
    if(!fio2) throw new Error('FiO‚ÇÇ category is required');
    if(!mortYN) throw new Error('Mortality (Y/N) is required');

    const chronic=radioVal('chronic');
    const surgtype=chronic==='Yes' ? radioVal('surgtype') : null;

    const pao2 = fio2 === '<50%' ? valNum('pao2') : null;
    const aagrad = fio2 !== '<50%' ? valNum('aagrad') : null;
    if(fio2 === '<50%' && pao2===null) throw new Error('PaO‚ÇÇ is required when FiO‚ÇÇ < 50%');
    if(fio2 !== '<50%' && aagrad===null) throw new Error('A‚Äìa gradient is required when FiO‚ÇÇ ‚â• 50%');

    const inputs={
      Age_years: age,
      GCS: valNum('gcs'),
      Temperature_F: valNum('tempF'),
      MAP_mmHg: valNum('map'),
      HeartRate_bpm: valNum('hr'),
      RespRate_bpm: valNum('rr'),
      FiO2_Category: fio2,
      PaO2_mmHg: pao2,
      AaGradient_mmHg: aagrad,
      pH: valNum('ph'),
      HCO3_mEqL: valNum('hco3'),
      Na_mEqL: valNum('na'),
      K_mEqL: valNum('k'),
      Creatinine_mgdl: valNum('cr'),
      AcuteRenalFailure: radioVal('arf')==='Yes',
      Hematocrit_pct: valNum('hct'),
      WBC_10e3uL: valNum('wbc'),
      ChronicHealth: chronic==='Yes' ? 'Yes' : 'No',
      SurgeryType: surgtype
    };

    const nowIso=new Date().toISOString();
    const { apacheII, mortProb } = computeApacheAndMortality(inputs,{ age });
    const mortPct=Math.round(mortProb*1000)/10;

    const row=[ uhid, patientName, age, sex, diagnosis, admitDate, apacheII, mortPct, mortYN ];

    return {
      clientId: 'NURSING-STATION-01',
      authToken: '',
      patientName, uhid, age, sex, diagnosis, admitDate,
      timestamp: nowIso,
      month: monthKeyFromISO(nowIso),
      submissionId: uuidv4(),
      apacheInputs: inputs,
      apacheScore: apacheII,
      predictedMortalityPct: mortPct,
      mortalityYN: mortYN,
      sheetRow: row
    };
  }

  function formIsComplete(){ try{ buildPayload(); return true; }catch(_){ return false; } }
  function maybeShowResults(){
    const card=$('resultsCard');
    const copyBtn=$('btnCopyExcelRow');
    if(!formIsComplete()){
      if(card) card.setAttribute('data-visible','false');
      if(copyBtn) copyBtn.disabled=true;
      return;
    }
    const payload = buildPayload();
    $('resApache').textContent = String(payload.apacheScore) + ' pts';
    $('resMort').textContent = String(payload.predictedMortalityPct.toFixed(1)) + '%';
    if(card) card.setAttribute('data-visible','true');
    if(copyBtn) copyBtn.disabled=false;
  }

  ['input','change'].forEach(evt=>{
    document.addEventListener(evt, (e)=>{
      if(e.target && e.target.closest('.panel')) maybeShowResults();
    });
  });

  // ---------- helpers for dev tools ----------
  function buildExcelRowText(){
    const p = buildPayload();
    return p.sheetRow.join('\t');
  }

  function dummyFill(){
    const age = randInt(45,70);
    $('patientName').value = 'Jane Doe';
    $('patientNameMini').value = 'Jane Doe';
    $('uhid').value = '2010' + String(randInt(1000,9999));
    $('uhidMini').value = $('uhid').value;

    $('age').value = String(age);
    $('sex').value = 'Female';
    $('admitDate').value = todayISO();
    $('diagnosis').value = 'CKD on HTN; Community-acquired pneumonia; on oxygen';

    $('tempF').value = '99.1';
    $('map').value = '78';
    $('hr').value = '96';
    $('rr').value = '22';
    $('gcs').value = '14';

    document.querySelector('input[name="fio2"][value="<50%"]').checked = true;
    updateOxygenUI();
    $('pao2').value = '72';
    $('aagrad').value = '';

    $('ph').value = '7.36';
    $('hco3').value = '22';
    $('na').value = '138';
    $('k').value = '4.8';
    $('cr').value = '2.6';
    $('wbc').value = '13.2';
    $('hct').value = '33';

    document.querySelector('input[name="arf"][value="Yes"]').checked = true;

    document.querySelector('input[name="chronic"][value="Yes"]').checked = true;
    $('surgTypeWrap').style.display = 'grid';
    document.querySelector('input[name="surgtype"][value="Nonoperative"]').checked = true;

    document.querySelector('input[name="mortality"][value="N"]').checked = true;

    maybeShowResults();
    toast('Dummy data filled');
  }

  // ---------- network helpers ----------
  async function sendJson(url, payload, label){
    let res, text;
    try{
      vlog('[fetch] '+label+' ‚Üí POST', { url, payloadPreview: JSON.stringify(payload).slice(0,300) });
      res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        mode: 'cors',
        credentials: 'omit'
      });
    }catch(netErr){
      console.error('[NET] '+label+' network error:', netErr);
      throw new Error(label+' network error: '+(netErr && netErr.message ? netErr.message : String(netErr)));
    }
    try{ text = await res.text(); }catch(_){ text=''; }
    let data=null;
    try{ data = text ? JSON.parse(text) : null; }catch(parseErr){
      console.error('[PARSE] Non-JSON body:', text);
      throw new Error(label+' returned non-JSON: '+(text ? text.slice(0,200) : 'empty body'));
    }
    vlog('[fetch] '+label+' ‚Üê response', { status: res.status, data });
    if(!res.ok){
      const msg=(data && (data.error||data.message)) || ('HTTP '+res.status);
      throw new Error(label+' HTTP error: '+msg);
    }
    return data;
  }

  // Sanitize /dev ‚Üí /exec
  function sanitizeExecUrl(u){
    try{ const x=new URL(u); x.pathname=x.pathname.replace(/\/dev(\/)?$/i,'/exec'); return x.toString(); }
    catch(_){ return u; }
  }

  // Submit using constants first; Dev values only override if present
  async function postOnline(payload){
    const { url, secret, clientId } = currentConn();
    if(!url){ throw new Error('Online Webhook URL not configured.'); }
    payload.clientId  = clientId;
    payload.authToken = secret || '';
    const execUrl = sanitizeExecUrl(url);
    const data = await sendJson(execUrl, payload, 'Google Sheets webhook');
    if(!data || data.ok !== true){
      const detail = data && (data.error || JSON.stringify(data).slice(0,200));
      throw new Error('Sheets webhook did not confirm success' + (detail?': '+detail:''));
    }
    return data;
  }

  // ---------- CSV download: guaranteed new-tab navigation (Android, iOS, Desktop) ----------
  function istMonthYYYYMM(){
    return new Date().toLocaleString('en-CA', { timeZone: 'Asia/Kolkata', year: 'numeric', month: '2-digit' });
  }
  function buildDownloadUrl(urlBase, ym, secret){
    const exec = sanitizeExecUrl(urlBase);
    let u;
    try{ u = new URL(exec); }catch(_){ return exec; }
    u.searchParams.set('action','download');
    u.searchParams.set('month', ym);
    // let server treat this as "force-download" branch
    u.searchParams.set('mode','redirect');
    if (secret && secret.trim()){
      // include token via query (works with navigation; server should validate)
      u.searchParams.set('authToken', secret.trim());
    }
    return u.toString();
  }

  function openCsvInNewTab(targetUrl){
    // 1) Synchronous blank tab to avoid blockers
    let navWin = null;
    try { navWin = window.open('', '_blank', 'noopener'); } catch(_){ navWin = null; }

    if (navWin && !navWin.closed) {
      // iOS/Android/desktop: set location after opening about:blank
      navWin.location.href = targetUrl;
      toast('Opening CSV in a new tab‚Ä¶');
      return;
    }

    // 2) Fallback: synthetic anchor with target=_blank (some WebViews allow this)
    try{
      const a = document.createElement('a');
      a.href = targetUrl;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      // must be in DOM for some iOS versions
      document.body.appendChild(a);
      a.click();
      a.remove();
      toast('Opening CSV‚Ä¶');
      return;
    }catch(_){}

    // 3) Final fallback: same-tab navigation
    try{
      window.location.assign(targetUrl);
      toast('Opening CSV‚Ä¶');
    }catch(e){
      console.error('[download] navigation failed:', e);
      toast('Download navigation blocked by browser.', false);
    }
  }

  $('btnDownload').addEventListener('click', ()=>{
    const { url, secret } = currentConn();
    if(!url){ toast('Online URL missing.', false); return; }
    const ym = istMonthYYYYMM();
    const targetUrl = buildDownloadUrl(url, ym, secret||'');
    openCsvInNewTab(targetUrl);
  });

  // ---------- Submit ----------
  $('btnSubmit').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const button=$('btnSubmit'); button.disabled=true;
    try{
      saveDevOverrides();
      const payload=buildPayload();
      vlog('[submit] Built payload', payload);
      toast('Sending to Google Sheets‚Ä¶');
      const resp = await postOnline(payload);
      if($('lastResp')) $('lastResp').textContent = JSON.stringify(resp, null, 2);
      toast('Saved to Google Sheets ‚úÖ');
      maybeShowResults();
    }catch(e){
      if($('lastResp')) $('lastResp').textContent = (e && e.message) ? e.message : String(e);
      toast('Submit failed: '+(e && e.message ? e.message : String(e)), false);
      console.error('[submit] error:', e);
    }finally{
      button.disabled=false;
    }
  });

  // ---------- Dev tools ----------
  $('btnBuildPreview').addEventListener('click', ()=>{
    try{
      const payload=buildPayload();
      $('debugPreview').textContent = JSON.stringify(payload, null, 2);
      toast('Payload built');
    }catch(e){
      $('debugPreview').textContent = 'Error: '+e.message;
      toast(e.message, false);
      console.error('[preview] error:', e);
    }
  });

  $('btnCopyPreview').addEventListener('click', ()=>{
    try{
      navigator.clipboard.writeText($('debugPreview').textContent||'');
      toast('Copied JSON');
    }catch(_){ toast('Copy failed', false); }
  });

  $('btnCopyExcelRow').addEventListener('click', ()=>{
    try{
      const t = buildExcelRowText();
      navigator.clipboard.writeText(t);
      toast('Row copied (tab-separated). Paste into Excel/Sheets.');
    }catch(e){
      toast('Copy failed: '+(e && e.message ? e.message : String(e)), false);
    }
  });

  $('btnDummyFill').addEventListener('click', ()=>{ try{ dummyFill(); }catch(e){ toast('Dummy fill failed: '+e.message, false); } });

  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    updateOxygenUI();
    maybeShowResults();
    if($('btnCopyExcelRow')) $('btnCopyExcelRow').disabled = !formIsComplete();
  });
</script>
</body>
</html>
